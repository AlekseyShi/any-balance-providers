var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,e){function c(b){var a=sumParam(b,null,null,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);if(a)throw new AnyBalance.Error(a,null,/Неверный пароль/i.test(a));if(a=getElement(b,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(a);}c(a);var d=getParam(a,null,null,/<img[^>]+id="kaptchaImage"[^>]*src="data:image\/\w+;base64,([^"]+)/i,null,html_entity_decode);if(d){AnyBalance.trace("МТС решило показать капчу :( Жаль");
var b=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",d),d=getParam(a,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i),d=createFormParams(d,function(a,e,d,c){"IDToken2"==d&&(c=b);return c});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(e,d,addHeaders({Origin:g_baseurlLogin,Referer:e}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),
a=AnyBalance.requestPost(e,d,addHeaders({Origin:g_baseurlLogin,Referer:e})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&c(a)}return a}
function enterMTS(a){var e=a.baseurl||g_baseurl,c=a.url||g_baseurlLogin+"/amserver/UI/Login?service="+(a.service||"lk")+"&goto="+e+"/",d=a.allowRetry,b=a.html;if(!b||!/<form[^>]+name="Login"/i.test(b))if(b=AnyBalance.requestGet(c,g_headers),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers)),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",
d);if(0==AnyBalance.getLastUrl().indexOf(e))return b;e=getParam(b,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);if(!e){if(!b)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(b))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",d);}e=createFormParams(e,function(b,e,
d,c){"IDToken1"==d?c=a.login:"IDToken2"==d?c=a.password:"noscript"==d?c=void 0:"IDButton"==d&&(c="Submit");return c});AnyBalance.trace("Логинимся с заданным номером");b=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),b=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
d);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&(b=checkLoginError(b,c));if(0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin))throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",d);return b};
