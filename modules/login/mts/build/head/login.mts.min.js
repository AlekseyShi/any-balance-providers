var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,c){function d(a){var b=sumParam(a,null,null,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);if(b)throw new AnyBalance.Error(b,null,/Неверный пароль/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(b);}d(a);var e=getParam(a,null,null,/<img[^>]+id="kaptchaImage"[^>]*src="data:image\/\w+;base64,([^"]+)/i,null,html_entity_decode);if(e){AnyBalance.trace("МТС решило показать капчу :( Жаль");
var b=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",e);a=getParam(a,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);e=createFormParams(a,function(a,c,d,e){"IDToken2"==d&&(e=b);return e});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),
a=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&d(a)}return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var c=createFormParams(a),d=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,d),c,addHeaders({Refefer:a}))}if(c=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,
c),addHeaders({Refefer:a}));return a}
function enterMTS(a){for(var c=a.baseurl||g_baseurl,d=a.url||g_baseurlLogin+"/amserver/UI/Login?service="+(a.service||"lk")+"&goto="+c+"/",e=a.allowRetry,b=a.html,h=AnyBalance.getCookies(),g=0;g<h.length;++g){var f=h[g];if(/^login/i.test(f.name)&&!/^"/.test(f.value)){var k='"'+f.value+'"';AnyBalance.trace("Исправляем куки "+f.name+" на "+k);AnyBalance.setCookie(f.domain,f.name,k,f)}}if(!b||!/<form[^>]+name="Login"/i.test(b))if(b=AnyBalance.requestGet(d,g_headers),500<=AnyBalance.getLastStatusCode()&&
(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(d,g_headers)),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",e);if(0==AnyBalance.getLastUrl().indexOf(c))return b;b=redirectIfNeeded(b);c=getParam(b,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);if(!c){if(!b)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");
if(/<h1[^>]*>\s*Request Error/i.test(b))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",e);}c=createFormParams(c,function(b,c,d,e){"IDToken1"==d?e=a.login:"IDToken2"==d?e=a.password:"noscript"==d?e=void 0:"IDButton"==d&&(e="Submit");return e});AnyBalance.trace("Логинимся с заданным номером");b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d}));
500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),b=AnyBalance.requestPost(d,c,addHeaders({Origin:g_baseurlLogin,Referer:d})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",e);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&(b=checkLoginError(b,d));if(0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin))throw AnyBalance.trace(b),
new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",e);return b};
