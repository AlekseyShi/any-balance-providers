var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,c){function b(a){var b=sumParam(a,null,null,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);if(b)throw new AnyBalance.Error(b,null,/Неверный пароль/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(b);}b(a);var e=getParam(a,null,null,/<img[^>]+id="kaptchaImage"[^>]*src="data:image\/\w+;base64,([^"]+)/i,null,html_entity_decode);if(e){AnyBalance.trace("МТС решило показать капчу :( Жаль");
var d=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",e);a=getParam(a,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);e=createFormParams(a,function(a,b,c,e){"IDToken2"==c&&(e=d);return e});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),
a=AnyBalance.requestPost(c,e,addHeaders({Origin:g_baseurlLogin,Referer:c})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&b(a)}return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){AnyBalance.trace("Потребовался редирект формой...");var c=createFormParams(a),b=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);a=AnyBalance.getLastUrl();a=AnyBalance.requestPost(joinUrl(a,b),c,addHeaders({Refefer:a}))}if(c=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект..."),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,
c),addHeaders({Refefer:a}));return a}function isOnLogin(){return 0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)}
function enterMtsLK(a){var c=a.baseurl||g_baseurl,b=AnyBalance.requestGet(c,g_headers);500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(c,g_headers));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");b=redirectIfNeeded(b);if(c=getParam(b,/Продолжить вход в[^<]+с номером\s*<b[^>]*>([\s\S]*?)<\/b>/i,[replaceTagsAndSpaces,/\D+/g,""])){AnyBalance.trace("Предлагает автоматически залогиниться на "+
c);var b=getElement(b,/<form[^>]+name="Login"/i),e;a.login!=c?(AnyBalance.trace("А нам нужен номер "+a.login+". Отказываемся..."),e="Ignore"):(AnyBalance.trace("А нам этот номер и нужен. Соглашаемся..."),e="Login");b=createFormParams(b,function(a,b,c,f){"IDButton"==c&&(f=e);return f});b=AnyBalance.requestPost(AnyBalance.getLastUrl(),b,addHeaders({Referer:AnyBalance.getLastUrl()}))}isOnLogin()?(a.html=b,a.url||(a.url=AnyBalance.getLastUrl()),b=enterMTS(a)):AnyBalance.trace("Мы не на странице логина. Внутри уже?");
if(isOnLogin())throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось зайти в личный кабинет");return b}
function enterMTS(a){for(var c=a.baseurl||g_baseurl,b=a.url||g_baseurlLogin+"/amserver/UI/Login?goto="+c,e=a.allowRetry,d=a.html,h=AnyBalance.getCookies(),g=0;g<h.length;++g){var f=h[g];if(/^login$/i.test(f.name)&&!/^"/.test(f.value)){var k='"'+f.value+'"';AnyBalance.trace("Исправляем куки "+f.name+" на "+k);AnyBalance.setCookie(f.domain,f.name,k,f)}}if(!d||!/<form[^>]+name="Login"/i.test(d))if(d=AnyBalance.requestGet(b,g_headers),500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),
d=AnyBalance.requestGet(b,g_headers)),500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",e);if(0==AnyBalance.getLastUrl().indexOf(c))return d;d=redirectIfNeeded(d);c=getParam(d,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);if(!c){if(!d)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(d))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");
AnyBalance.trace(d);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",e);}c=createFormParams(c,function(b,c,d,e){"IDToken1"==d?e=a.login:"IDToken2"==d?e=a.password:"noscript"==d?e=void 0:"IDButton"==d&&(e="Submit");return e});AnyBalance.trace("Логинимся с заданным номером");d=AnyBalance.requestPost(b,c,addHeaders({Origin:g_baseurlLogin,Referer:b}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),d=AnyBalance.requestPost(b,
c,addHeaders({Origin:g_baseurlLogin,Referer:b})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",e);isOnLogin()&&(d=checkLoginError(d,b));if(isOnLogin())throw AnyBalance.trace(d),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",e);return d};
