var g_baseurlLogin="https://login.mts.ru";
function checkLoginError(a,b){function d(a){var b=sumParam(a,null,null,/var\s+(?:passwordErr|loginErr)\s*=\s*'([^']*)/g,replaceSlashes,null,aggregate_join);if(b)throw new AnyBalance.Error(b,null,/Неверный пароль/i.test(b));if(b=getElement(a,/<div[^>]+b-page_error__msg[^>]*>/,replaceTagsAndSpaces,html_entity_decode))throw new AnyBalance.Error(b);}d(a);var e=getParam(a,null,null,/<img[^>]+id="kaptchaImage"[^>]*src="data:image\/\w+;base64,([^"]+)/i,null,html_entity_decode);if(e){AnyBalance.trace("МТС решило показать капчу :( Жаль");
var c=AnyBalance.retrieveCode("МТС требует ввести капчу для входа в личный кабинет, чтобы подтвердить, что вы не робот. Введите символы, которые вы видите на картинке.",e);a=getParam(a,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);e=createFormParams(a,function(a,b,d,e){"IDToken2"==d&&(e=c);return e});AnyBalance.trace("Логинимся с заданным номером и капчей");a=AnyBalance.requestPost(b,e,addHeaders({Origin:g_baseurlLogin,Referer:b}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),
a=AnyBalance.requestPost(b,e,addHeaders({Origin:g_baseurlLogin,Referer:b})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",allowRetry);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&d(a)}return a}
function redirectIfNeeded(a){if(/<body[^>]+onload[^>]+submit/i.test(a)){var b=createFormParams(a),d=getParam(a,/<form[^>]+action=['"]([^'"]*)/,replaceHtmlEntities);AnyBalance.trace("Потребовался редирект формой на "+d);a=AnyBalance.getLastUrl();"https"==d&&(d=a.replace(/^https?:\/\/[\w+\.:]+/i,g_baseurlLogin));AnyBalance.trace("Переходим на "+d);a=AnyBalance.requestPost(joinUrl(a,d),b,addHeaders({Refefer:a}))}if(b=getParam(a,/<meta[^>]+http-equiv="REFRESH"[^>]*content="0;url=([^";]*)/i,replaceHtmlEntities))AnyBalance.trace("Потребовался get редирект на "+
b),a=AnyBalance.getLastUrl(),a=AnyBalance.requestGet(joinUrl(a,b),addHeaders({Refefer:a}));return a}
function enterMTS(a){var b=a.baseurl||g_baseurl,d=g_baseurlLogin+"/amserver/UI/Login",e=a.allowRetry,c=a.html,c=AnyBalance.requestGet(d,g_headers);500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),c=AnyBalance.requestGet(d,g_headers));c=redirectIfNeeded(c);if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...",e);if(0==AnyBalance.getLastUrl().indexOf(b))return c;
b=getParam(c,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i);if(!b){if(!c)throw new AnyBalance.Error("Личный кабинет МТС временно недоступен. Попробуйте ещё раз позже");if(/<h1[^>]*>\s*Request Error/i.test(c))throw new AnyBalance.Error("Личный кабинет МТС временно не работает. Попробуйте ещё раз позже");AnyBalance.trace(c);throw new AnyBalance.Error("Не удаётся найти форму входа! Сайт изменен?",e);}b=createFormParams(b,function(b,d,c,e){"IDToken1"==c?e=a.login:"IDToken2"==c?e=a.password:
"noscript"==c?e=void 0:"IDButton"==c&&(e="Submit");return e});AnyBalance.trace("Логинимся с заданным номером");c=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d}));500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500 при попытке логина. Пробуем ещё разок..."),c=AnyBalance.requestPost(d,b,addHeaders({Origin:g_baseurlLogin,Referer:d})));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС при попытке зайти, сервер не смог обработать запрос! Можно попытаться позже...",
e);0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin)&&(c=checkLoginError(c,d));if(0==AnyBalance.getLastUrl().indexOf(g_baseurlLogin))throw AnyBalance.trace(c),new AnyBalance.Error("Не удаётся зайти в личный кабинет. Он изменился или проблемы на сайте.",e);return c};
