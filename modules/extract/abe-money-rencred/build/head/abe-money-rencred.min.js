var g_rootrul="https://ib.rencredit.ru",g_baseurl=g_rootrul+"/rencredit/ru/",g_headers={"Accept-Language":"ru, en","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.60 Safari/537.1",Referer:g_baseurl},g_url={};
function login(){var c=AnyBalance.getPreferences();checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var b=AnyBalance.requestGet(g_baseurl+"group/ibs/product-list",g_headers);/<a[^]+id="logout"/i.test(b)?AnyBalance.trace("Сессия уже начата. Используем существующую сессию"):b=AnyBalance.requestPost(g_baseurl+"home?p_p_id=ClientLogin_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=SEND_FORM&p_p_cacheability=cacheLevelPage&p_p_col_id=column-1&p_p_col_count=1",
{login:c.login,password:c.password},addHeaders({"X-Requested-With":"XMLHttpRequest"}));if(!/<a[^]+id="logout"/i.test(b)&&/<form[^>]+id="_ClientLogin_WAR_bscbankserverportalapp_otpForm"/.test(b)){var a=getParam(b,null,null,/<div[^>]+class="disclaimer"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),c=getParam(b,null,null,/<form[^>]+id="_ClientLogin_WAR_bscbankserverportalapp_otpForm"[^>]*action="([^"]*)/i,replaceHtmlEntities);if(!c)throw AnyBalance.trace(b),new AnyBalanc.Error("Не удаётся найти параметр входа (action)! Сайт изменен?");
b=AnyBalance.retrieveCode(a||"Введите СМС-подтверждение для входа в интернет-банк",null,{inputType:"number",time:3E5});b=AnyBalance.requestPost(c,{otp:b},addHeaders({"X-Requested-With":"XMLHttpRequest"}));(c=getParam(b,null,null,/\.location\s*=\s*"([^"]*)/,replaceSlashes))&&(b=AnyBalance.requestGet(c.replace(/^\//,g_rootrul+"/"),g_headers))}if(!/<a[^]+id="logout"/i.test(b)){if(c=getParam(b,null,null,/msg-error"(?:[^>]*>){1}([^<]+)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/Неверный логин или пароль/i.test(c));
AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();initDetailsUrls(b);return b}
function initDetailsUrls(c){g_url.detailsCard=getParam(c,null,null,/"([^"]*card-detail\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsDep=getParam(c,null,null,/"([^"]*deposit-details\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsAcc=getParam(c,null,null,/"([^"]*current-account-details\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsLoan=getParam(c,null,null,/"([^"]*loan-detail\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities)}
function fetchUrl(c,b){var a=0;do{a&&AnyBalance.sleep(1500);AnyBalance.trace("Попытка получить "+b+" №"+(a+1));var d=AnyBalance.requestGet(c,addHeaders({"X-Requested-With":"XMLHttpRequest"})),e=getJson(d)}while(!e.failed&&!e.suspendPolling&&10>a++);if(e.failed)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось получить "+b+", проблемы на сайте или сайт изменен.");if(!e.suspendPolling)throw AnyBalance.trace(d),new AnyBalance.Error("Не удаётся долго получить "+b+". Возможно, проблемы на сайте, попробуйте ещё раз позднее.");
return e}var g_cardsJson;function fetchCardsJson(){return g_cardsJson?g_cardsJson:g_cardsJson=fetchUrl(g_baseurl+"group/ibs/product-list?p_p_id=MyCards_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=update&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=1&p_p_col_count=4","карты")}
function processCards(c,b){if(AnyBalance.isAvailable("cards")){var a=fetchCardsJson();b.cards=[];for(var d=0;d<a.cards.length;++d){var e=a.cards[d];if("LOY"!=e.typeCode){var f={__id:e.id,__name:e.type+", "+e.number,num:e.number};__shouldProcess("cards",f)&&processCard(e,f);b.cards.push(f)}}}}function processBonus(c,b){if(AnyBalance.isAvailable("bonus"))for(var a=fetchCardsJson(),d=0;d<a.cards.length;++d){var e=a.cards[d];"LOY"==e.typeCode&&getParam(e.availableBalance,b,"bonus")}}
function processCard(c,b){getParam(c.availableBalance,b,"cards.balance");getParam(c.currency,b,"cards.currency cards.balance cards.minpay cards.limit cards.own cards.blocked cards.cash".split(" "));getParam(c.type,b,"cards.type");getParam(c.typeCode,b,"cards.type_code");getParam(c.status,b,"cards.status");getParam(c.statusCode,b,"cards.status_code");getParam(c.closed,b,"cards.closed");if(g_url.detailsCard&&AnyBalance.isAvailable("cards.minpay","cards.minpaytill","cards.limit","cards.userName","cards.own",
"cards.accnum","cards.contract","cards.cash","cards.blocked","cards.type_product")){var a=AnyBalance.requestGet(g_url.detailsCard.replace("{{id}}",c.id),g_headers);getParam(a,b,"cards.minpay",/<div[^>]+class="cell[^>]*>Сумма минимального платежа[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"cards.limit",/<div[^>]+class="cell[^>]*>Общий размер кредитного лимита[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);
getParam(a,b,"cards.own",/<div[^>]+class="cell[^>]*>Собственные средства[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"cards.cash",/<div[^>]+class="cell[^>]*>Доступные средства для снятия наличных[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"cards.blocked",/<div[^>]+class="cell[^>]*>Сумма неподтвержденных операций[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,
parseBalance);getParam(a,b,"cards.minpaytill",/<div[^>]+class="cell[^>]*>Погасить минимальный платеж до[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"cards.userName",/<span[^>]+class="[^>]*fio[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(a,b,"cards.accnum",/<div[^>]+class="cell[^>]*>Номер счета[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(a,b,"cards.contract",/<div[^>]+class="cell[^>]*>Номер договора[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(a,b,"cards.type_product",/<div[^>]+class="cell[^>]*>Тип продукта[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}AnyBalance.isAvailable("cards.transactions")&&processCardsTransactions(c,b)}
function processInfo(c,b){var a=b.info={};getParam(c,a,"info.fio",/<span[^>]+fio[^>]*>([^]*?)<\/span>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.name_last","info.name","info.name_patronymic","info.hphone","info.mphone","info.wphone","info.email")&&(c=AnyBalance.requestGet(g_baseurl+"group/ibs/settings",g_headers),getParam(c,a,"info.name_last",/>\s*Фамилия[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,a,"info.name",/>\s*Имя[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),
getParam(c,a,"info.name_patronymic",/>\s*Отчество[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,a,"info.hphone",/<td[^>]*>\s*Домашний[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,a,"info.mphone",/<td[^>]*>\s*Мобильный[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,a,"info.wphone",/<td[^>]*>\s*Рабочий[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,a,"info.email",/<td[^>]*>\s*Email[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces))}
function fetchAccount(c,b){var a=AnyBalance.getPreferences();if(a.cardnum&&!/^\d{4,20}$/.test(a.cardnum))throw new AnyBalance.Error("Пожалуйста, введите не менее 4 последних цифр номера счета (или договора), по которому вы хотите получить информацию, или не вводите ничего, чтобы получить информацию по первому счету.");var d=fetchUrl(b+"group/ibs/product-list?p_p_id=DepositsList_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=depositsListupdate&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=2&p_p_col_count=4",
"карты"),e=[d.accounts,d.deposits],d=null,f=0;a:for(;f<e.length;++f){var g=e[f];if(g)for(var h=0;h<g.length;++h)if(!a.cardnum||endsWith(g[h].accountNumber,a.cardnum)){d=g[h];break a}}if(!d)throw new AnyBalance.Error(a.cardnum?"Не удалось найти счета/депозита с последними цифрами "+a.cardnum:"Не удалось найти ни одного счета/депозита");a={success:!0};getParam(d.currency,a,["currency","balance"]);getParam(d.accountNumber,a,"accnum");getParam(d.contractNumber,a,"contract");d.currentDepositAmount?(getParam(d.currentDepositAmount,
a,"balance",null,null,parseBalance),getParam(d.interestRate,a,"pct"),getParam(d.name,a,"accname"),getParam(d.expirationDate,a,"till",null,null,parseDate),getParam(d.name,a,"__tariff")):(getParam(d.currentBalance,a,"balance",null,null,parseBalance),getParam(d.accountNumber,a,"__tariff"),getParam(d.status,a,"status"));AnyBalance.setResult(a)};
