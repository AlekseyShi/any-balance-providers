var g_rootrul="https://ib.rencredit.ru",g_baseurl=g_rootrul+"/rencredit/ru/",g_headers={"Accept-Language":"ru, en","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.60 Safari/537.1",Referer:g_baseurl},g_url={};
function login(){var c=AnyBalance.getPreferences();checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var a=AnyBalance.requestGet(g_baseurl+"group/ibs/product-list",g_headers);/<a[^]+id="logout"/i.test(a)?AnyBalance.trace("Сессия уже начата. Используем существующую сессию"):a=AnyBalance.requestPost(g_baseurl+"home?p_p_id=ClientLogin_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=SEND_FORM&p_p_cacheability=cacheLevelPage&p_p_col_id=column-1&p_p_col_count=1",
{login:c.login,password:c.password},addHeaders({"X-Requested-With":"XMLHttpRequest"}));if(!/<a[^]+id="logout"/i.test(a)&&/<form[^>]+id="_ClientLogin_WAR_bscbankserverportalapp_otpForm"/.test(a)){var b=getParam(a,null,null,/<div[^>]+class="disclaimer"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),c=getParam(a,null,null,/<form[^>]+id="_ClientLogin_WAR_bscbankserverportalapp_otpForm"[^>]*action="([^"]*)/i,replaceHtmlEntities);if(!c)throw AnyBalance.trace(a),new AnyBalanc.Error("Не удаётся найти параметр входа (action)! Сайт изменен?");
a=AnyBalance.retrieveCode(b||"Введите СМС-подтверждение для входа в интернет-банк",null,{inputType:"number",time:3E5});a=AnyBalance.requestPost(c,{otp:a},addHeaders({"X-Requested-With":"XMLHttpRequest"}));(c=getParam(a,null,null,/\.location\s*=\s*"([^"]*)/,replaceSlashes))&&(a=AnyBalance.requestGet(c.replace(/^\//,g_rootrul+"/"),g_headers))}if(!/<a[^]+id="logout"/i.test(a)){if(c=getParam(a,null,null,/msg-error"(?:[^>]*>){1}([^<]+)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/Неверный логин или пароль/i.test(c));
AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();initDetailsUrls(a);return a}
function initDetailsUrls(c){g_url.detailsCard=getParam(c,null,null,/"([^"]*card-detail\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsDep=getParam(c,null,null,/"([^"]*deposit-details\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsAcc=getParam(c,null,null,/"([^"]*current-account-details\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.detailsLoan=getParam(c,null,null,/"([^"]*loan-detail\?[^"]*\{\{id\}\}[^"]*)/,replaceHtmlEntities);g_url.scheduleLoan=getParam(c,null,null,/"([^"]*payment-schedule\?[^"]*\{\{id\}\}[^"]*)/,
replaceHtmlEntities)}
function fetchUrl(c,a){var b=0;do{b&&AnyBalance.sleep(1500);AnyBalance.trace("Попытка получить "+a+" №"+(b+1));var d=AnyBalance.requestGet(c,addHeaders({"X-Requested-With":"XMLHttpRequest"})),e=getJson(d)}while(!e.failed&&!e.suspendPolling&&10>b++);if(e.failed)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось получить "+a+", проблемы на сайте или сайт изменен.");if(!e.suspendPolling)throw AnyBalance.trace(d),new AnyBalance.Error("Не удаётся долго получить "+a+". Возможно, проблемы на сайте, попробуйте ещё раз позднее.");return e}
var g_cardsJson;function fetchCardsJson(){return g_cardsJson?g_cardsJson:g_cardsJson=fetchUrl(g_baseurl+"group/ibs/product-list?p_p_id=MyCards_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=update&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=1&p_p_col_count=4","карты")}var g_loansJson;
function fetchLoansJson(){if(g_loansJson)return g_loansJson;g_loansJson=fetchUrl(g_baseurl+"group/ibs/product-list?p_p_id=LoansList_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=COMMAND_UPDATE_LOANS&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=3&p_p_col_count=4","кредиты");g_loansJson.JSON_CLOSED_LOANS_HIDDEN_FLAG&&(g_loansJson=fetchUrl(g_baseurl+"group/ibs/product-list?p_p_id=LoansList_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=COMMAND_HIDE_UNHIDE_CLOSED_LOANS&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=3&p_p_col_count=4",
"все кредиты"));return g_loansJson}function processCards(c,a){if(AnyBalance.isAvailable("cards")){var b=fetchCardsJson();a.cards=[];for(var d=0;d<b.cards.length;++d){var e=b.cards[d];if("LOY"!=e.typeCode){var f={__id:e.id,__name:e.type+", "+e.number,num:e.number};__shouldProcess("cards",f)&&processCard(e,f);a.cards.push(f)}}}}
function processBonus(c,a){if(AnyBalance.isAvailable("bonus"))for(var b=fetchCardsJson(),d=0;d<b.cards.length;++d){var e=b.cards[d];"LOY"==e.typeCode&&getParam(e.availableBalance,a,"bonus")}}
function processCard(c,a){getParam(c.availableBalance,a,"cards.balance");getParam(c.currency,a,"cards.currency cards.balance cards.minpay cards.limit cards.own cards.blocked cards.cash".split(" "));getParam(c.type,a,"cards.type");getParam(c.typeCode,a,"cards.type_code");getParam(c.status,a,"cards.status");getParam(c.statusCode,a,"cards.status_code");getParam(c.closed,a,"cards.closed");if(g_url.detailsCard&&AnyBalance.isAvailable("cards.minpay","cards.minpaytill","cards.limit","cards.userName","cards.own",
"cards.accnum","cards.contract","cards.cash","cards.blocked","cards.type_product")){var b=AnyBalance.requestGet(g_url.detailsCard.replace("{{id}}",c.id),g_headers);getParam(b,a,"cards.minpay",/<div[^>]+class="cell[^>]*>Сумма минимального платежа[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.limit",/<div[^>]+class="cell[^>]*>Общий размер кредитного лимита[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);
getParam(b,a,"cards.own",/<div[^>]+class="cell[^>]*>Собственные средства[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.cash",/<div[^>]+class="cell[^>]*>Доступные средства для снятия наличных[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.blocked",/<div[^>]+class="cell[^>]*>Сумма неподтвержденных операций[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,
parseBalance);getParam(b,a,"cards.minpaytill",/<div[^>]+class="cell[^>]*>Погасить минимальный платеж до[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseDate);getParam(b,a,"cards.userName",/<span[^>]+class="[^>]*fio[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(b,a,"cards.accnum",/<div[^>]+class="cell[^>]*>Номер счета[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"cards.contract",/<div[^>]+class="cell[^>]*>Номер договора[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces);getParam(b,a,"cards.type_product",/<div[^>]+class="cell[^>]*>Тип продукта[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}AnyBalance.isAvailable("cards.transactions")&&processCardsTransactions(c,a)}
function processCredits(c,a){if(AnyBalance.isAvailable("credits")){var b=fetchLoansJson();a.credits=[];for(var d=0;d<b.loans.length;++d){var e=b.loans[d],f={__id:e.id,__name:e.name+", "+e.contractNumber,num:e.contractNumber};__shouldProcess("credits",f)&&processCredit(e,f);a.credits.push(f)}}}
function processCredit(c,a){getParam(c.creditAmount,a,"credits.balance",null,null,parseBalance);getParam(c.currency,a,["credits.currency","credits.balance","credits.minpay","credits.limit"]);getParam(c.name,a,"credits.name");getParam(c.nextInstallmentAmount,a,"credits.minpay",null,null,parseBalance);getParam(c.nextInstallmentDate,a,"credits.minpay_till",null,null,parseDate);getParam(c.openingDate,a,"credits.date_start",null,null,parseDate);getParam(c.status,a,"credits.status");getParam(c.closed_or_not_paid,
a,"credits.close_reason");if(g_url.detailsLoan&&AnyBalance.isAvailable("credits.accnum","credits.date_end","credits.period","credits.pct","credits.limit")){var b=AnyBalance.requestGet(g_url.detailsLoan.replace("{{id}}",c.id),g_headers);getParam(b,a,"credits.accnum",/<div[^>]+class="cell[^>]*>Номер текущего счета[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"credits.date_end",/<div[^>]+class="cell[^>]*>Дата закрытия кредитного договора[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,
replaceTagsAndSpaces,parseDate);getParam(b,a,"credits.limit",/<div[^>]+class="cell[^>]*>Сумма кредита[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.period",/<div[^>]+class="cell[^>]*>Срок кредита[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.pct",/<div[^>]+class="cell[^>]*>Годовая процентная ставка по кредиту[\s\S]*?<div[^>]+class="cell[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,
parseBalance)}AnyBalance.isAvailable("credits.transactions")&&processCreditsTransactions(c,a);AnyBalance.isAvailable("credits.schedule")&&processCreditsSchedule(c,a)}
function processInfo(c,a){var b=a.info={};getParam(c,b,"info.fio",/<span[^>]+fio[^>]*>([^]*?)<\/span>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.name_last","info.name","info.name_patronymic","info.hphone","info.mphone","info.wphone","info.email")&&(c=AnyBalance.requestGet(g_baseurl+"group/ibs/settings",g_headers),getParam(c,b,"info.name_last",/>\s*Фамилия[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"info.name",/>\s*Имя[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),
getParam(c,b,"info.name_patronymic",/>\s*Отчество[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"info.hphone",/<td[^>]*>\s*Домашний[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"info.mphone",/<td[^>]*>\s*Мобильный[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"info.wphone",/<td[^>]*>\s*Рабочий[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces),getParam(c,b,"info.email",/<td[^>]*>\s*Email[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces))}
function fetchAccount(c,a){var b=AnyBalance.getPreferences();if(b.cardnum&&!/^\d{4,20}$/.test(b.cardnum))throw new AnyBalance.Error("Пожалуйста, введите не менее 4 последних цифр номера счета (или договора), по которому вы хотите получить информацию, или не вводите ничего, чтобы получить информацию по первому счету.");var d=fetchUrl(a+"group/ibs/product-list?p_p_id=DepositsList_WAR_bscbankserverportalapp&p_p_lifecycle=2&p_p_state=normal&p_p_mode=view&p_p_resource_id=depositsListupdate&p_p_cacheability=cacheLevelPage&p_p_col_id=column-2-bottom&p_p_col_pos=2&p_p_col_count=4",
"карты"),e=[d.accounts,d.deposits],d=null,f=0;a:for(;f<e.length;++f){var g=e[f];if(g)for(var h=0;h<g.length;++h)if(!b.cardnum||endsWith(g[h].accountNumber,b.cardnum)){d=g[h];break a}}if(!d)throw new AnyBalance.Error(b.cardnum?"Не удалось найти счета/депозита с последними цифрами "+b.cardnum:"Не удалось найти ни одного счета/депозита");b={success:!0};getParam(d.currency,b,["currency","balance"]);getParam(d.accountNumber,b,"accnum");getParam(d.contractNumber,b,"contract");d.currentDepositAmount?(getParam(d.currentDepositAmount,
b,"balance",null,null,parseBalance),getParam(d.interestRate,b,"pct"),getParam(d.name,b,"accname"),getParam(d.expirationDate,b,"till",null,null,parseDate),getParam(d.name,b,"__tariff")):(getParam(d.currentBalance,b,"balance",null,null,parseBalance),getParam(d.accountNumber,b,"__tariff"),getParam(d.status,b,"status"));AnyBalance.setResult(b)};
