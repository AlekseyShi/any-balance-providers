var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36"},baseurl="https://www.touchbank.com",csrf_token;
function login(b){AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var c=AnyBalance.requestGet(baseurl+"/lk/dashboard#/",g_headers);if(!c||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/logout/i.test(c))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{csrf_token=getToken();var c=AnyBalance.requestPost(baseurl+
"/j_spring_security_check",{j_username:b.login,j_password:b.password,captcha_challenge:""},addHeaders({Referer:baseurl+"/lk",Accept:"application/json, text/plain, */*","X-CSRF-TOKEN":csrf_token})),a=getJson(c)}if(!a.success){if(b=a.errors[0]?a.errors[0].message:void 0)throw new AnyBalance.Error(b,null,/Вы ввели неверные логин или пароль/i.test(b));AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}csrf_token=getToken();__setLoginSuccessful();return c}
function processAccounts(b,c){if(AnyBalance.isAvailable("accounts")){b=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var a=getJson(b);if(a.data||a.data.accounts){a=isArray(a.data.accounts)?a.data.accounts:[a.data.accounts];AnyBalance.trace("Найдено счетов: "+a.length);c.accounts=[];for(var d=0;d<a.length;++d){var e=a[d].id,e={__id:e,__name:(a[d].alias||"")+" "+e,num:a[d].number};__shouldProcess("accounts",
e)&&processAccount(a[d],e);c.accounts.push(e)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось найти ни одного счёта."),c.cards=[]}}
function processAccount(b,c){AnyBalance.trace("Обработка счета "+c.__name);getParam(b.info,c,"accounts.type",/([\s\S]*?)\./i);getParam(b.balance+"",c,"accounts.balance",null,null,parseBalanceSilent);getParam(b.currency,c,["accounts.currency","accounts.balance"]);getParam(b.openDate,c,"accounts.date_start",null,null,parseDateWord);getParam(b.statusLocale,c,"accounts.status");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(b,c)}
function processCards(b,c){if(AnyBalance.isAvailable("cards")){b=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var a=getJson(b);if(a.data||a.data.cards){a=isArray(a.data.cards)?a.data.cards:[a.data.cards];AnyBalance.trace("Найдено карт: "+a.length);c.cards=[];for(var d=0;d<a.length;++d){var e={__id:a[d].id,__name:a[d].formattedNumber,num:a[d].cardNumber};__shouldProcess("cards",e)&&processCard(a[d],
e);c.cards.push(e);searchMultiCards(a[d],c)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось найти карты."),c.cards=[]}}
function processCard(b,c){getParam(b.balance+"",c,"cards.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.ownSum+"",c,"cards.own",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.borrowedSum+"",c,"cards.borrowed",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.limit+"",c,"cards.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.currency,c,["cards.currency","cards.balance","cards.own","cards.borrowed","cards.limit"],null,replaceTagsAndSpaces);getParam(b.endDate+
"",c,"cards.till",null,replaceTagsAndSpaces,parseDateISO);getParam(b.openDate+"",c,"cards.date_start",null,replaceTagsAndSpaces,parseDateISO);getParam(b.number,c,"cards.accnum",null,replaceTagsAndSpaces);getParam(b.info,c,"cards.agreement",/дог\.\s*([\s\S]+)/i);isAvailable("cards.transactions")&&processCardTransactions(b,c)}
function searchMultiCards(b,c){AnyBalance.trace("Ищем мультикарты по карте "+b.cardNumber);var a=AnyBalance.requestPost(baseurl+"/proxy?pipe=multicardPipe&action=get_multicard_data",{cardId:b.id},addHeaders({Referer:baseurl+"/lk/cards/multicard","X-CSRF-TOKEN":csrf_token})),d=getJson(a);if(d.data&&d.data.multiCardList&&d.data.multiCardList.extCard.length)for(a=isArray(d.data.multiCardList.extCard)?d.data.multiCardList.extCard:[d.data.multiCardList.extCard],AnyBalance.trace("Найдено мультикарт: "+
a.length),d=0;d<a.length;++d){var e={};getParam(a[d].extCardId,e,"cards.id");getParam(b.cardNumber,e,"cards.primaryCardNumber");getParam(a[d].maskedPAN,e,"cards.num");getParam(a[d].extCardName,e,"cards.name");getParam(a[d].extCardOptionStatus,e,"cards.optionStatus",null,[/NOTSPECIFIED/i,"Специальная карта",/FALLBACK/i,"Резервная карта"]);getParam(a[d].extCardStatus,e,"cards.status");getParam(a[d].extCardMonthExpiry+"."+a[d].extCardYearExpiry,e,"cards.till",null,null,parseDateSilent);c.cards.push(e)}else AnyBalance.trace(a),
AnyBalance.trace("Не удалось найти мультикарты!")}
function processDeposits(b,c){if(AnyBalance.isAvailable("deposits")){b=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/dashboard","X-CSRF-TOKEN":csrf_token}));var a=getJson(b);if(a.data||a.data.deposits){a=isArray(a.data.deposits)?a.data.deposits:[a.data.deposits];AnyBalance.trace("Найдено депозитов: "+a.length);c.deposits=[];for(var d=0;d<a.length;++d){var e=a[d].id,f=a[d].number,g=getParam(a[d].info,null,null,/кл\.([^\d]*\d+)/i,
replaceTagsAndSpaces),e={__id:e,__name:g,num:f};__shouldProcess("deposits",e)&&processDeposit(a[d],e);c.deposits.push(e)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось найти депозиты."),c.deposits=[]}}
function processDeposit(b,c){getParam(b.balance,c,"deposits.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.limit,c,"deposits.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.chargesAmountForMonth,c,"deposits.chargesAmountForMonth",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b.currency,c,["deposits.currency","deposits.balance","deposits.chargesAmountForMonth","deposits.limit"]);getParam(b.interestRate,c,"deposits.pct");getParam(b.depositBeginDate,c,"deposits.date_start",
null,null,parseDateSilent);getParam(b.closeDate,c,"deposits.till",null,null,parseDateSilent);getParam(b.info,c,"deposits.agreement",/дог\.[^\d]*(\d+)/i);getParam(b.info,c,"deposits.period",/Депозит[\s\S]*?\./i);getParam(b.statusLocale,c,"deposits.status");isAvailable("deposits.transactions")&&processDepositTransactions(b,c)}
function processInfo(b,c){b=AnyBalance.requestGet(baseurl+"/proxy?pipe=userDataPipe&action=PERSON_DATA",g_headers);var a=getJson(b),d=c.info={};if(a.data&&a.data.personData){a=a.data.personData;getParam((a.surname+" "||"")+(a.firstName+" "||"")+(a.patronymic||""),d,"info.fio");getParam(a.personId,d,"info.personID");getParam(a.mobilePhone,d,"info.mphone");for(d=0;d<a.addressList.length;d++){var e,f=a.addressList[d];/адрес постоянной регистрации/i.test(f.type)?e="raddress":/Адрес фактического проживания/i.test(f.type)&&
(e="faddress");e?c.info[e]=(f.postIndex+", "||"")+(f.regionName+", "||"")+(f.city+", "||"")+(f.street+", "||"")+(f.house+", "||"")+(f.apartment||""):AnyBalance.trace("Неизвестный тип адреса: "+a.addressList[d].type)}if(a.emailList){e=[];f=isArray(a.emailList)?a.emailList:[a.emailList];for(d=0;d<f.length;d++)e.push(f[d].email);c.info.email=e.join(", ")}else AnyBalance.trace("Не удалось получить список email'ов.");if(a.documentList)for(a=isArray(a.documentList)?a.documentList:[a.documentList],d=0;d<
a.length;d++)1==a[d].docTypeId?(AnyBalance.trace("Нашли паспорт..."),c.info.passport=a[d].serial+a[d].number):AnyBalance.trace("Неизвестный тип документа "+JSON.stringify(a[d]));else AnyBalance.trace("Не удалось получить список документов.")}else AnyBalance.trace(b),AnyBalance.trace("Не удалось получить персональную информацию. Сайт изменён?")}function processCredits(b,c){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processBonuses(b,c){if(AnyBalance.isAvailable("bonuses")){b=AnyBalance.requestGet(baseurl+"/proxy?pipe=loyaltyPipe&action=operations_history");var a=getJson(b);a.data&&a.data.operations?getParam(a.data.operations[0]?a.data.operations[0].bonusAvailable+"":void 0,c,"bonuses",null,null,parseBalance):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти бонусы."))}}
function getToken(){var b=AnyBalance.requestPost(baseurl+"/proxy?pipe=dummyPipe&action=get_csrf_token",null,addHeaders({"X-Requested-With":"XMLHttpRequest",Referer:baseurl})),b=getJson(b),b=b.data?b.data.token:void 0;if(!b)throw new AnyBalance.Error("Не удалось найти токен авторизации. Сайт изменён?");return b};
