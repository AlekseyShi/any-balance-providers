var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.109 Safari/537.36"},baseurl="https://www.touchbank.com";
function login(c){AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var b=AnyBalance.requestGet(baseurl+"/lk/dashboard#/",g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/logout/i.test(b))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{var b=AnyBalance.requestGet(baseurl+
"/proxy?pipe=dummyPipe&action=get_csrf_token",addHeaders({"X-Requested-With":"XMLHttpRequest",Referer:baseurl+"/lk"})),a=getJson(b),b=a.data?a.data.token:void 0;if(!b)throw new AnyBalance.Error("Не удалось найти токен авторизации. Сайт изменён?");b=AnyBalance.requestPost(baseurl+"/j_spring_security_check",{j_username:c.login,j_password:c.password,captcha_challenge:""},addHeaders({Referer:baseurl+"/lk",Accept:"application/json, text/plain, */*","X-CSRF-TOKEN":b,"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",
Origin:baseurl}));a=getJson(b)}if(!a.success){if(c=a.errors[0]?a.errors[0].message:void 0)throw new AnyBalance.Error(c,null,/Вы ввели неверные логин или пароль/i.test(c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return b}
function processAccounts(c,b){if(AnyBalance.isAvailable("accounts")){c=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/cards"}));var a=getJson(c);if(a.data||a.data.accounts){a=isArray(a.data.accounts)?a.data.accounts:[a.data.accounts];AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var d=0;d<a.length;++d){var e=a[d].id,e={__id:e,__name:(a[d].alias||"")+" "+e,num:a[d].number};__shouldProcess("accounts",e)&&processAccount(a[d],
e);b.accounts.push(e)}}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти ни одного счёта."),b.cards=[]}}
function processAccount(c,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(c.info,b,"accounts.type",/([\s\S]*?)\./i);getParam(c.balance+"",b,"accounts.balance",null,null,parseBalanceSilent);getParam(c.currency,b,["accounts.currency","accounts.balance"]);getParam(c.openDate,b,"accounts.date_start",null,null,parseDateWord);getParam(c.statusLocale,b,"accounts.status");AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(c,b)}
function processCards(c,b){if(AnyBalance.isAvailable("cards")){c=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/cards"}));var a=getJson(c);if(a.data||a.data.cards){a=isArray(a.data.cards)?a.data.cards:[a.data.cards];AnyBalance.trace("Найдено карт: "+a.length);b.cards=[];for(var d=0;d<a.length;++d){var e={__id:a[d].id,__name:a[d].formattedNumber,num:a[d].cardNumber};__shouldProcess("cards",e)&&processCard(a[d],e);b.cards.push(e);
searchMultiCards(a[d],b)}}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти карты."),b.cards=[]}}
function processCard(c,b){getParam(c.balance+"",b,"cards.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.ownSum+"",b,"cards.own",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.borrowedSum+"",b,"cards.borrowed",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.limit+"",b,"cards.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.currency,b,["cards.currency","cards.balance","cards.own","cards.borrowed","cards.limit"],null,replaceTagsAndSpaces);getParam(c.endDate+
"",b,"cards.till",null,replaceTagsAndSpaces,parseDateISO);getParam(c.openDate+"",b,"cards.date_start",null,replaceTagsAndSpaces,parseDateISO);getParam(c.number,b,"cards.accnum",null,replaceTagsAndSpaces);getParam(c.info,b,"cards.agreement",/дог\.\s*([\s\S]+)/i);isAvailable("cards.transactions")&&processCardTransactions(c,b)}
function searchMultiCards(c,b){AnyBalance.trace("Ищем мультикарты по карте "+c.cardNumber);var a=AnyBalance.requestPost(baseurl+"/proxy?pipe=multicardPipe&action=get_multicard_data",{cardId:c.id},addHeaders({Referer:baseurl+"/lk/cards/multicard"})),d=getJson(a);if(d.data&&d.data.multiCardList&&d.data.multiCardList.extCard)for(a=isArray(d.data.multiCardList.extCard)?d.data.multiCardList.extCard:[d.data.multiCardList.extCard],AnyBalance.trace("Найдено мультикарт: "+a.length),d=0;d<a.length;++d){var e=
{};getParam(a[d].extCardId,e,"cards.id");getParam(c.cardNumber,e,"cards.primaryCardNumber");getParam(a[d].maskedPAN,e,"cards.num");getParam(a[d].extCardName,e,"cards.name");getParam(a[d].extCardOptionStatus,e,"cards.optionStatus",null,[/NOTSPECIFIED/i,"Специальная карта",/FALLBACK/i,"Резервная карта"]);getParam(a[d].extCardStatus,e,"cards.status");getParam(a[d].extCardMonthExpiry+"."+a[d].extCardYearExpiry,e,"cards.till",null,null,parseDateSilent);b.cards.push(e)}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти мультикарты!")}
function processDeposits(c,b){if(AnyBalance.isAvailable("deposits")){c=AnyBalance.requestPost(baseurl+"/proxy?pipe=userDataPipe&action=PRODUCTS",{syncOff:!0},addHeaders({Referer:baseurl+"/lk/cards"}));var a=getJson(c);if(a.data||a.data.deposits){a=isArray(a.data.deposits)?a.data.deposits:[a.data.deposits];AnyBalance.trace("Найдено депозитов: "+a.length);b.deposits=[];for(var d=0;d<a.length;++d){var e=a[d].id,f=a[d].number,g=getParam(a[d].info,null,null,/кл\.([^\d]*\d+)/i,replaceTagsAndSpaces),e={__id:e,
__name:g,num:f};__shouldProcess("deposits",e)&&processDeposit(a[d],e);b.deposits.push(e)}}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти депозиты."),b.deposits=[]}}
function processDeposit(c,b){getParam(c.balance,b,"deposits.balance",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.limit,b,"deposits.limit",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.chargesAmountForMonth,b,"deposits.chargesAmountForMonth",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(c.currency,b,["deposits.currency","deposits.balance","deposits.chargesAmountForMonth","deposits.limit"]);getParam(c.interestRate,b,"deposits.pct");getParam(c.depositBeginDate,b,"deposits.date_start",
null,null,parseDateSilent);getParam(c.closeDate,b,"deposits.till",null,null,parseDateSilent);getParam(c.info,b,"deposits.agreement",/дог\.[^\d]*(\d+)/i);getParam(c.info,b,"deposits.period",/Депозит[\s\S]*?\./i);getParam(c.statusLocale,b,"deposits.status");isAvailable("deposits.transactions")&&processDepositTransactions(c,b)}
function processInfo(c,b){c=AnyBalance.requestGet(baseurl+"/proxy?pipe=userDataPipe&action=PERSON_DATA",g_headers);var a=getJson(c),d=b.info={};if(a.data&&a.data.personData){a=a.data.personData;getParam((a.surname+" "||"")+(a.firstName+" "||"")+(a.patronymic||""),d,"info.fio");getParam(a.personId,d,"info.personID");getParam(a.mobilePhone,d,"info.mphone");for(d=0;d<a.addressList.length;d++){var e,f=a.addressList[d];/адрес постоянной регистрации/i.test(f.type)?e="raddress":/Адрес фактического проживания/i.test(f.type)&&
(e="faddress");e?b.info[e]=(f.postIndex+", "||"")+(f.regionName+", "||"")+(f.city+", "||"")+(f.street+", "||"")+(f.house+", "||"")+(f.apartment||""):AnyBalance.trace("Неизвестный тип адреса: "+a.addressList[d].type)}if(a.emailList){e=[];f=isArray(a.emailList)?a.emailList:[a.emailList];for(d=0;d<f.length;d++)e.push(f[d].email);b.info.email=e.join(", ")}else AnyBalance.trace("Не удалось получить список email'ов.");if(a.documentList)for(a=isArray(a.documentList)?a.documentList:[a.documentList],d=0;d<
a.length;d++)1==a[d].docTypeId?(AnyBalance.trace("Нашли паспорт..."),b.info.passport=a[d].serial+a[d].number):AnyBalance.trace("Неизвестный тип документа "+JSON.stringify(a[d]));else AnyBalance.trace("Не удалось получить список документов.")}else AnyBalance.trace(c),AnyBalance.trace("Не удалось получить персональную информацию. Сайт изменён?")}function processCredits(c,b){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processBonuses(c,b){if(AnyBalance.isAvailable("bonuses")){c=AnyBalance.requestGet(baseurl+"/proxy?pipe=loyaltyPipe&action=operations_history");var a=getJson(c);a.data&&a.data.operations?getParam(a.data.operations[0]?a.data.operations[0].bonusAvailable+"":void 0,b,"bonuses",null,null,null,parseBalance):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти бонусы."))}};
