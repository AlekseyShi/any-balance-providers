var g_headers={Accept:"application/json, text/javascript, */*; q=0.01","Accept-Language":"ru,en;q=0.8",Connection:"keep-alive",Origin:"http://www.gibdd.ru","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36"};
function getGibddJson(b){try{var a=getJson(b)}catch(d){AnyBalance.trace(b);if(/При загрузке страницы произошла ошибка|Страницу загрузить не удалось/i.test(b))throw new AnyBalance.Error("Сайт временно работает с перебоями, попробуйте обновить данные позже.");throw new AnyBalance.Error("Не удалось получить информацию, свяжитесь, пожалуйста, с разработчиками.");}return a}
function requestFines(b){AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.requestGet("http://www.gibdd.ru/check/fines/",g_headers);if(400<AnyBalance.getLastStatusCode())throw AnyBalance.trace("Server returned: "+AnyBalance.getLastStatusString()),new AnyBalance.Error("Сервис проверки штрафов временно недоступен, скоро все снова будет работать.");checkEmpty(b.login,"Введите гос. номер. Номер должен быть в формате а351со190 либо 1234ав199, буквы русские!");checkEmpty(b.password,"Введите номер свидетельства о регистрации в формате 50ХХ123456!");
a=/(\D{0,1}\d+\D{2})(\d{2,3})/i.exec(b.login);if(!a)throw new AnyBalance.Error("Номер должен быть в формате а123вс190 либо 1234ав199, буквы русские.");var d=AnyBalance.requestGet("http://check.gibdd.ru/proxy/captcha.jpg?",addHeaders({Referer:"http://www.gibdd.ru/check/fines/"})),d=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",d,{inputType:"number"});AnyBalance.trace("Капча получена: "+d);a=[["regnum",a[1].toUpperCase()],["regreg",a[2]],["stsnum",b.password.toUpperCase()],["captchaWord",
d]];AnyBalance.trace("Пробуем запросить информацию с данными: "+b.login+", "+b.password);a=AnyBalance.requestPost("http://check.gibdd.ru/proxy/check/fines",a,addHeaders({"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Referer:"http://check.gibdd.ru/check/fines/",Connection:"keep-alive"}));return getGibddJson(a)}
function parseFines(b,a){var d=a.code||a.status;if(200!=d){var c=a.error||a.message;if(c)throw new AnyBalance.Error(c,null,404==d);AnyBalance.trace(JSON.stringify(a));throw new AnyBalance.Error("Не удалось получить данные по штрафам, сайт изменен?");}if(!a.data)throw AnyBalance.trace(JSON.stringify(a)),new AnyBalance.Error("Вероятно, Вами допущена ошибка при заполнении полей запроса.");AnyBalance.trace("Штрафов: "+a.data.count);if(0<a.data.length){b.fines=[];for(d=0;d<a.data.length;d++){var c=a.data[d],
e={__id:c.id,__name:c.NumPost};__shouldProcess("fines",e)&&(getParam(c.Summa+"",e,"fines.summ",null,null,parseBalance),getParam(c.SummaDiscount+"",e,"fines.summDiscount",null,null,parseBalance),getParam(c.DateDecis+"",e,"fines.date",null,null,parseDateGibdd),getParam(c.DateDiscount+"",e,"fines.dateDiscount",null,null,parseDateGibdd),getParam(c.DatePost+"",e,"fines.datePost",null,null,parseDateGibdd),getParam(c.KoAPcode,e,"fines.koap"),getParam(c.KoAPtext.toUpperCase().substring(0,1)+c.KoAPtext.toLowerCase().substring(1),
e,"fines.descr"),getParam(c.NumPost,e,"fines.postanovlenie"),getParam(a.divisions[c.Division].name,e,"fines.podrazdel"));b.fines.push(e);sumParam(c.Summa+"",b,"balance",null,null,parseBalance,aggregate_sum)}getParam(a.data.length,b,"count")}else b.descr="Неуплаченных штрафов в федеральной информационной системе ГИБДД по указанным данным не найдено.",b.count=0}
function parseDateGibdd(b){var a=/(\d{4})\D(\d{2})\D(\d{2})(?:\D(\d{1,2}):(\d{1,2}):(\d{1,2}))?/.exec(b);if(a){var a=new Date(a[1],a[2]-1,+a[3],a[4]||0,a[5]||0,a[6]||0),d=a.getTime();AnyBalance.trace("Parsing date "+a+" from value: "+b);return d}AnyBalance.trace("Failed to parse date from value: "+b)};
