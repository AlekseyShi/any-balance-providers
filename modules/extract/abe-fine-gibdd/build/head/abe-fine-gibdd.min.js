var g_headers={Accept:"application/json, text/javascript, */*; q=0.01","Accept-Language":"ru,en;q=0.8",Connection:"keep-alive",Origin:"http://www.gibdd.ru","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.57 Safari/537.36"};
function requestFines(b){AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.requestGet("http://www.gibdd.ru/check/fines/",g_headers),c=getParam(a,null,null,/var _token\s*=\s*[^'"]+['"]([a-f\d]+)/i);if(!getParam(a,null,null,/(<form method="POST" id="tsdataform"[\s\S]*?<\/form>)/i)||!c){if(400<AnyBalance.getLastStatusCode())throw AnyBalance.trace("Server returned: "+AnyBalance.getLastStatusString()),new AnyBalance.Error("Сервис проверки штрафов временно недоступен, скоро все снова будет работать.");
if(/временно приостановлена/i.test(a))throw new AnyBalance.Error("Работа сервиса временно приостановлена! Попробуйте обновить данные позже.");AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось найти форму для запроса!");}checkEmpty(b.login,"Введите гос. номер. Номер должен быть в формате а351со190 либо 1234ав199, буквы русские!");checkEmpty(b.password,"Введите номер свидетельства о регистрации в формате 50ХХ123456!");AnyBalance.trace("token = "+c);g_headers=addHeaders({"X-Csrf-Token":c});
a=AnyBalance.requestGet("http://www.gibdd.ru/proxy/check/getSession.php",g_headers);a=getJson(a);AnyBalance.setCookie("www.gibdd.ru","captchaSessionId",a.id);if(7<=AnyBalance.getLevel())AnyBalance.trace("Пытаемся ввести капчу"),a=AnyBalance.requestGet("http://www.gibdd.ru/proxy/check/getCaptcha.php?PHPSESSID="+a.id+"&"+(new Date).getTime(),addHeaders({Referer:"http://www.gibdd.ru/check/fines/"})),a=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",a,{inputType:"number"}),AnyBalance.trace("Капча получена: "+
a);else throw new AnyBalance.Error("Провайдер требует AnyBalance API v7, пожалуйста, обновите AnyBalance!");c=/(\D{0,1}\d+\D{2})(\d{2,3})/i.exec(b.login);if(!c)throw new AnyBalance.Error("Номер должен быть в формате а123вс190 либо 1234ав199, буквы русские.");a=[["req","fines:"+c[1].toUpperCase()+":"+c[2]+":"+b.password.toUpperCase()],["captchaWord",a],["regnum",c[1].toUpperCase()],["regreg",c[2]],["stsnum",b.password.toUpperCase()]];AnyBalance.trace("Пробуем запросить информацию с данными: "+b.login+
", "+b.password);a=AnyBalance.requestPost("http://www.gibdd.ru/proxy/check/fines/2.0/client.php",a,addHeaders({"X-Requested-With":"XMLHttpRequest",Referer:"http://www.gibdd.ru/check/fines/","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"keep-alive"}));try{var d=getJson(a)}catch(e){AnyBalance.trace(a);if(/При загрузке страницы произошла ошибка/i.test(a))throw new AnyBalance.Error("Сайт временно работает с перебоями, попробуйте обновить данные позже.");throw new AnyBalance.Error("Не удалось получить информацию, свяжитесь, пожалуйста, с разработчиками.");
}return d}
function parseFines(b,a){if(200!=a.status){if(a.error)throw new AnyBalance.Error(a.error);if(1==a.status)throw new AnyBalance.Error("Цифры с картинки введены не верно!");throw new AnyBalance.Error("Не удалось получить данные по штрафам, сайт изменен?");}if(!a.request||"0"!=a.request.error)throw new AnyBalance.Error("Указанное Вами свидетельство о регистрации транспортного средства не соответствует государственным регистрационным знакам или более недействительно. Вероятно, Вами допущена ошибка при заполнении полей запроса.");AnyBalance.trace("Штрафов: "+
a.request.count);if(0<a.request.count){b.fines=[];for(var c=0;c<a.request.count;c++){var d=a.request.data[c],e={__id:d.id,__name:d.NumPost};__shouldProcess("fines",e)&&(getParam(d.DateDecis+"",e,"fines.date",null,replaceTagsAndSpaces,parseDateGibdd),getParam(d.KoAPcode,e,"fines.koap",null,replaceTagsAndSpaces,html_entity_decode),getParam(d.KoAPtext.toUpperCase().substring(0,1)+d.KoAPtext.toLowerCase().substring(1),e,"fines.descr",null,null,html_entity_decode),getParam(d.Summa+"",e,"fines.summ",null,
null,parseBalance),getParam(d.NumPost,e,"fines.postanovlenie",null,null,html_entity_decode),getParam(a.request.cacheDiv[d.Division]+"",e,"fines.podrazdel",null,null,html_entity_decode));b.fines.push(e);sumParam(d.Summa+"",b,"balance",null,null,parseBalance,aggregate_sum)}getParam(a.request.count+"",b,"count",null,null,html_entity_decode)}else b.descr="Неуплаченных штрафов в федеральной информационной системе ГИБДД по указанным данным не найдено.",b.count=0}
function parseDateGibdd(b){var a=/(\d{4})\D(\d{2})\D(\d{2})\D(\d{1,2}):(\d{1,2}):(\d{1,2})/.exec(b);if(a){var a=new Date(a[1],a[2]-1,+a[3],a[4]||0,a[5]||0,a[6]||0),c=a.getTime();AnyBalance.trace("Parsing date "+a+" from value: "+b);return c}AnyBalance.trace("Failed to parse date from value: "+b)};
