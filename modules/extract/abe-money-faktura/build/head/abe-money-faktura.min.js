var myReplaceTagsAndSpaces=[replaceTagsAndSpaces,/(\d)\-(\d)/g,"$1.$2"],g_baseurl="https://www.faktura.ru/lite/app";
function login(){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var d=AnyBalance.requestGet(g_baseurl+"/pub/Login"),c=/Wicket.Ajax.ajax\(\{"f":"id([^"]+)","\w":".\/([^"]+)/i.exec(d);if(!c){if(getParam(d,null,null,/<title>(Профилактические работы)<\/title>/i))throw new AnyBalance.Error("В настоящее время в системе Интернет-банк проводятся профилактические работы. Пожалуйста, попробуйте ещё раз позже.");throw new AnyBalance.Error("Не удаётся найти форму входа в интернет-банк! Сайт недоступен или изменения на сайте.");
}var d=c[2],b={};b[c[1]+"_hf_0"]="";b.hasData="X";b.login=a.login;b.password=a.password;d=AnyBalance.requestPost(g_baseurl+"/pub/"+d,b);if(a=getParam(d,null,null,/<span[^>]*class="feedbackPanelERROR"[^>]*>([\s\S]*?)(<script|<\/span>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a,null,/Неверно указан логин/i.test(a));if(getParam(d,null,null,/(sms-message-panel|Введите SMS-код)/i))throw new AnyBalance.Error("Для работы этого провайдера требуется отключить в настройках интернет-банка подтверждение входа по СМС. Это безопасно, для совершения операций все равно будет требоваться подтверждение по СМС.");
AnyBalance.trace("We seem to enter the bank...");return d}
function getCards(a,d){var c=getElements(a,/<div[^>]+class="card"[^>]*>/ig);c.length&&(d.cards=[]);for(var b=0;b<c.length;++b){var k={},g=c[b];getParam(g,k,"accounts.cards.__id",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,html_entity_decode);getParam(g,k,"accounts.cards.num",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,html_entity_decode);getParam(g,k,"accounts.cards.name",/<div[^>]+class="card-info"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces,
html_entity_decode);getParam(g,k,"accounts.cards.balance",/<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(g,k,["accounts.cards.currency","accounts.cards.balance"],/<span[^>]+class="currency"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,html_entity_decode);d.cards.push(k)}}
function processAccounts(a,d){a=AnyBalance.requestGet(g_baseurl+"/priv/accounts");getParam(a,d,"total",/<span[^>]+class="total-block"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("total","currency")&&(d.currency=getElement(a,/<span[^>]+class="total-block"[^>]*>/i,myReplaceTagsAndSpaces,parseCurrency));if(AnyBalance.isAvailable("accounts")){var c=getElements(a,/<div[^>]+class="account-(?:block|history)"[^>]*>/ig);c.length&&(d.accounts=[]);for(var b=0;b<c.length;b+=
2){var k=c[b],g=c[b+1],e=getParam(g,null,null,/<div[^>]+id="acc_([^"_]*)/i,null,html_entity_decode),f=getParam(g,null,null,/<span[^>]+class="editable-name-block"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,html_entity_decode),e={__id:e,__name:f+" ("+e+")"};getCards(g,e);if(__shouldProcess("accounts",e)&&(processAccount(g,e,a),AnyBalance.isAvailable("accounts.minpay","accounts.minpay_till","accounts.transactions","accounts.address")))try{processAccountTransactions(k,e)}catch(h){AnyBalance.trace("Выписка не получена: "+
h.message)}d.accounts.push(e)}}}function num2(a){return 10>a?"0"+a:""+a}function joinUrl(a,d){if(!d)return a;if(d.startsWith("/"))return a.replace(/^(\w+:\/\/[\w.\-]+).*$/,"$1"+d);if(/^\w+:\/\//.test(d))return d;a=a.replace(/\?.*$/,"");/:\/\/.*\//.test(a)&&(a=a.replace(/\/[^\/]*$/,"/"));return a+d}
function processAccountTransactions(a,d){var c=getParam(a,null,null,/div[^>]+class="more-operations[\s\S]*?href="([^"]*)/i,null,html_entity_decode);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на выписку, сайт изменен?");a=AnyBalance.requestGet(g_baseurl+"/priv/"+c);getParam(a,d,"accounts.minpay",/<td[^>]*>Оплатить до[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[replaceTagsAndSpaces,/-/,","],parseBalance);getParam(a,d,"accounts.minpay_till",/<td[^>]*>Оплатить до([^<]+)/i,replaceTagsAndSpaces,
parseDate);if(AnyBalance.isAvailable("accounts.transactions","accounts.address")){var b=getElements(a,[/<form[^>]*>/ig,/Период выписки/i])[0];if(!b)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму выписки, сайт изменен?");var c=getParam(b,null,null,/<form[^>]+action="([^"]*)/i,null,html_entity_decode),k=new Date,b=createFormParams(b,function(a,b,c,d){if(/start/i.test(c))return num2(k.getDate())+"."+num2(k.getMonth()+1)+"."+(k.getFullYear()-3);if(/end/i.test(c))return num2(k.getDate())+
"."+num2(k.getMonth()+1)+"."+k.getFullYear();/id[^_]+_hf_/i.test(c)&&(a["p::submit"]="x",d=void 0);return d});b.periodType="radio53";a=AnyBalance.requestPost(joinUrl(AnyBalance.getLastUrl(),c),b);c=getParam(a,null,null,/<a[^>]+href="([^"]*)"[^>]*class="[^"]*print/i,null,html_entity_decode);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на печать выписки, сайт изменен?");a=AnyBalance.requestGet(joinUrl(AnyBalance.getLastUrl(),c));c=getParam(a,null,null,/<iframe[^>]+src="([^"]*)"[^>]*id="iframeId"/i,
null,html_entity_decode);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку на iframe выписки, сайт изменен?");a=AnyBalance.requestGet(joinUrl(AnyBalance.getLastUrl(),c));var g=getElements(a,[/<table[^>]*>/ig,/Дата операции/i])[0];if(!g)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ссылку таблицу выписки, сайт изменен?");getParam(a,d,"accounts.address",/<td[^>]*>Адрес регистрации[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,html_entity_decode);
d.transactions=[];for(var c=getParam(g,null,null,/<thead[^>]*>([\s\S]*?)<\/thead>/i),c=getElements(c,/<th[^>]*>/ig,replaceTagsAndSpaces,html_entity_decode),b={},e=0;e<c.length;++e)/Документ/i.test(c[e])?b.doc=e:/Дата операции/i.test(c[e])?b.date=e:/Списание|Расходы/i.test(c[e])?b.off=e:/Зачисление|Расходы/i.test(c[e])?b.on=e:/Контрагент/i.test(c[e])?b.contra=e:/Назначение|Детали операции/i.test(c[e])&&(b.descr=e);a=getParam(g,null,null,/<tbody[^>]*>([\s\S]*?)<\/tbody>/i);g=getElements(a,/<tr[^>]*>/ig);
for(e=0;e<g.length;++e){var f=getElements(g[e],/<td[^>]*>/ig);if(!(f.length<c.length)){var h={};b.hasOwnProperty("doc")&&getParam(f[b.doc],h,"accounts.transactions.doc",null,replaceTagsAndSpaces,html_entity_decode);b.hasOwnProperty("date")&&getParam(f[b.date],h,"accounts.transactions.date",null,replaceTagsAndSpaces,parseDate);b.hasOwnProperty("off")&&getParam(f[b.off],h,"accounts.transactions.sum",null,replaceTagsAndSpaces,function(a){a=parseBalance(a);return 0<a?-a:a});b.hasOwnProperty("on")&&getParam(f[b.on],
h,"accounts.transactions.sum",null,replaceTagsAndSpaces,parseBalance);b.hasOwnProperty("contra")&&getParam(f[b.contra],h,"accounts.transactions.contra",null,replaceTagsAndSpaces,html_entity_decode);b.hasOwnProperty("descr")&&getParam(f[b.descr],h,"accounts.transactions.descr",null,replaceTagsAndSpaces,html_entity_decode);d.transactions.push(h)}}}}
function followAjaxUrl(a,d){var c=getParam(d,null,null,new RegExp('Wicket.Ajax.ajax\\(([^)]*"c":"'+a+'"[\\s\\S]*?\\})\\)'),null,getJsonEval),b=getParam(d,null,null,/Wicket.Ajax.baseUrl="([^"]*)/,replaceSlashes),c=AnyBalance.requestGet(g_baseurl+"/priv/"+c.u,{"Wicket-Ajax":"true","Wicket-Ajax-BaseURL":b||"priv/accounts?wicket-crypt=f6I5BkYr3fk","X-Requested-With":"XMLHttpRequest"});(b=getParam(c,null,null,/<redirect>\s*<!\[CDATA\[([\s\S]*?)\]\]>/i))&&(c=AnyBalance.requestGet(g_baseurl+"/priv/"+b));
return c}
function processAccount(a,d,c){var b=getElements(a,[/<div[^>]+class="closed"[^>]*>/ig,/Дополнительно/i])[0];b&&(b=getParam(b,null,null,/<div[^>]+id="([^"]*)/i,null,html_entity_decode),b=followAjaxUrl(b,c),a+=b);getParam(a,d,"accounts.balance",[/Средств на счете[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,/<div[^>]+class="card-amounts"[^>]*>([\s\S]*?)<\/div>/i],myReplaceTagsAndSpaces,parseBalance);getParam(a,d,["accounts.currency","accounts.own","accounts.credit_used","accounts.debt","accounts.limit"],
/<span[^>]+class="currency"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,html_entity_decode);getParam(a,d,"accounts.own",/Остаток собственных средств[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,d,"accounts.credit_used",/Использованный кредит[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,d,"accounts.debt",/Начисленная задолженность[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,
myReplaceTagsAndSpaces,parseBalance);getParam(a,d,"accounts.limit",/Кредитный лимит[\s\S]*?<span[^>]+class="amount"[^>]*>([\s\S]*?)<\/span>/i,myReplaceTagsAndSpaces,parseBalance);getParam(a,d,"accounts.name",/<span[^>]+class="editable-name-block"[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,html_entity_decode);getParam(a,d,"accounts.num",/<td>Номер:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces,html_entity_decode);getParam(a,d,"accounts.currencyISO",/<td>Валюта:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,
replaceTagsAndSpaces,html_entity_decode);getParam(a,d,"accounts.fio",/<td>Владелец:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces,html_entity_decode);getParam(a,d,"accounts.opened",/<td>Открыт:[\s\S]*?<td[^>]*>([\s\S]*?)(?:\(|<\/td>)/i,replaceTagsAndSpaces,parseDate)}function processInfo(a,d){AnyBalance.isAvailable("fio")&&(d.fio=getElement(a,/<span[^>]+class="name"[^>]*>/i,replaceTagsAndSpaces,html_entity_decode))}
function processTemplates(a,d){var c=getElement(a,/<div[^>]+class="templates"[^>]*>/i);c&&(d.templates=[]);for(var c=getElements(c,/<li[^>]*>/ig),b=0;b<c.length;++b){var k=c[b];if(!/<li[^>]+class="create"/i.test(k)){var g=getParam(k,null,null,/<a[^>]+class="template-name[^>]*>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces,html_entity_decode),g={__id:g,__name:g};__shouldProcess("templates",g)&&processTemplate(k,g,a);d.templates.push(g)}}}
function processTemplate(a,d,c){if(AnyBalance.isAvailable("templates"))for(a=getParam(a,null,null,/<a[^>]+class="template-name"[^>]*id="([^"]*)/i,null,html_entity_decode),a=followAjaxUrl(a,c),getParam(a,d,"type",/<h1[^>]*>([\s\S]*?)<\/h1>/i,replaceTagsAndSpaces,html_entity_decode),c=getElements(a,/<fieldset[^>]*>/ig),c.length&&(d.fieldsets=[]),a=0;a<c.length;++a){var b=c[a];if(!/<fieldset[^>]+class="submit"/i.test(b)&&!/<span>Имя платежа<\/span>/i.test(b)){var k={};getParam(b,k,"templates.fieldsets.name",
/<legend[^>]*>([\s\S]*?)<\/legend>/i,replaceTagsAndSpaces,html_entity_decode);b=getElements(b,/<(?:label|div)[^>]*>/ig);if(b.length){k.fields=[];for(var g=0;g<b.length;g+=2){var e=b[g],f=b[g+1];/^<div/i.test(e)&&(g--,f=getElement(e,/<div[^>]+inside-div[^>]*>/i),e=getElement(e,/<label[^>]+inside-div[^>]*>/i));if(!/^<[^>]*display:none/i.test(f)||!/^<[^>]*display:none/i.test(e)){var h={};getParam(e,h,"templates.fieldsets.fields.name",null,replaceTagsAndSpaces,html_entity_decode);getParam(e,h,"templates.fieldsets.fields.required",
/<label[^>]+required/i,null,function(a){return!!a});if(/<input[^>]+type="radio"/i.test(f))for(getParam(f,h,"templates.fieldsets.fields.id",/<input[^>]+type="radio"[^>]*name="([^"]*)/i,null,html_entity_decode),e=sumParam(f,null,null,/<(?:input|label)[\s\S]*?<\/(?:span|div)/ig),f=0;f<e.length;++f){var l={};getParam(e[f],l,"templates.fieldsets.fields.options.value",/<input[^>]+type="radio"[^>]*value="([^"]*)/i,null,html_entity_decode);getParam(e[f],l,"templates.fieldsets.fields.options.name",/<label[^>]*>[\s\S]*?<\/label>/i,
replaceTagsAndSpaces,html_entity_decode);getParam(e[f],l,"templates.fieldsets.fields.extra_id",/<input[^>]+type="text"[^>]*name="([^"]*)/i,null,html_entity_decode);getParam(e[f],l,"templates.fieldsets.fields.extra_value",/<input[^>]+type="text"[^>]*value="([^"]*)/i,null,html_entity_decode);getParam(e[f],l,"templates.fieldsets.fields.extra_comment",/<input[^>]+type="text"[^>]*title="([^"]*)/i,null,html_entity_decode);/checked/i.test(e[f])&&(getParam(e[f],l,"templates.fieldsets.fields.options.value",
/<input[^>]+type="radio"[^>]*value="([^"]*)/i,null,html_entity_decode),getParam(e[f],l,"templates.fieldsets.fields.options.value_name",/<label[^>]*>[\s\S]*?<\/label>/i,replaceTagsAndSpaces,html_entity_decode),getParam(e[f],h,"templates.fieldsets.fields.extra_id",/<input[^>]+type="text"[^>]*name="([^"]*)/i,null,html_entity_decode),getParam(e[f],h,"templates.fieldsets.fields.extra_value",/<input[^>]+type="text"[^>]*value="([^"]*)/i,null,html_entity_decode),getParam(e[f],h,"templates.fieldsets.fields.extra_comment",
/<input[^>]+type="text"[^>]*title="([^"]*)/i,null,html_entity_decode));AnyBalance.isAvailable("templates.fieldsets.fields.options")&&(h.options||(h.options=[]),h.options.push(l))}else if(/<select/i.test(f))for(getParam(f,h,"id",/<select[^>]+name="([^"]*)/i,null,html_entity_decode),e=getElements(f,/<option[^>]*>/ig),f=0;f<e.length;++f)l={},getParam(e[f],l,"templates.fieldsets.fields.options.name",null,replaceTagsAndSpaces,html_entity_decode),getParam(e[f],l,"templates.fieldsets.fields.options.value",
/<option[^>]+value="([^"]*)/i,null,html_entity_decode),/selected/i.test(e[f])&&(getParam(e[f],h,"templates.fieldsets.fields.options.value_name",null,replaceTagsAndSpaces,html_entity_decode),getParam(e[f],h,"templates.fieldsets.fields.options.value",/<option[^>]+value="([^"]*)/i,null,html_entity_decode)),AnyBalance.isAvailable("templates.fieldsets.fields.options")&&(h.options||(h.options=[]),h.options.push(l));else/<input[^>]+type="text"/i.test(f)?(getParam(f,h,"templates.fieldsets.fields.id",/<input[^>]+name="([^"]*)/i,
null,html_entity_decode),getParam(f,h,"templates.fieldsets.fields.value",/<input[^>]+value="([^"]*)/i,null,html_entity_decode),getParam(f,h,"templates.fieldsets.fields.comment",/<input[^>]+title="([^"]*)/i,null,html_entity_decode)):/<textarea/i.test(f)?(getParam(f,h,"templates.fieldsets.fields.id",/<textarea[^>]+name="([^"]*)/i,null,html_entity_decode),getParam(f,h,"templates.fieldsets.fields.value",/<textarea[^>]*>([\s\S]*)<\/textarea>/i,replaceTagsAndSpaces,html_entity_decode),getParam(f,h,"templates.fieldsets.fields.comment",
/<input[^>]+title="([^"]*)/i,null,html_entity_decode)):getParam(f,h,"templates.fieldsets.fields.value",null,replaceTagsAndSpaces,html_entity_decode);k.fields.push(h)}}checkDescriptiveFieldSet(k,d)||d.fieldsets.push(k)}}}}
function checkDescriptiveFieldSet(a,d){var c=a.fields.length;if(c&&2>=c){for(var b={},k=0;k<c;++k){var g=a.fields[k];if(g.id||0>["Услуга","Поставщик"].indexOf(g.name))return!1;b[g.name]=g.value}getParam(b["Услуга"],d,"templates.service");getParam(b["Поставщик"],d,"templates.provider");return!0}return!1};
