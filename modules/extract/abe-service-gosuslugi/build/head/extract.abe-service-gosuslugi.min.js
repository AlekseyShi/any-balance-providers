var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"},g_apiHeaders={Accept:"application/json, text/javascript, */*; q=0.01",Origin:"https://www.gosuslugi.ru","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36",
"Content-Type":"application/json",Referer:"https://www.gosuslugi.ru/pgu/personcab"},g_betaApiHeaders={Accept:"application/json, text/javascript, */*; q=0.01","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36","Accept-Language":"ru,en;q=0.8"},g_baseurl="https://www.gosuslugi.ru/",g_betaBaseurl="https://beta.gosuslugi.ru/",g_replaceSpacesAndBrs=[/^\s+|\s+$/g,"",/<br\/><br\/>$/i,""],g_max_plates_num=10,g_max_inns_num=3;
function login(b){AnyBalance.setDefaultCharset("utf-8");var a=getParam(b.login||"",null,null,/^\d{11}$/,[/^(\d{3})(\d{3})(\d{3})(\d{2})$/i,"$1-$2-$3 $4"]),c="snils";isset(a)&&a||(a=getParam(b.login||"",null,null,/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/),c="email");"snils"==c?checkEmpty(a,'Введите СНИЛС (без пробелов и разделителей, 11 символов подряд). Вы ввели: "'+(b.login||"пустое поле")+'"!'):checkEmpty(a,
'Введите правильный Email. Вы ввели: "'+(b.login||"пустое поле")+'"!');checkEmpty(b.password,"Введите пароль!");var d=AnyBalance.requestGet(g_baseurl+"pgu/personcab",g_headers);if(!isLoggedIn(d)){var d=checkForRedirect(d),e=getParam(d,null,null,/new\s+LoginViewModel\((?:[^,]+,){1,2}'([^"']+)'/i);if(!e)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти идентификатор команды для входа.");d=AnyBalance.requestPost("https://esia.gosuslugi.ru/idp/login/pwd/do",{login:a,password:b.password,
idType:c,command:e},addHeaders({Referer:"https://esia.gosuslugi.ru/idp/rlogin?cc=bp"}));if(!isLoggedIn(d)&&(b=getParam(d,null,null,[/new LoginViewModel\([^,]+,'([^']+)/i,/authn\.error\.([^"']+)/i])))throw d=getJsonObject(d,/var jsonLocalizationMsg/i),d=getParam(d.d.error[b],null,null,null,replaceTagsAndSpaces),new AnyBalance.Error(d,null,/account_is_locked|certificate_user_not_found|invalid_credentials|invalid_signature|no_subject_found/i.test(b));/<h1[^>]*>\s*Выбор роли\s*<\/h1>|Войти как/i.test(d)&&
AnyBalance.requestGet("https://esia.gosuslugi.ru/idp/globalRoleSelection?orgID=P",g_headers);d=checkForRedirect(AnyBalance.requestGet("https://www.gosuslugi.ru/pgu/personcab",g_headers));d=checkForJsOff(d)}if(!isLoggedIn(d)){if(b=getParam(d,null,null,[/span\s*>\s*(Ошибка авторизации(?:[^>]*>){4})/i,/<div class="error[^>]*>([\s\S]*?)<\/div>/i],[replaceTagsAndSpaces,/Вернуться назад/i,""],html_entity_decode))throw new AnyBalance.Error(b,null,/Ошибка авторизации/i.test(b));AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");
}return d}
function processProfile(b){if(AnyBalance.isAvailable("profile","fines","nalog")){b.profile={};getParam(a,b.profile,"profile.fio",/title="Личный кабинет"(?:[^>]*>){3}([^<]+)</i,replaceTagsAndSpaces);isAvailable("profile.mails")&&getParam(getUnreadMsgJson(),b.profile,"profile.mails",/"msgCount"\D*(\d+)/i,replaceTagsAndSpaces,parseBalance);var a=checkForRedirect(AnyBalance.requestGet("https://esia.gosuslugi.ru/profile/user/",g_headers));getParam(a,b.profile,"profile.fio",/ФИО(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);
getParam(a,b.profile,"profile.birth_place",/Место рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.birth_day",/Дата рождения(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces,parseDate);getParam(a,b.profile,"profile.document",/Документ, удостоверяющий личность(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.snils",/Страховой номер индивидуального лицевого счёта(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\/dd>/i,
replaceTagsAndSpaces);getParam(a,b.profile,["profile.inn","nalog"],/id="person:innInf[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.adress_fakt",/id="person:liveAddrInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.adress",/id="person:regAddrInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.email",/Адрес электронной почты(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\//i,replaceTagsAndSpaces);getParam(a,b.profile,"profile.phone",
/Мобильный телефон(?:[\s\S]*?<dd[^>]*>)([\s\S]*?)<\//i,replaceTagsAndSpaces);var c=getParam(a,null,null,/id="person:drLicenseInf"[^>]*>([\s\S]*?)<\//i,replaceTagsAndSpaces);isset(c)&&(getParam(c,b.profile,["profile.license_number","fines"],/[^,]*/,[/\s+/g,""]),getParam(c,b.profile,"profile.license"),getParam(c,b.profile,"profile.license_till",/действительно до([^<]+)/i,null,parseDate));if(a=getElement(a,/<div[^>]+id="person:vehicleInf">/i))for(a=getElements(a,/<dl[^>]+class="line-link">/ig),AnyBalance.trace("Найдено автомобилей: "+
a.length),b.profile.vehicles=[],c=0;c<a.length;++c){var d={};getParam(a[c],d,["profile.vehicles.name","fines"],/<dt>([^<]+)/i,replaceTagsAndSpaces);getParam(a[c],d,["profile.vehicles.plate","fines"],/государственный регистрационный знак\s*([^,]+)/i,[replaceTagsAndSpaces,/\s/g,""]);getParam(a[c],d,["profile.vehicles.plate_id","fines"],/свидетельство о регистрации\s*([^<]+)/i,[replaceTagsAndSpaces,/\s/g,""]);(isset(d.name)||isset(d.plate)||isset(d.plate_id))&&b.profile.vehicles.push(d)}}}
function processFinesBeta(b,a,c){var d=[],e=[],f=[];a.gosnumber&&(d=(a.gosnumber||"").split(/\s*;[\s;]*/g));a.sts_num&&(e=(a.sts_num||"").split(";"));AnyBalance.trace("Автомобилей: "+d.length);AnyBalance.trace("Свидетельств о регистрации: "+e.length);if(d.length!=e.length)throw new AnyBalance.Error("Введите одинаковое количество номеров автомобилей и свидетельств о регистрации!",null,!0);for(var g=0;g<d.length;++g)f.push({plate:d[g],plate_id:e[g]});processFinesBetaVehicles(b,f,a.licensenumber,c)}
function processFinesBetaVehicles(b,a,c,d){if(!(a&&a.length||c))AnyBalance.trace("Нет автомобилей или прав, штрафы не получаем");else if(isAvailable(["fines","fines_total","fines_unpaid"])){AnyBalance.trace("Указан номер автомобиля, значит надо получать штрафы...");b.fines=[];b.fines_unpaid=0;b.fines_total=0;html=AnyBalance.requestGet(g_baseurl+"10001",g_headers);var e=AnyBalance.getLastResponseHeader("X-Atmosphere-tracking-id");checkEmpty(e,"X-Atmosphere-tracking-id header missing",!0);var f=getJsonObject(html,
/gibdd\.requestTemplate/);if(f.form.content)for(c&&(f.form.content["GibddFines.FormStep1.Panel1.vuNumber"]={value:c}),c=0;c<a.length;c++)f.form.content["GibddFines.FormStep1.Panel1.carNumber"+c]={value:a[c].plate},f.form.content["GibddFines.FormStep1.Panel1.stsNumber"+c]={value:a[c].plate_id};a={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:f};e=apiCallBetaCabinet("POST","a/wsapi/?_="+(new Date).getTime(),JSON.stringify(a),{Origin:g_baseurl,"X-Atmosphere-tracking-id":e,
"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10001/result"});if(0!=e.error.code)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось запросить информацию о штрафах, ошибка в запросе!");var e=e.form.content||{total:0},g;for(g in e)if((a=e[g])&&a.billSource){c=a.bID||a.billId;var h=a.fkNumber,f=parseBool(a.isPaid);a.originalAmount||(a.originalAmount=a.violationSum);f||(sumParam(a.violationSum+
"",b,"fines_unpaid",null,null,parseBalance,aggregate_sum),sumParam(a.originalAmount+"",b,"fines_unpaid_full",null,null,parseBalance,aggregate_sum));sumParam(a.violationSum+"",b,"fines_total",null,null,parseBalance,aggregate_sum);sumParam(a.originalAmount+"",b,"fines_total_full",null,null,parseBalance,aggregate_sum);if(d||!f)c={__id:c,__name:h},__shouldProcess("fines",c)&&(getParam(a.violationSum+"",c,"fines.ammount",null,replaceTagsAndSpaces,parseBalance),getParam(a.violationReason,c,"fines.break",
null,replaceTagsAndSpaces),getParam(a.violationDate+" "+a.violationTime,c,"fines.time",null,replaceTagsAndSpaces,parseDate),getParam(a.reportPlace,c,"fines.place",null,replaceTagsAndSpaces),getParam(a.carModel,c,"fines.vehicle",null,replaceTagsAndSpaces),getParam(a.offense,c,"fines.proto_place",null,replaceTagsAndSpaces),getParam(a.carNumber,c,"fines.carNumber",null,replaceTagsAndSpaces),getParam(f,c,"fines.paid")),b.fines.push(c)}}}function parseBool(b){return!/0/.test(b)}
function isLoggedIn(b){return/\/logout|title="Выход"/i.test(b)}function postAPICall(b,a,c){b=AnyBalance.requestPost(b,JSON.stringify(a),isset(c)?addHeaders({Referer:c}):g_apiHeaders);if(!b)throw AnyBalance.trace(html),new AnyBalance.Error("Не удалось получить информацию об услуге, сайт изменен?");return b}
function getUnreadMsgJson(){var b=AnyBalance.requestPost("https://www.gosuslugi.ru/pgu/wsapi/gepsIntegration/getUnreadMessageCount",JSON.stringify({}),g_apiHeaders);b&&/"operation completed"/i.test(b)||(AnyBalance.trace(b),AnyBalance.trace("Не удалось получить информацию о госпочте, сайт изменен?"));return b}
function checkForJsOff(b){if(/Since your browser does not support JavaScript,\s+you must press the Continue button once to proceed/i.test(b)){AnyBalance.trace("Since your browser does not support JavaScript, you must press the Continue button once to proceed...");var a=createFormParams(b),c=getParam(b,null,null,/<form[^>]+action="([^"]+)/i,replaceTagsAndSpaces);if(!c)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось найти форму переадресации, сайт изменен?");b=checkForRedirect(AnyBalance.requestPost(c,
a,addHeaders({Referer:g_baseurl+"idp/profile/SAML2/Redirect/SSO"})))}return b}function checkForRedirect(b){var a=getParam(b,null,null,/<meta[^>]+"refresh"[^>]+url=([^"]+)/);if(a)return AnyBalance.trace("checkForRedirect: Нашли ссылку "+a),checkForJsOff(AnyBalance.requestGet(a,addHeaders({Referer:g_baseurl+"pgu/personcab"})));AnyBalance.trace("Данная страница не требует переадресации.");return b}
function createFormParamsById(b,a){var c=getParam(b,null,null,new RegExp('<form[^>]*id="s'+a+'"[\\s\\S]*?</form>'));if(!c){if(c=getParam(b,null,null,/"popupText"([^>]*>){2}/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c);AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось найти форму с данными для id: "+a+", такое бывает, если услуга недоступна. Если эта ошибка появляется часто - свяжитесь, пожалуйста, с разработчиками.");}return createFormParams(c)}
function getXmlFileResult(b){var a=getParam(b,null,null,/\{\s*url:[^"]*"\/([^"]*)/i,[/\s/ig,"%20"]);if(!a)throw AnyBalance.trace(b),new AnyBalance.Error("Не удалось найти ссылку для загрузки файла результата, сайт изменен?");return AnyBalance.requestGet(g_baseurl+a,{Accept:"text/html, * /*","X-Requested-With":"XMLHttpRequest","User-Agent":"Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/32.0.1700.76 Safari/537.36"})}
function processNalogiBeta(b,a,c){if(!c)AnyBalance.trace("Не указан ИНН, налоги не получаем...");else if(isAvailable(["nalog"])){b.nalog={};a=AnyBalance.requestGet(g_baseurl+"10002/form",g_headers);var d=getJsonObject(a,/rootScope.fns.requestTemplate\s*=/);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму ввода инн. Сайт изменен?");d=d.form.mnemonic;a=AnyBalance.getLastResponseHeader("X-Atmosphere-tracking-id");checkEmpty(a,"X-Atmosphere-tracking-id header missing",!0);
c={type:"javaServiceTask",serviceName:"formProcessing",methodName:"process",parameter:'{"submitComponent":"Fns.FormStep1.Panel1.button","submitEventNumber":"0","submitEvent":"submit","userSelectedRegion":"00000000000","form":{"mnemonic":"'+d+'","content":{"Fns.FormStep1.Panel1.userInn":{"value":"'+c+'"},"Fns.FormStep1.Panel1.emailSend":{"value":false},"Fns.FormStep1.Panel1.phoneSend":{"value":false},"Fns.FormStep1.Panel1.formatedResponse":{"value":false},"Fns.FormStep1.Panel1.requested":{"value":false},"Fns.FormStep1.Panel1.useFailoverCache":{"value":false}}},"context":{"context":{"groovy":{"Script":"groovy.fnsFetchBill"}}}}'};
c=apiCallBetaCabinet("POST","a/wsapi/?_="+(new Date).getTime(),JSON.stringify(c),{Origin:g_baseurl,"X-Atmosphere-tracking-id":a,"X-Atmosphere-Framework":"1.0","Content-Type":"application/json","X-Cache-Date":"0","X-Atmosphere-Transport":"long-polling",Referer:g_baseurl+"10002/result"});sumParam(c.form.content.total.total+"",b.nalog,"nalog.debt",null,replaceTagsAndSpaces,parseBalance,aggregate_sum);a="";for(var e in c.form.content)c.form.content[e].vidnalog&&(a+=c.form.content[e].vidnalog+": <b>"+
c.form.content[e].summa+"</b><br/><br/>");""!=a&&sumParam(a,b.nalog,"nalog.info",null,replaceTagsAndSpaces,null,aggregate_join)}}
function apiCallBetaCabinet(b,a,c,d){if("GET"==b)b=AnyBalance.requestGet(g_baseurl+a,isset(d)?addHeaders(g_betaApiHeaders,d):g_betaApiHeaders);else if("POST"==b)b=AnyBalance.requestPost(g_baseurl+a,c,isset(d)?addHeaders(g_betaApiHeaders,d):g_betaApiHeaders);else throw new AnyBalance.Error("Unexpected type of method: "+b);b=getJson(b);a=isset(b.error.code)?b.error.code:b.error.errorCode;c=b.error.message||b.error.errorMessage;if(0!==a){if(c)throw new AnyBalance.Error(c);throw new AnyBalance.Error("Произошла неизвестная ошибка при выполнении запроса.");
}return b};
