var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36"},baseurl="https://online.russipoteka.ru/web_banking/";
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"protected/welcome.jsf",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/logout/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{var c=
getElement(a,/<form[^>]+loginForm/i);if(!c)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа. Сайт изменен?");var d=getParam(c,null,null,/<form[^>]+id="(\w+):/i,replaceHtmlEntities);getParam(c,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);a=createUrlEncodedParams({"*PREFIX*:login":b.login,"*PREFIX*:password":b.password,"*PREFIX*:captchaText":"","*PREFIX*:loginForm_SUBMIT":1,"javax.faces.ViewState":getParam(a,null,null,/<input[^>]+name="javax.faces.ViewState"[^>]+value="([^"]*)/i),
"javax.faces.behavior.event":"action","javax.faces.partial.event":"click","javax.faces.source":"*PREFIX*:loginBtn","javax.faces.partial.ajax":!0,"javax.faces.partial.execute":"*PREFIX*:login *PREFIX*:captchaText","*PREFIX*:loginForm":"*PREFIX*:loginForm"}).replace(/\*PREFIX\*/g,d);a=AnyBalance.requestPost(baseurl+"login.jsf",a,addHeaders({Referer:baseurl+"protected/welcome.jsf","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}));getJson(getParam(a,null,null,/(\{[^<]*)<\/message/i)).showCaptcha&&
AnyBalance.trace("Капчунька нужна...");a=AnyBalance.requestPost(baseurl+"j_security_check",{j_username:b.login,j_password:b.password,device_id:"",captcha:"",activation_code:"",locale:"ru"},addHeaders({Referer:baseurl+"protected/welcome.jsf"}))}if(/<input[^>]+otp_type_3_input[^>]*>/i.test(a)){c=getParam(a,null,null,/<input[^>]+emvSessionid[^>]+value="([^"]*)/i);a=AnyBalance.requestPost(baseurl+"smsPasswordLoginAjaxServlet",{smsSentTime:(new Date).getTime()},addHeaders({Referer:baseurl+"j_security_check"}));
d=getParam(a,null,null,/(\d+)/i);if(!d||!c)throw new AnyBalance.Error("Не удалось найти ID сессии. Сайт изменён?");var e=AnyBalance.retrieveCode("Пожалуйста, введите код из SMS для входа в интернет-банк. (ID: "+d+")",null,{inputType:"number",time:18E4});try{a=AnyBalance.requestPost(baseurl+"j_security_check",{session_id:d,register_computer:"",otp_type_7_input:"",otp_type_6_input:"",otp_type_4_input:"",otp_type_3_input:e,otp_type_1_input:"",otp_type:"3",otp:e,os_name:"",locale:"ru",j_username:b.login,
emvSessionId:c,device_id:"",computer_name:"",browser_name:""},addHeaders({Referer:baseurl+"j_security_check"}))}catch(f){AnyBalance.trace(f),a=AnyBalance.requestGet(baseurl+"protected/welcome.jsf",g_headers)}}if(!/logout/i.test(a)){if(b=getElement(a,/<(?:[\s\S](?!display:\s*none|>))+class="error"(?:[\s\S](?!display:\s*none|>))*.>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/Неверно указаны данные для входа в систему|парол/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");
}__setLoginSuccessful();return a}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){b=AnyBalance.requestGet(baseurl+"protected/accounts_and_cards/index",g_headers);b=getParam(b,null,null,null,replaceHtmlEntities);var c=getElement(b,/<span[^>]+title[^>]*>Карты(?:[\s\S]*?)(<table[^>]+tblList[^>]*>)/i),c=getElements(c,/<tr[^>]*>/ig);if(c.length){AnyBalance.trace("Найдено карт: "+(c.length-1));a.cards=[];for(var d=1;d<c.length;++d){var e=getParam(c[d],null,null,/<a[^>]*>[^\d]*(\d*)/i),f=getParam(c[d],null,null,/<a[^>]*>[^\d]*(\d*)/i),
g=getParam(c[d],null,null,/<tr(?:[^>]*>){4}([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),e={__id:e,__name:g,num:f};__shouldProcess("cards",e)&&processCard(c[d],e,b);a.cards.push(e)}}else AnyBalance.trace(b),AnyBalance.trace("Карты не найдены.")}}
function processCard(b,a,c){AnyBalance.trace("Обработка карты "+a.__name);getParam(b,a,"cards.balance",/<span[^>]+amount[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["cards.currency","cards.balance"],/<span[^>]+amount[^>]*>([^<]*)/i,replaceTagsAndSpaces,parseCurrency);var d={j_id_6h_2_SUBMIT:getParam(c,null,null,/<input[^>]+j_id_6h_2_SUBMIT[^>]+value="([^"]*)/i),"javax.faces.ViewState":getParam(c,null,null,/<input[^>]+javax.faces.ViewState[^>]+value="([^"]*)/i),card_id:getParam(b,
null,null,/card_id([^']*'){3}/i,[/'/ig,""])},e=getParam(b,null,null,/submitForm([^']*'){2}/i,[/'/ig,""]);b=getParam(b,null,null,/submitForm([^']*'){4}/i,[/'/ig,""]);if(e&&b){d[e+":_idcl"]=b;try{c=AnyBalance.requestPost(baseurl+"protected/accounts_and_cards/index",d,addHeaders({Referer:baseurl+"protected/accounts_and_cards/index"}))}catch(f){AnyBalance.trace(f),c=AnyBalance.requestGet(baseurl+"protected/accounts_and_cards/account_card_list.jsf",g_headers)}c=getParam(c,null,null,null,replaceHtmlEntities);
getParam(c,a,"cards.holder",/Держатель:([^<]*)/i,replaceTagsAndSpaces);getParam(c,a,"cards.full_num",/Карточный счет\s*([^<]*)/i,replaceTagsAndSpaces);getParam(c,a,"cards.till",/Действительна до:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"cards.agreement",/Номер договора:([^<]*)/i,replaceTagsAndSpaces);isAvailable("cards.transactions")&&processCardTransactions(c,a)}else AnyBalance.trace("Не удалось найти параметры запроса на подробную информацию по карте.")}
function processInfo(b,a){a=a.info={};getParam(b,a,"info.fio",/<div[^>]+clientName[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces)}function processDeposits(b,a){throw new AnyBalance.Error("Обработка депозитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}function processCredits(b,a){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processAccounts(b,a){throw new AnyBalance.Error("Обработка счетов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");};
