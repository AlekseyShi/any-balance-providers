var byteUtils={hexChar:"0123456789ABCDEF".split(""),getRandomByte:function(){return Math.floor(1/(Math.random()*Math.random()+Math.random()+1)*255)},getRandomBytes:function(a){if("undefined"!=typeof window.crypto)return this.getCryptoRandomBytes(a);for(var c=Array(a),b=0;b<a;b++)c[b]=this.getRandomByte();return c},getCryptoRandomBytes:function(a){a=new Uint8Array(a);window.crypto.getRandomValues(a);return[].slice.call(a)},getRandomByteHEX:function(){return this.byteToHex(this.getRandomByte())},getRandomBytesHEX:function(a){return byteUtils.bytesToHex(this.getRandomBytes(a))},
getCryptoRandomBytesHEX:function(a){return byteUtils.bytesToHex(this.getCryptoRandomBytes(a))},xorHEX:function(a,c){for(var b="",d=0;d<a.length;d+=2)b+=this.byteToHex(this.hex2byte(a[d]+a[d+1])^this.hex2byte(c[d]+c[d+1]));return b},byteToHex:function(a){return this.hexChar[a>>4&15]+this.hexChar[a&15]},bytesToHex:function(a){for(var c="",b=0;b<a.length;b++)c+=this.byteToHex(a[b]);return c},hex2byte:function(a){return parseInt(a,16)},hex2bytes:function(a){for(var c=[];2<=a.length;)c.push(this.hex2byte(a.substring(0,
2))),a=a.substring(2,a.length);return c},int2bytes:function(a){return""+this.byteToHex(a>>24&255)+this.byteToHex(a>>16&255)+this.byteToHex(a>>8&255)+this.byteToHex(a&255)},wordArrayToBytes:function(a){var c=a.words;a=a.sigBytes;for(var b=new Uint8Array(a),d=0;d<a;d++)b[d]=c[d>>>2]>>>24-d%4*8&255;return b},getRandomInt:function(){if("undefined"!=typeof window.crypto){var a=new Int32Array(1);window.crypto.getRandomValues(a);return Math.abs(Math.floor(a[0]))}return Math.floor(Math.random()*INT_MAX)},
getRandomIntBounded:function(a,c){if(a>=c)throw"Минимальное значение должно быть строго меньше максимального";var b=this.getRandomInt();return Math.floor((c-a)/INT_MAX*b+a)}},INT_MAX=2147483647;var Auth={INT_ONE:"00000001",CLIENT_KEY_STR:"",SERVER_KEY_STR:"",hashType:"SHA-512",exports:{saltedPassword:"",authMessage:"",clientProof:""},init:function(a,c){this.CLIENT_KEY_STR=a;this.SERVER_KEY_STR=c},hi:function(a,c,b){for(var d=c=this.getHmac(a,"HEX",c+Auth.INT_ONE,"HEX"),f=1;f<b;f++)d=this.getHmac(a,"HEX",d,"HEX"),c=byteUtils.xorHEX(c,d);return c},"getnonсeC":function(){return byteUtils.getRandomBytesHEX(32)},getSalt:function(){return byteUtils.getRandomBytesHEX(32)},getIterationCount:function(){return byteUtils.getRandomIntBounded(4096,
5E3)},getAuthMessage:function(a,c,b,d,f){for(var g="",h=0;h<a.length;h++)g+=byteUtils.byteToHex(a.charCodeAt(h));g=g+c+b+byteUtils.int2bytes(d);for(h=0;h<f.length;h++)g+=byteUtils.byteToHex(f.charCodeAt(h));return g},getClientProof:function(a,c,b,d,f,g){this.exports.saltedPassword=this.hi(c,b,d);c=this.getHmac(this.exports.saltedPassword,"HEX",this.CLIENT_KEY_STR,"HEX");var h=this.getHash(c);this.exports.authMessage=this.getAuthMessage(a,f,b,d,g);a=this.getHmac(h,"HEX",this.exports.authMessage,"HEX");
this.exports.clientProof=byteUtils.xorHEX(c,a);return this.exports.clientProof},checkServerSignature:function(a){var c=this.getHmac(this.exports.saltedPassword,"HEX",this.SERVER_KEY_STR,"HEX");return this.getHmac(c,"HEX",this.exports.authMessage,"HEX")==a},getMd5Hash:function(a){return CryptoJS.MD5(a).toString()},getHash:function(a){var c=new jsSHA(this.hashType,"HEX");c.update(a);return c.getHash("HEX")},getHmac:function(a,c,b,d){d=new jsSHA(this.hashType,d);d.setHMACKey(a,c);d.update(b);return d.getHMAC("HEX")},
getHMacHex:function(a,c){var b=new jsSHA(this.hashType,"TEXT");b.setHMACKey(a,"HEX");b.update(c);return b.getHMAC("HEX")},getHMacHexHex:function(a,c){var b=new jsSHA(this.hashType,"HEX");b.setHMACKey(a,"HEX");b.update(c);return b.getHMAC("HEX")}};(function(a){function c(b,a,c){var d=0,q=[],f=0,g,e,E,H,r,n,F,t=!1,l=!1,y=[],v=[],A,B=!1;c=c||{};g=c.encoding||"UTF8";A=c.numRounds||1;E=k(a,g);if(A!==parseInt(A,10)||1>A)throw Error("numRounds must a integer >= 1");n=function(a,c){return G(a,c,b)};F=function(a,c,m,d){var x,q;if("SHA-384"===b||"SHA-512"===b)x=(c+129>>>10<<5)+31,q=32;else throw Error("Unexpected error in SHA-2 implementation");for(;a.length<=x;)a.push(0);a[c>>>5]|=128<<24-c%32;a[x]=c+m;m=a.length;for(c=0;c<m;c+=q)d=G(a.slice(c,c+q),
d,b);if("SHA-384"===b)a=[d[0].a,d[0].b,d[1].a,d[1].b,d[2].a,d[2].b,d[3].a,d[3].b,d[4].a,d[4].b,d[5].a,d[5].b];else if("SHA-512"===b)a=[d[0].a,d[0].b,d[1].a,d[1].b,d[2].a,d[2].b,d[3].a,d[3].b,d[4].a,d[4].b,d[5].a,d[5].b,d[6].a,d[6].b,d[7].a,d[7].b];else throw Error("Unexpected error in SHA-2 implementation");return a};if("SHA-384"===b)r=1024,H=384;else if("SHA-512"===b)r=1024,H=512;else throw Error("Chosen SHA variant is not supported");e=C(b);this.setHMACKey=function(a,c,m){var x;if(!0===l)throw Error("HMAC key already set");
if(!0===t)throw Error("Cannot set HMAC key after finalizing hash");if(!0===B)throw Error("Cannot set HMAC key after calling update");g=(m||{}).encoding||"UTF8";c=k(c,g)(a);a=c.binLen;c=c.value;x=r>>>3;m=x/4-1;if(x<a/8){for(c=F(c,a,0,C(b));c.length<=m;)c.push(0);c[m]&=4294967040}else if(x>a/8){for(;c.length<=m;)c.push(0);c[m]&=4294967040}for(a=0;a<=m;a+=1)y[a]=c[a]^909522486,v[a]=c[a]^1549556828;e=n(y,e);d=r;l=!0};this.update=function(b){var a,c,m,w=0,x=r>>>5;a=E(b,q,f);b=a.binLen;c=a.value;a=b>>>
5;for(m=0;m<a;m+=x)w+r<=b&&(e=n(c.slice(m,m+x),e),w+=r);d+=w;q=c.slice(w>>>5);f=b%r;B=!0};this.getHash=function(a,c){var m;if(!0===l)throw Error("Cannot call getHash after setting HMAC key");m=p(c);switch(a){case "HEX":a=function(b){return h(b,m)};break;case "B64":a=function(b){return u(b,m)};break;case "BYTES":a=z;break;default:throw Error("format must be HEX, B64, or BYTES");}if(!1===t)for(e=F(q,f,d,e),c=1;c<A;c+=1)e=F(e,H,0,C(b));t=!0;return a(e)};this.getHMAC=function(a,c){var m,x;if(!1===l)throw Error("Cannot call getHMAC without first setting HMAC key");
x=p(c);switch(a){case "HEX":a=function(b){return h(b,x)};break;case "B64":a=function(b){return u(b,x)};break;case "BYTES":a=z;break;default:throw Error("outputFormat must be HEX, B64, or BYTES");}!1===t&&(m=F(q,f,d,e),e=n(v,C(b)),e=F(m,H,r,e));t=!0;return a(e)}}function b(b,a){this.a=b;this.b=a}function d(b,a,c){var d=b.length,q,f,e,g,h;a=a||[0];c=c||0;h=c>>>3;if(0!==d%2)throw Error("String of HEX type must be in byte increments");for(q=0;q<d;q+=2){f=parseInt(b.substr(q,2),16);if(isNaN(f))throw Error("String of HEX type contains invalid characters");
g=(q>>>1)+h;for(e=g>>>2;a.length<=e;)a.push(0);a[e]|=f<<8*(3-g%4)}return{value:a,binLen:4*d+c}}function f(b,a,c){var d,q,e,f,g;d=a||[0];c=c||0;e=c>>>3;for(q=0;q<b.length;q+=1)a=b.charCodeAt(q),g=q+e,f=g>>>2,d.length<=f&&d.push(0),d[f]|=a<<8*(3-g%4);return{value:d,binLen:8*b.length+c}}function g(b,a,c){var d,f=0,e,g,h,E,k,r;d=a||[0];c=c||0;a=c>>>3;if(-1===b.search(/^[a-zA-Z0-9=+\/]+$/))throw Error("Invalid character in base-64 string");g=b.indexOf("=");b=b.replace(/\=/g,"");if(-1!==g&&g<b.length)throw Error("Invalid '=' found in base-64 string");
for(g=0;g<b.length;g+=4){k=b.substr(g,4);for(h=E=0;h<k.length;h+=1)e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(k[h]),E|=e<<18-6*h;for(h=0;h<k.length-1;h+=1){r=f+a;for(e=r>>>2;d.length<=e;)d.push(0);d[e]|=(E>>>16-8*h&255)<<8*(3-r%4);f+=1}}return{value:d,binLen:8*f+c}}function h(b,a){var c="",d=4*b.length,e,f;for(e=0;e<d;e+=1)f=b[e>>>2]>>>8*(3-e%4),c+="0123456789abcdef".charAt(f>>>4&15)+"0123456789abcdef".charAt(f&15);return a.outputUpper?c.toUpperCase():c}function u(b,
a){var c="",d=4*b.length,e,f,g;for(e=0;e<d;e+=3)for(g=e+1>>>2,f=b.length<=g?0:b[g],g=e+2>>>2,g=b.length<=g?0:b[g],g=(b[e>>>2]>>>8*(3-e%4)&255)<<16|(f>>>8*(3-(e+1)%4)&255)<<8|g>>>8*(3-(e+2)%4)&255,f=0;4>f;f+=1)8*e+6*f<=32*b.length?c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g>>>6*(3-f)&63):c+=a.b64Pad;return c}function z(b){var a="",c=4*b.length,d,e;for(d=0;d<c;d+=1)e=b[d>>>2]>>>8*(3-d%4)&255,a+=String.fromCharCode(e);return a}function p(b){var a={outputUpper:!1,b64Pad:"="};
b=b||{};a.outputUpper=b.outputUpper||!1;!0===b.hasOwnProperty("b64Pad")&&(a.b64Pad=b.b64Pad);if("boolean"!==typeof a.outputUpper)throw Error("Invalid outputUpper formatting option");if("string"!==typeof a.b64Pad)throw Error("Invalid b64Pad formatting option");return a}function k(b,a){switch(a){case "UTF8":case "UTF16BE":case "UTF16LE":break;default:throw Error("encoding must be UTF8, UTF16BE, or UTF16LE");}switch(b){case "HEX":b=d;break;case "TEXT":b=function(b,c,d){var e,f,g=0,w,h,k,n,l;e=c||[0];
c=d||0;k=c>>>3;if("UTF8"===a)for(w=0;w<b.length;w+=1)for(d=b.charCodeAt(w),f=[],128>d?f.push(d):2048>d?(f.push(192|d>>>6),f.push(128|d&63)):55296>d||57344<=d?f.push(224|d>>>12,128|d>>>6&63,128|d&63):(w+=1,d=65536+((d&1023)<<10|b.charCodeAt(w)&1023),f.push(240|d>>>18,128|d>>>12&63,128|d>>>6&63,128|d&63)),h=0;h<f.length;h+=1){l=g+k;for(n=l>>>2;e.length<=n;)e.push(0);e[n]|=f[h]<<8*(3-l%4);g+=1}else if("UTF16BE"===a||"UTF16LE"===a)for(w=0;w<b.length;w+=1){d=b.charCodeAt(w);"UTF16LE"===a&&(h=d&255,d=h<<
8|d>>>8);l=g+k;for(n=l>>>2;e.length<=n;)e.push(0);e[n]|=d<<8*(2-l%4);g+=2}return{value:e,binLen:8*g+c}};break;case "B64":b=g;break;case "BYTES":b=f;break;default:throw Error("format must be HEX, TEXT, B64, or BYTES");}return b}function l(a,c){a=new b(a.a,a.b);return 32>=c?new b(a.a>>>c|a.b<<32-c&4294967295,a.b>>>c|a.a<<32-c&4294967295):new b(a.b>>>c-32|a.a<<64-c&4294967295,a.a>>>c-32|a.b<<64-c&4294967295)}function v(a,c){return 32>=c?new b(a.a>>>c,a.b>>>c|a.a<<32-c&4294967295):new b(0,a.a>>>c-32)}
function I(a,c,d){return new b(a.a&c.a^~a.a&d.a,a.b&c.b^~a.b&d.b)}function B(a,c,d){return new b(a.a&c.a^a.a&d.a^c.a&d.a,a.b&c.b^a.b&d.b^c.b&d.b)}function Q(a){var c=l(a,28),d=l(a,34);a=l(a,39);return new b(c.a^d.a^a.a,c.b^d.b^a.b)}function R(a){var c=l(a,14),d=l(a,18);a=l(a,41);return new b(c.a^d.a^a.a,c.b^d.b^a.b)}function S(a){var c=l(a,1),d=l(a,8);a=v(a,7);return new b(c.a^d.a^a.a,c.b^d.b^a.b)}function T(a){var c=l(a,19),d=l(a,61);a=v(a,6);return new b(c.a^d.a^a.a,c.b^d.b^a.b)}function U(a,c){var d,
e,f;d=(a.b&65535)+(c.b&65535);e=(a.b>>>16)+(c.b>>>16)+(d>>>16);f=(e&65535)<<16|d&65535;d=(a.a&65535)+(c.a&65535)+(e>>>16);e=(a.a>>>16)+(c.a>>>16)+(d>>>16);return new b((e&65535)<<16|d&65535,f)}function V(a,c,d,e){var f,g,h;f=(a.b&65535)+(c.b&65535)+(d.b&65535)+(e.b&65535);g=(a.b>>>16)+(c.b>>>16)+(d.b>>>16)+(e.b>>>16)+(f>>>16);h=(g&65535)<<16|f&65535;f=(a.a&65535)+(c.a&65535)+(d.a&65535)+(e.a&65535)+(g>>>16);g=(a.a>>>16)+(c.a>>>16)+(d.a>>>16)+(e.a>>>16)+(f>>>16);return new b((g&65535)<<16|f&65535,
h)}function W(a,c,d,e,f){var g,h,k;g=(a.b&65535)+(c.b&65535)+(d.b&65535)+(e.b&65535)+(f.b&65535);h=(a.b>>>16)+(c.b>>>16)+(d.b>>>16)+(e.b>>>16)+(f.b>>>16)+(g>>>16);k=(h&65535)<<16|g&65535;g=(a.a&65535)+(c.a&65535)+(d.a&65535)+(e.a&65535)+(f.a&65535)+(h>>>16);h=(a.a>>>16)+(c.a>>>16)+(d.a>>>16)+(e.a>>>16)+(f.a>>>16)+(g>>>16);return new b((h&65535)<<16|g&65535,k)}function C(a){var c,d;c=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];d=[1779033703,3144134277,1013904242,
2773480762,1359893119,2600822924,528734635,1541459225];switch(a){case "SHA-224":a=c;break;case "SHA-256":a=d;break;case "SHA-384":a=[new b(3418070365,c[0]),new b(1654270250,c[1]),new b(2438529370,c[2]),new b(355462360,c[3]),new b(1731405415,c[4]),new b(41048885895,c[5]),new b(3675008525,c[6]),new b(1203062813,c[7])];break;case "SHA-512":a=[new b(d[0],4089235720),new b(d[1],2227873595),new b(d[2],4271175723),new b(d[3],1595750129),new b(d[4],2917565137),new b(d[5],725511199),new b(d[6],4215389547),
new b(d[7],327033209)];break;default:throw Error("Unknown SHA variant");}return a}function G(a,c,d){var e,f,g,h,k,l,p,r,n,u,t,v,y,z,A,C,G,J,K,L,M,N,D=[],O;if("SHA-384"===d||"SHA-512"===d)u=80,v=2,N=b,y=U,z=V,A=W,C=S,G=T,J=Q,K=R,M=B,L=I,O=P;else throw Error("Unexpected error in SHA-2 implementation");d=c[0];e=c[1];f=c[2];g=c[3];h=c[4];k=c[5];l=c[6];p=c[7];for(t=0;t<u;t+=1)16>t?(n=t*v,r=a.length<=n?0:a[n],n=a.length<=n+1?0:a[n+1],D[t]=new N(r,n)):D[t]=z(G(D[t-2]),D[t-7],C(D[t-15]),D[t-16]),r=A(p,K(h),
L(h,k,l),O[t],D[t]),n=y(J(d),M(d,e,f)),p=l,l=k,k=h,h=y(g,r),g=f,f=e,e=d,d=y(r,n);c[0]=y(d,c[0]);c[1]=y(e,c[1]);c[2]=y(f,c[2]);c[3]=y(g,c[3]);c[4]=y(h,c[4]);c[5]=y(k,c[5]);c[6]=y(l,c[6]);c[7]=y(p,c[7]);return c}var e,P;e=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,
2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];P=[new b(e[0],3609767458),new b(e[1],602891725),new b(e[2],3964484399),new b(e[3],2173295548),
new b(e[4],4081628472),new b(e[5],3053834265),new b(e[6],2937671579),new b(e[7],3664609560),new b(e[8],2734883394),new b(e[9],1164996542),new b(e[10],1323610764),new b(e[11],3590304994),new b(e[12],4068182383),new b(e[13],991336113),new b(e[14],633803317),new b(e[15],3479774868),new b(e[16],2666613458),new b(e[17],944711139),new b(e[18],2341262773),new b(e[19],2007800933),new b(e[20],1495990901),new b(e[21],1856431235),new b(e[22],3175218132),new b(e[23],2198950837),new b(e[24],3999719339),new b(e[25],
766784016),new b(e[26],2566594879),new b(e[27],3203337956),new b(e[28],1034457026),new b(e[29],2466948901),new b(e[30],3758326383),new b(e[31],168717936),new b(e[32],1188179964),new b(e[33],1546045734),new b(e[34],1522805485),new b(e[35],2643833823),new b(e[36],2343527390),new b(e[37],1014477480),new b(e[38],1206759142),new b(e[39],344077627),new b(e[40],1290863460),new b(e[41],3158454273),new b(e[42],3505952657),new b(e[43],106217008),new b(e[44],3606008344),new b(e[45],1432725776),new b(e[46],1467031594),
new b(e[47],851169720),new b(e[48],3100823752),new b(e[49],1363258195),new b(e[50],3750685593),new b(e[51],3785050280),new b(e[52],3318307427),new b(e[53],3812723403),new b(e[54],2003034995),new b(e[55],3602036899),new b(e[56],1575990012),new b(e[57],1125592928),new b(e[58],2716904306),new b(e[59],442776044),new b(e[60],593698344),new b(e[61],3733110249),new b(e[62],2999351573),new b(e[63],3815920427),new b(3391569614,3928383900),new b(3515267271,566280711),new b(3940187606,3454069534),new b(4118630271,
4000239992),new b(116418474,1914138554),new b(174292421,2731055270),new b(289380356,3203993006),new b(460393269,320620315),new b(685471733,587496836),new b(852142971,1086792851),new b(1017036298,365543100),new b(1126000580,2618297676),new b(1288033470,3409855158),new b(1501505948,4234509866),new b(1607167915,987167468),new b(1816402316,1246189591)];"function"===typeof define&&define.amd?define(function(){return c}):"undefined"!==typeof exports?"undefined"!==typeof module&&module.exports?module.exports=
exports=c:exports=c:a.jsSHA=c})(this);var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.mkb.ru/";
function cryptParams(a,c){var b=AnyBalance.getPreferences(),d=b.login,b=b.password;"undefined"==typeof window&&(window={});var f=getJsonObject(a,/var\s+PageConfig\s*=\s*/);if(!f)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти ключи авторизации. Сайт изменен?");Auth.init(f.ClientKey,f.ServerKey);a=Auth.getMd5Hash(b);b=Auth.getnon\u0441eC();f=AnyBalance.requestPost(baseurl+"auth?m=l",JSON.stringify({l:d,nc:b}),addHeaders({"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json; charset=UTF-8",
Referer:baseurl+"secure/login.aspx?ReturnUrl=%2fsecure%2fmain.aspx"}));b=getJson(f).d;if(!b)throw AnyBalance.trace(f),new AnyBalance.Error("Не удалось получить ключи авторизации. Сайт изменен?");b=getJson(b);a=Auth.getClientProof(d,a,b.Salt,b.IterationsCount,b.NonceS,b.SessionId);var d={sid:b.SessionId,l:d,cp:a,ns:b.NonceS,am:Auth.exports.authMessage,sp:Auth.exports.saltedPassword},g;for(g in d)c[g]=d[g];c.txtPassword=""}
function login(a){AnyBalance.setDefaultCharset("utf-8");checkEmpty(a.login,"Введите логин!");checkEmpty(a.password,"Введите пароль!");checkEmpty(!a.num||/^\d{4}$/.test(a.num),"Укажите 4 последних цифры или не указывайте ничего, чтобы получить информацию по первому продукту.");var c=AnyBalance.requestGet(baseurl+"secure/main.aspx",g_headers);if(!c||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(c),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");
if(/logout/i.test(c))AnyBalance.trace("Уже залогинены, используем существующую сессию");else{getElement(c,/<form[^>]+name="login"[^>]*>/i);var b=createFormParams(c,function(b,c,d,u){return"txtLogin"==d?a.login:"txtPassword"==d?a.password:"__EVENTTARGET"==d?"btnLoginStandard":u});cryptParams(c,b);c=AnyBalance.requestPost(baseurl+"secure/login.aspx?ReturnUrl=%2fsecure%2fmain.aspx",b,addHeaders({Referer:baseurl+"secure/login.aspx?ReturnUrl=%2fsecure%2fmain.aspx"}))}if(/<input[^>]+name="txtCode"/i.test(c)){AnyBalance.trace("Потребовался ввод кода.");
var d=getElement(c,/<p[^>]*msgSMSCode[^>]*/i,replaceTagsAndSpaces);getElement(c,/<form[^>]+name="login"[^>]*>/i);b=createFormParams(c,function(a,b,c,u){return"txtCode"==c?AnyBalance.retrieveCode((d||"Пожалуйста, введите код из SMS для входа в интернет-банк.")+'\n\nЧтобы каждый раз не вводить код, вы можете отключить его в своём интернет банке: меню "Настройки системы"/"Настройки информирования"/"Информирование об операциях в системе", затем снять галочку "Запрашивать SMS-код подтверждения при входе". Это безопасно, код подтверждения всё равно будет требоваться для всех операций.',
null,{inputType:"number",time:3E5}):u});c=AnyBalance.requestPost(baseurl+"secure/login.aspx",b,addHeaders({Referer:baseurl+"secure/login.aspx"}))}if(!/logout/i.test(c)){if(b=getParam(c,null,null,/<div[^>]+id="errMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/Проверьте правильность указания Логина и Пароля/i.test(b));AnyBalance.trace(c);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return c}
function processAccounts(a,c){if(AnyBalance.isAvailable("accounts")){a=AnyBalance.requestGet(baseurl+"secure/accounts.aspx",g_headers);a=getParam(a,null,null,/var\s+accountdata\s*=\s*(\[[^\]]+\])/i,null,getJson);AnyBalance.trace("Найдено счетов: "+a.length);c.accounts=[];for(var b=0;b<a.length;++b){var d=a[b],f=d.benefacc,f={__id:f,__name:d.acctype+" "+f+" "+d.curr};__shouldProcess("accounts",f)&&processAccount(d,f);c.accounts.push(f)}}}
function processAccount(a,c){AnyBalance.trace("Обработка счета "+c.__name);getParam(a.acc,c,"accounts.num");getParam(a.acctype,c,"accounts.type");getParam(a.balance,c,"accounts.balance",null,null,parseBalance);getParam(a.balance,c,["accounts.currency","accounts.balance"],null,null,parseCurrency);getParam(a.date,c,"accounts.date_start",null,null,parseDateWord);var b=isAvailable("accounts.transactions"),d=new Date,f=new Date(d.getFullYear()-(b?5:0),d.getMonth(),d.getDate());b&&(a=AnyBalance.requestGet(baseurl+
"secure/ops.aspx?id="+a.benefacc+"&df="+fmtDate(f)+"&dt="+fmtDate(d),addHeaders({Referer:baseurl+"secure/accounts.aspx"})),isAvailable("cards.transactions")&&processAccountTransactions(a,c))}
function processAccountTransactions(a,c){AnyBalance.trace("Получаем все операции по счету...");var b=getElement(a,/<table[^>]+ophistory[^>]*>/i);b?(c.transactions=[],processTable(b,c.transactions,"accounts.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},descr:{re:/Детали платежа/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:<table|<\/td>)/i,replaceTagsAndSpaces);getParam(b,c,a+"acc",/Cчет:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,
a+"payer",/Плательщик:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"bank",/Банк:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"category",/Категория:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма/i,result_func:parseBalanceSilent},auth:{re:/Номер/i,result_func:null}})):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу операций по счету!"))}
function processCards(a,c){if(AnyBalance.isAvailable("cards","bonuses")){a=AnyBalance.requestGet(baseurl+"secure/dcards.aspx",g_headers);var b=getParam(a,null,null,/<table[^>]* class="prodlist"[^>]*>[^]*?<\/table>/i);if(b){b=sumParam(b,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено карт: "+b.length);AnyBalance.isAvailable("cards")&&(c.cards=[]);(a=getParam(a,null,null,/var\s+carddata\s*=\s*(\[{[\s\S]*?}\])\s*;/i))&&(a=getJson(a));for(var d=0;d<b.length;++d){var f=b[d];if(/bonus.png/i.test(f))AnyBalance.trace("Это не карта, а бонус, получаем баллы..."),
getParam(f,c,"bonuses",/(<td[^>]*>[\s\S]*?){2}<\/td>/i,replaceTagsAndSpaces,parseBalance);else if(AnyBalance.isAvailable("cards")){var g=getParam(f,null,null,/class="txt"[^>]*>\s*([\d*]+)/i),h=sumParam(f,null,null,/class="txt"[^>]*>\s*([^<]+)/ig,replaceTagsAndSpaces,null,aggregate_join),h={__id:g,__name:h};__shouldProcess("cards",h)&&processCard(f,g,h,a[d]);c.cards.push(h)}}}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу с картами.")}}
function processCard(a,c,b,d){getParam(a,b,"cards.balance",/(?:<td[^>]*>[^]*?<\/td>\s*){4}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,["cards.currency","cards.balance"],/(?:<td[^>]*>[^]*?<\/td>\s*){4}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces,parseCurrency);getParam(a,b,"cards.cardnum",/<div[^>]*class="txt"[^>]*>([\d\*]+)/i,replaceTagsAndSpaces);getParam(a,b,"cards.type",/(?:<td[^>]*>[^]*?<\/td>\s*){2}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces);getParam(a,b,"cards.status",
/(?:<td[^>]*>[^]*?<\/td>\s*){3}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces);getParam(d.cardenddate+"",b,"cards.till",null,replaceTagsAndSpaces,parseDateWord);getParam(d.cardacc+"",b,"cards.acc_num");getParam(d.cardopendate+"",b,"cards.date_start",null,replaceTagsAndSpaces,parseDateWord);getParam(d.cardproduct+"",b,"cards.type_product");getParam(d.smsstatus+"",b,"cards.sms_status");getParam(d.smsphone+"",b,"cards.sms_phone");a=isAvailable("cards.transactions");var f=new Date,g=new Date(f.getFullYear()-
(a?5:0),f.getMonth(),f.getDate());if(a||isAvailable("cards.needpay cards.gracepay cards.gracepaytill cards.pct cards.credit cards.limit".split(" ")))f=new Date,d=AnyBalance.requestGet(baseurl+"secure/cops.aspx?id="+d.encSerno+"&df="+fmtDate(g,"/")+"&dt="+fmtDate(f,"/"),addHeaders({Referer:baseurl+"secure/dcards.aspx"})),getParam(d,b,"cards.blocked",/Неоплаченные авторизации:(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,b,"cards.pct",/Срочные проценты(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,
parseBalance),getParam(d,b,"cards.credit",/Срочный Кредит(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,b,"cards.limit",/Платежный лимит:(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,b,"cards.needpay",/Обязательный платеж(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,b,"cards.gracepay",/Отчетная задолженность(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,b,"cards.gracepaytill",/Если Вы желаете воспользоваться условиями льготного кредитования([^<]+)/i,
replaceTagsAndSpaces,parseDate),isAvailable("cards.transactions")&&processCardTransactions(c,b,d)}
function processCardTransactions(a,c,b){AnyBalance.trace("Получаем все операции по карте...");(a=getElement(b,/<table[^>]+viewsettingslist[^>]*>/i))?(c.transactions=[],processTable(a,c.transactions,"cards.transactions.",{date:{re:/Дата(?:\s+|<[^>]*>)*транзакции/i,result_func:parseDateSilent},date_done:{re:/Дата(?:\s+|<[^>]*>)*проводки/i,result_func:parseDateSilent},descr:{re:/Содержание(?:\s+|<[^>]*>)*операции/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:Категория:|<\/td>)/i,
replaceTagsAndSpaces);getParam(b,c,a+"category",/<span[^>]+operCatName[^>]*>[\s\S]*?<\/span>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма(?:\s+|<[^>]*>)*в(?:\s+|<[^>]*>)*валюте(?:\s+|<[^>]*>)*операции/i,result_process:function(a,b,c){getParam(b,c,a+"sum",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b,c,a+"currency",null,replaceTagsAndSpaces,parseCurrencySilent)}},auth:{re:/код(?:\s+|<[^>]*>)*авто/i,result_func:null},sum_account:{re:/Сумма(?:\s+|<[^>]*>)*в(?:\s+|<[^>]*>)*валюте(?:\s+|<[^>]*>)*счета/i,
result_func:parseBalanceSilent}})):(AnyBalance.trace(b),AnyBalance.trace("Не удалось найти таблицу операций!"))}
function processDeposits(a,c){a=AnyBalance.requestGet(baseurl+"secure/deps.aspx",g_headers);var b=getParam(a,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(b){b=sumParam(b,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено депозитов: "+b.length);c.deposits=[];(a=getParam(a,null,null,/var\s+depdata\s*=\s*(\[{[\s\S]*?}\])\s*;/i))&&(a=getJson(a));for(var d=0;d<b.length;++d){var f=b[d],g=getParam(f,null,null,/class="txt"[^>]*>\s*([^<]+)/i,replaceTagsAndSpaces),
h=getParam(f,null,null,/class="txt"(?:[^>]*>){5}\s*([^<]+)/i,replaceTagsAndSpaces),g={__id:g,__name:h};__shouldProcess("deposits",g)&&processDeposit(f,g,a[d]);c.deposits.push(g)}}else AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу с депозитами.")}
function processDeposit(a,c,b){getParam(a,c,"deposits.status",/<td[^>]*CurrentStatus[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b.db,c,"deposits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(b.db,c,["deposits.currency","deposits.balance"],null,replaceTagsAndSpaces,parseCurrency);getParam(b.dr,c,"deposits.pct",null,replaceTagsAndSpaces,parseBalance);getParam(b.ac,c,"deposits.acc_num",null,replaceTagsAndSpaces);getParam(b.ddd,c,"deposits.period",null,replaceTagsAndSpaces);getParam(b.od,
c,"deposits.date_start",null,replaceTagsAndSpaces,parseDateWord);getParam(b.de,c,"deposits.date_end",null,replaceTagsAndSpaces,parseDateWord);getParam(b.cap,c,"deposits.pct_condition");getParam(b.unitcode,c,"deposits.pct_period");getParam(b.dmil,c,"deposits.balance_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(b.dmsi,c,"deposits.topup_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(b.dmal,c,"deposits.balance_max",null,replaceTagsAndSpaces,parseBalance);
a=isAvailable("deposits.transactions");var d=new Date,f=new Date(d.getFullYear()-(a?5:0),d.getMonth(),d.getDate());a&&(a=AnyBalance.requestGet(baseurl+"secure/depsops.aspx?id="+b.nm+"&df="+fmtDate(f)+"&dt="+fmtDate(d),addHeaders({Referer:baseurl+"secure/accounts.aspx"})),isAvailable("deposits.transactions")&&processDepositTransactions(a,c))}
function processDepositTransactions(a,c){AnyBalance.trace("Получаем все операции по депозиту...");var b=getElement(a,/<table[^>]+ophistory[^>]*>/i);b?(c.transactions=[],processTable(b,c.transactions,"deposits.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},descr:{re:/Детали платежа/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:<table|<\/td>)/i,replaceTagsAndSpaces);getParam(b,c,a+"acc",/Cчет:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,
c,a+"payer",/Плательщик:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"bank",/Банк:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"category",/Категория:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма/i,result_func:parseBalanceSilent},auth:{re:/Номер/i,result_func:null}})):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу операций по депозиту!"))}
function processLoans(a,c){if(AnyBalance.isAvailable("loans")){a=AnyBalance.requestGet(baseurl+"secure/loans.aspx",g_headers);var b=getParam(a,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(b){b=sumParam(b,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено кредитов: "+b.length);c.loans=[];var d=getParam(a,null,null,/var\s+loanDetailsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),f=getParam(a,null,null,/var\s+loanHistoryData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson);
a=getParam(a,null,null,/var\s+loanFuturePaymentsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson);for(var g=0;g<b.length;++g){var h=getParam(b[g],null,null,/class="txt"[^>]*>\s*([^<]+)/i,replaceTagsAndSpaces),u=getParam(b[g],null,null,/class="txt"(?:[^>]*>){6}\s*([^<]+)/i,replaceTagsAndSpaces),h={__id:h,__name:u};__shouldProcess("loans",h)&&(processLoan(b[g],h,d[g]),AnyBalance.isAvailable("loans.transactions")&&processLoanTransactions(f[g],h),AnyBalance.isAvailable("loans.schedule")&&processLoanSchedule(a[g],
h));c.loans.push(h)}}else/У Вас нет кредитов/i.test(a)?AnyBalance.trace("Нет ни одного кредита."):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу с кредитами."))}}
function parseSum(a,c,b){getParam(c,b,a+this._prefix+"sum",/<div[^>]+class="summ"[^>]*>([^]*?)<\/div>/i,replaceTagsAndSpaces,parseBalanceSilent);getParam(c,b,a+this._prefix+"debt",/Погашение основного долга[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces,parseBalanceSilent);getParam(c,b,a+this._prefix+"pct",/Погашение процентов[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces,parseBalanceSilent)}
function processLoanTransactions(a,c){AnyBalance.trace("Получаем все операции по кредиту "+c.__name);var b=a.his;b?(c.transactions=[],processTable(b,c.transactions,"loans.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},min_sum:{re:/Минимальная сумма погашения/i,_prefix:"min_",result_process:parseSum},sum:{re:/Фактически внесено/i,result_func:parseBalanceSilent},fact_sum:{re:/Фактически погашено/i,_prefix:"fact_",result_process:parseSum}})):(AnyBalance.trace(JSON.stringify(a)),AnyBalance.trace("Не удалось найти таблицу операций по кредиту!"))}
function processLoanSchedule(a,c){AnyBalance.trace("Получаем расписание платежей по кредиту "+c.__name);var b=a.fut;b?(c.schedule=[],processTable(b,c.schedule,"loans.schedule.",{date:{re:/Дата/i,result_func:parseDateWordSilent},details:{re:/В том числе/i,_prefix:"",result_process:parseSum},sum:{re:/Сумма платежа/i}})):(AnyBalance.trace(JSON.stringify(a)),AnyBalance.trace("Не удалось найти расписание платежей по кредиту!"))}
function parsePcts(a){var c=sumParam(a,null,null,/c\s*\d+\D\d+\D\d+\s*-\s*[\d.,]+%/ig);if(c){a=new Date;for(var b=c.length-1;0<=b;b--){var d=getParam(c[b],null,null,/\d+\D\d+\D\d+/,null,parseDate);if(a.getTime()>=d)return getParam(c[b],null,null,/[\d.,]+%/i,null,parseBalance)}}else return parseBalance(a)}function parseBool(a){return!/нет/i.test(a)}
function processLoan(a,c,b){AnyBalance.trace("Обработка кредита "+c.__id);getParam(b.dt,c,"loans.limit",/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,["loans.currency","loans.balance","loans.minpay","loans.limit"],/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseCurrency);getParam(b.dt,c,"loans.minpay",/Сумма ближайшего платежа:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,"loans.minpaydate",/Дата ближайшего платежа:([^]*?)<\/li>/i,
replaceTagsAndSpaces,parseDateWord);getParam(b.dt,c,"loans.penalty",/Просроченная задолженность по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,"loans.acc_num",/Лицевой счет №:([^]*?)<\/li>/i,replaceTagsAndSpaces);getParam(b.dt,c,"loans.pct",/Текущая процентная ставка по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parsePcts);getParam(b.dt,c,"loans.date_start",/Дата выдачи:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseDateWord);getParam(b.dt,c,"loans.date_end",/Дата финального погашения:([^]*?)<\/li>/i,
replaceTagsAndSpaces,parseDateWord);getParam(b.dt,c,"loans.period",/Срок кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,"loans.balance",/Текущая сумма долга по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,"loans.sum_close",/Сумма[^<]*под закрытие договора[^<]*:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,c,"loans.noclose",/Мораторий на погашение по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBool)}
function initCols(a,c){for(var b={},d=0;d<c.length;d++){var f=c[d],g;for(g in a)a[g].re.test(replaceAll(f,[replaceTagsAndSpaces,replaceHtmlEntities]))&&(b[g]=d)}return b}
function fillColsResult(a,c,b,d,f){function g(a,b){return isset(a)?a:b}f=f||"";var h=replaceTagsAndSpaces,u=parseBalance,z=aggregate_sum,p;for(p in a){var k=a[p];if(isset(c[p])){var l=b[c[p]],v=g(k.result_name,p);if(isArray(v)){for(var I=[],B=0;B<v.length;B++)I.push(f+v[B]);v=I}else v=f+v;k.result_process?k.result_process(f,l,d):k.result_sum?(k.result_re&&(k.result_re.lastIndex=0),sumParam(l,d,v,k.result_re,g(k.result_replace,h),g(k.result_func,u),g(k.result_aggregate,z))):getParam(l,d,v,k.result_re,
g(k.result_replace,h),g(k.result_func,u))}}}function processTable(a,c,b,d,f,g){a=getElements(a,/<tr[^>]*>/ig);for(var h,u,z=0;z<a.length;z++){var p=a[z],k=getElements(p,/<td[^>]*>/ig);0==k.length?(h=getElements(p,/<th[^>]*>/ig),u=h.length,h=initCols(d,h)):k.length==u?(p={},fillColsResult(d,h,k,p,b),g&&g(p,b),c.push(p)):f&&f(p,k)}}
function processInfo(a){var c=AnyBalance.requestGet(baseurl+"secure/InformingSettings/OperationsInSystem.aspx",g_headers);a=a.info={};getParam(c,a,"fio",/<div[^>]+id="statfio"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c,a,"mphone",/<input[^>]+name="[^"]*txtMobileNumber"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(c,a,"email",/<input[^>]+name="[^"]*txtNotificationEmail"[^>]*value="([^"]*)/i,replaceHtmlEntities)};
