var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.mkb.ru/";
function login(c){AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");checkEmpty(!c.num||/^\d{4}$/.test(c.num),"Укажите 4 последних цифры или не указывайте ничего, чтобы получить информацию по первому продукту.");var b=AnyBalance.requestGet(baseurl+"secure/main.aspx",g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");
/logout/i.test(b)?AnyBalance.trace("Уже залогинены, используем существующую сессию"):(getElement(b,/<form[^>]+name="login"[^>]*>/i),b=createFormParams(b,function(a,b,d,h){return"txtLogin"==d?c.login:"txtPassword"==d?c.password:h}),b=AnyBalance.requestPost(baseurl+"secure/login.aspx",b,addHeaders({Referer:baseurl+"secure/login.aspx"})));if(/<input[^>]+name="txtCode"/i.test(b)){AnyBalance.trace("Потребовался ввод кода.");var a=getElement(b,/<p[^>]*msgSMSCode[^>]*/i,replaceTagsAndSpaces);getElement(b,
/<form[^>]+name="login"[^>]*>/i);b=createFormParams(b,function(b,c,d,h){return"txtCode"==d?AnyBalance.retrieveCode((a||"Пожалуйста, введите код из SMS для входа в интернет-банк.")+'\n\nЧтобы каждый раз не вводить код, вы можете отключить его в своём интернет банке: меню "Настройки системы"/"Настройки информирования"/"Информирование об операциях в системе", затем снять галочку "Запрашивать SMS-код подтверждения при входе". Это безопасно, код подтверждения всё равно будет требоваться для всех операций.',
null,{inputType:"number",time:3E5}):h});b=AnyBalance.requestPost(baseurl+"secure/login.aspx",b,addHeaders({Referer:baseurl+"secure/login.aspx"}))}if(!/logout/i.test(b)){var d=getParam(b,null,null,/<div[^>]+id="errMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(d)throw new AnyBalance.Error(d,null,/Проверьте правильность указания Логина и Пароля/i.test(d));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return b}
function processAccounts(c,b){if(AnyBalance.isAvailable("accounts")){c=AnyBalance.requestGet(baseurl+"secure/accounts.aspx",g_headers);var a=getParam(c,null,null,/var\s+accountdata\s*=\s*(\[[^\]]+\])/i,null,getJson);AnyBalance.trace("Найдено счетов: "+a.length);b.accounts=[];for(var d=0;d<a.length;++d){var e=a[d],f=e.benefacc,f={__id:f,__name:e.acctype+" "+f+" "+e.curr};__shouldProcess("accounts",f)&&processAccount(e,f);b.accounts.push(f)}}}
function processAccount(c,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(c.acc,b,"accounts.num");getParam(c.acctype,b,"accounts.type");getParam(c.balance,b,"accounts.balance",null,null,parseBalance);getParam(c.balance,b,["accounts.currency","accounts.balance"],null,null,parseCurrency);getParam(c.date,b,"accounts.date_start",null,null,parseDateWord);var a=isAvailable("accounts.transactions"),d=new Date,e=new Date(d.getFullYear()-(a?5:0),d.getMonth(),d.getDate());a&&(a=AnyBalance.requestGet(baseurl+
"secure/ops.aspx?id="+c.benefacc+"&df="+fmtDate(e)+"&dt="+fmtDate(d),addHeaders({Referer:baseurl+"secure/accounts.aspx"})),isAvailable("cards.transactions")&&processAccountTransactions(a,b))}
function processAccountTransactions(c,b){AnyBalance.trace("Получаем все операции по счету...");var a=getElement(c,/<table[^>]+ophistory[^>]*>/i);a?(b.transactions=[],processTable(a,b.transactions,"accounts.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},descr:{re:/Детали платежа/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:<table|<\/td>)/i,replaceTagsAndSpaces);getParam(b,c,a+"acc",/Cчет:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,
a+"payer",/Плательщик:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"bank",/Банк:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"category",/Категория:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма/i,result_func:parseBalanceSilent},auth:{re:/Номер/i,result_func:null}})):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу операций по счету!"))}
function processCards(c,b){if(AnyBalance.isAvailable("cards","bonuses")){c=AnyBalance.requestGet(baseurl+"secure/dcards.aspx",g_headers);var a=getParam(c,null,null,/<table[^>]* class="prodlist"[^>]*>[^]*?<\/table>/i);if(a){a=sumParam(a,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено карт: "+a.length);AnyBalance.isAvailable("cards")&&(b.cards=[]);var d=getParam(c,null,null,/var\s+carddata\s*=\s*(\[{[\s\S]*?}\])\s*;/i);d&&(d=getJson(d));for(var e=0;e<a.length;++e){var f=a[e];
if(/bonus.png/i.test(f))AnyBalance.trace("Это не карта, а бонус, получаем баллы..."),getParam(f,b,"bonuses",/(<td[^>]*>[\s\S]*?){2}<\/td>/i,replaceTagsAndSpaces,parseBalance);else if(AnyBalance.isAvailable("cards")){var g=getParam(f,null,null,/class="txt"[^>]*>\s*([\d*]+)/i),h=sumParam(f,null,null,/class="txt"[^>]*>\s*([^<]+)/ig,replaceTagsAndSpaces,null,aggregate_join),h={__id:g,__name:h};__shouldProcess("cards",h)&&processCard(f,g,h,d[e]);b.cards.push(h)}}}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с картами.")}}
function processCard(c,b,a,d){getParam(c,a,"cards.balance",/(?:<td[^>]*>[^]*?<\/td>\s*){4}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,["cards.currency","cards.balance"],/(?:<td[^>]*>[^]*?<\/td>\s*){4}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces,parseCurrency);getParam(c,a,"cards.cardnum",/<div[^>]*class="txt"[^>]*>([\d\*]+)/i,replaceTagsAndSpaces);getParam(c,a,"cards.type",/(?:<td[^>]*>[^]*?<\/td>\s*){2}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces);getParam(c,a,"cards.status",
/(?:<td[^>]*>[^]*?<\/td>\s*){3}(<td[^>]*>[^]*?<\/td>)/i,replaceTagsAndSpaces);getParam(d.cardenddate+"",a,"cards.till",null,replaceTagsAndSpaces,parseDateWord);getParam(d.cardacc+"",a,"cards.acc_num");getParam(d.cardopendate+"",a,"cards.date_start",null,replaceTagsAndSpaces,parseDateWord);getParam(d.cardproduct+"",a,"cards.type_product");getParam(d.smsstatus+"",a,"cards.sms_status");getParam(d.smsphone+"",a,"cards.sms_phone");c=isAvailable("cards.transactions");var e=new Date,f=new Date(e.getFullYear()-
(c?5:0),e.getMonth(),e.getDate());if(c||isAvailable("cards.needpay cards.gracepay cards.gracepaytill cards.pct cards.credit cards.limit".split(" ")))e=new Date,d=AnyBalance.requestGet(baseurl+"secure/cops.aspx?id="+d.encSerno+"&df="+fmtDate(f,"/")+"&dt="+fmtDate(e,"/"),addHeaders({Referer:baseurl+"secure/dcards.aspx"})),getParam(d,a,"cards.blocked",/Неоплаченные авторизации:(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.pct",/Срочные проценты(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,
parseBalance),getParam(d,a,"cards.credit",/Срочный Кредит(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.limit",/Платежный лимит:(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.needpay",/Обязательный платеж(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.gracepay",/Отчетная задолженность(?:[^>]*>){2}([^<]+)/i,replaceTagsAndSpaces,parseBalance),getParam(d,a,"cards.gracepaytill",/Если Вы желаете воспользоваться условиями льготного кредитования([^<]+)/i,
replaceTagsAndSpaces,parseDate),isAvailable("cards.transactions")&&processCardTransactions(b,a,d)}
function processCardTransactions(c,b,a){AnyBalance.trace("Получаем все операции по карте...");(c=getElement(a,/<table[^>]+viewsettingslist[^>]*>/i))?(b.transactions=[],processTable(c,b.transactions,"cards.transactions.",{date:{re:/Дата(?:\s+|<[^>]*>)*транзакции/i,result_func:parseDateSilent},date_done:{re:/Дата(?:\s+|<[^>]*>)*проводки/i,result_func:parseDateSilent},descr:{re:/Содержание(?:\s+|<[^>]*>)*операции/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:Категория:|<\/td>)/i,
replaceTagsAndSpaces);getParam(b,c,a+"category",/<span[^>]+operCatName[^>]*>[\s\S]*?<\/span>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма(?:\s+|<[^>]*>)*в(?:\s+|<[^>]*>)*валюте(?:\s+|<[^>]*>)*операции/i,result_process:function(a,b,c){getParam(b,c,a+"sum",null,replaceTagsAndSpaces,parseBalanceSilent);getParam(b,c,a+"currency",null,replaceTagsAndSpaces,parseCurrencySilent)}},auth:{re:/код(?:\s+|<[^>]*>)*авто/i,result_func:null},sum_account:{re:/Сумма(?:\s+|<[^>]*>)*в(?:\s+|<[^>]*>)*валюте(?:\s+|<[^>]*>)*счета/i,
result_func:parseBalanceSilent}})):(AnyBalance.trace(a),AnyBalance.trace("Не удалось найти таблицу операций!"))}
function processDeposits(c,b){c=AnyBalance.requestGet(baseurl+"secure/deps.aspx",g_headers);var a=getParam(c,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(a){a=sumParam(a,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено депозитов: "+a.length);b.deposits=[];var d=getParam(c,null,null,/var\s+depdata\s*=\s*(\[{[\s\S]*?}\])\s*;/i);d&&(d=getJson(d));for(var e=0;e<a.length;++e){var f=a[e],g=getParam(f,null,null,/class="txt"[^>]*>\s*([^<]+)/i,replaceTagsAndSpaces),
h=getParam(f,null,null,/class="txt"(?:[^>]*>){5}\s*([^<]+)/i,replaceTagsAndSpaces),g={__id:g,__name:h};__shouldProcess("deposits",g)&&processDeposit(f,g,d[e]);b.deposits.push(g)}}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с депозитами.")}
function processDeposit(c,b,a){getParam(c,b,"deposits.status",/<td[^>]*CurrentStatus[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(a.db,b,"deposits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.db,b,["deposits.currency","deposits.balance"],null,replaceTagsAndSpaces,parseCurrency);getParam(a.dr,b,"deposits.pct",null,replaceTagsAndSpaces,parseBalance);getParam(a.ac,b,"deposits.acc_num",null,replaceTagsAndSpaces);getParam(a.ddd,b,"deposits.period",null,replaceTagsAndSpaces);getParam(a.od,
b,"deposits.date_start",null,replaceTagsAndSpaces,parseDateWord);getParam(a.de,b,"deposits.date_end",null,replaceTagsAndSpaces,parseDateWord);getParam(a.cap,b,"deposits.pct_condition");getParam(a.unitcode,b,"deposits.pct_period");getParam(a.dmil,b,"deposits.balance_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(a.dmsi,b,"deposits.topup_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(a.dmal,b,"deposits.balance_max",null,replaceTagsAndSpaces,parseBalance);
c=isAvailable("deposits.transactions");var d=new Date,e=new Date(d.getFullYear()-(c?5:0),d.getMonth(),d.getDate());c&&(c=AnyBalance.requestGet(baseurl+"secure/depsops.aspx?id="+a.nm+"&df="+fmtDate(e)+"&dt="+fmtDate(d),addHeaders({Referer:baseurl+"secure/accounts.aspx"})),isAvailable("deposits.transactions")&&processDepositTransactions(c,b))}
function processDepositTransactions(c,b){AnyBalance.trace("Получаем все операции по депозиту...");var a=getElement(c,/<table[^>]+ophistory[^>]*>/i);a?(b.transactions=[],processTable(a,b.transactions,"deposits.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},descr:{re:/Детали платежа/i,result_process:function(a,b,c){getParam(b,c,a+"descr",/([\s\S]*?)(?:<table|<\/td>)/i,replaceTagsAndSpaces);getParam(b,c,a+"acc",/Cчет:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,
c,a+"payer",/Плательщик:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"bank",/Банк:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b,c,a+"category",/Категория:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)}},sum:{re:/Сумма/i,result_func:parseBalanceSilent},auth:{re:/Номер/i,result_func:null}})):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу операций по депозиту!"))}
function processLoans(c,b){if(AnyBalance.isAvailable("loans")){c=AnyBalance.requestGet(baseurl+"secure/loans.aspx",g_headers);var a=getParam(c,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(a){a=sumParam(a,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено кредитов: "+a.length);b.loans=[];for(var d=getParam(c,null,null,/var\s+loanDetailsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),e=getParam(c,null,null,/var\s+loanHistoryData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),
f=getParam(c,null,null,/var\s+loanFuturePaymentsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),g=0;g<a.length;++g){var h=getParam(a[g],null,null,/class="txt"[^>]*>\s*([^<]+)/i,replaceTagsAndSpaces),n=getParam(a[g],null,null,/class="txt"(?:[^>]*>){6}\s*([^<]+)/i,replaceTagsAndSpaces),h={__id:h,__name:n};__shouldProcess("loans",h)&&(processLoan(a[g],h,d[g]),AnyBalance.isAvailable("loans.transactions")&&processLoanTransactions(e[g],h),AnyBalance.isAvailable("loans.schedule")&&processLoanSchedule(f[g],h));
b.loans.push(h)}}else/У Вас нет кредитов/i.test(c)?AnyBalance.trace("Нет ни одного кредита."):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с кредитами."))}}
function parseSum(c,b,a){getParam(b,a,c+this._prefix+"sum",/<div[^>]+class="summ"[^>]*>([^]*?)<\/div>/i,replaceTagsAndSpaces,parseBalanceSilent);getParam(b,a,c+this._prefix+"debt",/Погашение основного долга[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces,parseBalanceSilent);getParam(b,a,c+this._prefix+"pct",/Погашение процентов[^]*?<td[^>]*>([^]*?)<\/td>/i,replaceTagsAndSpaces,parseBalanceSilent)}
function processLoanTransactions(c,b){AnyBalance.trace("Получаем все операции по кредиту "+b.__name);var a=c.his;a?(b.transactions=[],processTable(a,b.transactions,"loans.transactions.",{date:{re:/Дата/i,result_func:parseDateSilent},min_sum:{re:/Минимальная сумма погашения/i,_prefix:"min_",result_process:parseSum},sum:{re:/Фактически внесено/i,result_func:parseBalanceSilent},fact_sum:{re:/Фактически погашено/i,_prefix:"fact_",result_process:parseSum}})):(AnyBalance.trace(JSON.stringify(c)),AnyBalance.trace("Не удалось найти таблицу операций по кредиту!"))}
function processLoanSchedule(c,b){AnyBalance.trace("Получаем расписание платежей по кредиту "+b.__name);var a=c.fut;a?(b.schedule=[],processTable(a,b.schedule,"loans.schedule.",{date:{re:/Дата/i,result_func:parseDateWordSilent},details:{re:/В том числе/i,_prefix:"",result_process:parseSum},sum:{re:/Сумма платежа/i}})):(AnyBalance.trace(JSON.stringify(c)),AnyBalance.trace("Не удалось найти расписание платежей по кредиту!"))}
function parsePcts(c){var b=sumParam(c,null,null,/c\s*\d+\D\d+\D\d+\s*-\s*[\d.,]+%/ig);if(b){c=new Date;for(var a=b.length-1;0<=a;a--){var d=getParam(b[a],null,null,/\d+\D\d+\D\d+/,null,parseDate);if(c.getTime()>=d)return getParam(b[a],null,null,/[\d.,]+%/i,null,parseBalance)}}else return parseBalance(c)}function parseBool(c){return!/нет/i.test(c)}
function processLoan(c,b,a){AnyBalance.trace("Обработка кредита "+b.__id);getParam(a.dt,b,"loans.limit",/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,["loans.currency","loans.balance","loans.minpay","loans.limit"],/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseCurrency);getParam(a.dt,b,"loans.minpay",/Сумма ближайшего платежа:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,"loans.minpaydate",/Дата ближайшего платежа:([^]*?)<\/li>/i,
replaceTagsAndSpaces,parseDateWord);getParam(a.dt,b,"loans.penalty",/Просроченная задолженность по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,"loans.acc_num",/Лицевой счет №:([^]*?)<\/li>/i,replaceTagsAndSpaces);getParam(a.dt,b,"loans.pct",/Текущая процентная ставка по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parsePcts);getParam(a.dt,b,"loans.date_start",/Дата выдачи:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseDateWord);getParam(a.dt,b,"loans.date_end",/Дата финального погашения:([^]*?)<\/li>/i,
replaceTagsAndSpaces,parseDateWord);getParam(a.dt,b,"loans.period",/Срок кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,"loans.balance",/Текущая сумма долга по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,"loans.sum_close",/Сумма[^<]*под закрытие договора[^<]*:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(a.dt,b,"loans.noclose",/Мораторий на погашение по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBool)}
function initCols(c,b){for(var a={},d=0;d<b.length;d++){var e=b[d],f;for(f in c)c[f].re.test(replaceAll(e,[replaceTagsAndSpaces,replaceHtmlEntities]))&&(a[f]=d)}return a}
function fillColsResult(c,b,a,d,e){function f(a,b){return isset(a)?a:b}e=e||"";var g=replaceTagsAndSpaces,h=parseBalance,n=aggregate_sum,l;for(l in c){var k=c[l];if(isset(b[l])){var p=a[b[l]],m=f(k.result_name,l);if(isArray(m)){for(var r=[],q=0;q<m.length;q++)r.push(e+m[q]);m=r}else m=e+m;k.result_process?k.result_process(e,p,d):k.result_sum?(k.result_re&&(k.result_re.lastIndex=0),sumParam(p,d,m,k.result_re,f(k.result_replace,g),f(k.result_func,h),f(k.result_aggregate,n))):getParam(p,d,m,k.result_re,
f(k.result_replace,g),f(k.result_func,h))}}}function processTable(c,b,a,d,e,f){c=getElements(c,/<tr[^>]*>/ig);for(var g,h,n=0;n<c.length;n++){var l=c[n],k=getElements(l,/<td[^>]*>/ig);0==k.length?(g=getElements(l,/<th[^>]*>/ig),h=g.length,g=initCols(d,g)):k.length==h?(l={},fillColsResult(d,g,k,l,a),f&&f(l,a),b.push(l)):e&&e(l,k)}}
function processInfo(c){var b=AnyBalance.requestGet(baseurl+"secure/InformingSettings/OperationsInSystem.aspx",g_headers);c=c.info={};getParam(b,c,"fio",/<div[^>]+id="statfio"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,c,"mphone",/<input[^>]+name="[^"]*txtMobileNumber"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(b,c,"email",/<input[^>]+name="[^"]*txtNotificationEmail"[^>]*value="([^"]*)/i,replaceHtmlEntities)};
