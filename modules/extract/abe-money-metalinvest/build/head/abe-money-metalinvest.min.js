function sleep(b){AnyBalance.trace("Calling hw sleep");AnyBalance.sleep(b)}function encryptPass(b,c){if(c){for(var a="",a=0,d="",e=c.split(","),f="",d=b;""!=d;)a=d.substr(0,1),a=a.charCodeAt(0),255<a&&(a-=848),7622==a&&(a=185),d=1<d.length?d.substr(1,d.length):"",""!=f&&(f+=";"),f+=e[a];return f}return b}var g_headers={"Accept-Language":"ru, en",BSSHTTPRequest:1,"User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.60 Safari/537.1"},g_baseurl;
function login(b){var c=AnyBalance.getPreferences();g_baseurl=b;var a=AnyBalance.requestGet(b+"T=RT_2Auth.BF"),d=getParam(a,null,null,/<input[^>]*name="MapID"[^>]*value="([^"]*)"/i),a=getParam(a,null,null,/var\s+PassTemplate\s*=\s*new\s+Array\s*\(([^\)]*)/i),a=encryptPass(c.password,a),a=AnyBalance.requestPost(b,{tic:0,T:"RT_2Auth.CL",A:c.login,B:a,L:"russian",C:"",IdCaptcha:"",IMode:"",sTypeInterface:"default",MapID:d||""},g_headers);if(c=getParam(a,null,null,/<BSS_ERROR>\d*\|?([\s\S]*?)<\/BSS_ERROR>/i,
replaceTagsAndSpaces))throw new AnyBalance.Error(c);c=getParam(a,null,null,/ClientInfo=(\{[\s\S]*?\})\s*(?:<\/div>|$)/i);if(!c)throw new AnyBalance.Error("Не удалось найти информацию о сессии в ответе банка.");c=JSON.parse(c);AnyBalance.requestPost(b,{SID:c.SID,tic:1,T:"rt_0clientupdaterest.doheavyupd"},g_headers);d=0;do{AnyBalance.trace("Ожидание обновления данных: "+(d+1));a=AnyBalance.requestPost(b,{SID:c.SID,tic:1,T:"rt_0clientupdaterest.CheckForAcyncProcess"},addHeaders({Referer:b+"T=RT_2Auth.BF"}));
if(a=getParam(a,null,null,/^\s*(?:<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>)?([\s\S]*>)?\d+\s*$/i,replaceTagsAndSpaces)){AnyBalance.trace("Обновление данных закончено. "+a);break}if(10<++d){AnyBalance.trace("Не удалось за 10 попыток обновить баланс, получаем старое значение...");break}sleep(3E3)}while(1);return c}
function processCredits(b,c){var a=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,T:"RT_2IC.SC",nvgt:1,SCHEMENAME:"CREDITS",FILTERIDENT:""},addHeaders({Referer:g_baseurl})),d=getElement(a,/<table[^>]+id="SCROLLER"[^>]*>/i);if(d){d=getElements(d,/<(?:thead|tbody)[^>]*>/ig);if(!/<thead/i.test(""+d[0]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти заголовок таблицы кредитов. Сайт изменен?");if(!/<tbody/i.test(""+d[1]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти тело таблицы кредитов. Сайт изменен?");
c.credits=[];for(var a=getColsCredit(d[0]),d=getElements(d[1],/<tr[^>]*>/ig),e=0;e<d.length;++e){var f=d[e],g=getParam(f,null,null,/<tr[^>]+ACC="([^"]*)/i,replaceHtmlEntities),h=getElements(f,/<td[^>]*>/ig),k=/NickEmpty/i.test(f)||!isset(a.name)?g:getParam(h[a.name],null,null,null,replaceTagsAndSpaces),g={__id:g,__name:k};if(__shouldProcess("credits",g)){processCredit(a,h,g);h=getParam(f,null,null,/<tr[^>]+SIDR="([^"]*)/i,replaceHtmlEntities);if(!h){AnyBalance.trace("Не удаётся найти ссылку на расширенную информацию по кредиту\n"+
f);continue}processCreditExtra(b,h,g);processCreditTransactions(b,h,g)}c.credits.push(g)}}else AnyBalance.trace("Похоже, кредитов нет...\n"+a)}
function processAccounts(b,c){var a=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,T:"RT_2IC.form",nvgt:1,SCHEMENAME:"STM",XACTION:"NEW"},addHeaders({Referer:g_baseurl})),d=getElement(a,/<table[^>]+id="SCROLLER"[^>]*>/i);if(d){d=getElements(d,/<(?:thead|tbody)[^>]*>/ig);if(!/<thead/i.test(""+d[0]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти заголовок таблицы счетов. Сайт изменен?");if(!/<tbody/i.test(""+d[1]))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся найти тело таблицы счетов. Сайт изменен?");
c.accounts=[];for(var a=getColsAccount(d[0]),d=getElements(d[1],/<tr[^>]*>/ig),e=0;e<d.length;++e){var f=d[e],g=getElements(f,/<td[^>]*>/ig),f=getParam(f,null,null,/<input[^>]+type="checkbox"[^>]*STM="([^"]*)/i,replaceHtmlEntities),h=getParam(g[a.name],null,null,null,replaceTagsAndSpaces),f={__id:f,__name:h};__shouldProcess("accounts",f)&&(processAccount(a,g,f),processAccountTransactions(b,f));c.accounts.push(f)}}else AnyBalance.trace("Похоже, счетов нет...\n"+a)}
function getColsAccount(b){var c={};b=getElements(b,/<th\b[^>]*>/ig);for(var a=0;a<b.length;++a){var d=getParam(b[a],null,null,null,replaceTagsAndSpaces);/Название счета/i.test(d)?c.name=a:/Сч[её]т/i.test(d)?c.num=a:/Остаток/i.test(d)?c.balance=a:/Валюта/i.test(d)&&(c.currency=a)}return c}
function getColsCredit(b){var c={};b=getElements(b,/<th\b[^>]*>/ig);for(var a=0;a<b.length;++a){var d=getParam(b[a],null,null,/FLD="([^"]*)/i,replaceHtmlEntities);/NickName/i.test(d)?c.name=a:/CONTRACTDATE/i.test(d)?c.agreement_date=a:/AMOUNT/i.test(d)?c.limit=a:/REST/i.test(d)?c.balance=a:/CURRCODE/i.test(d)?c.currency=a:/PERCENTS/i.test(d)?c.pct=a:/ENDDATE/i.test(d)?c.date_end=a:/STATUS/i.test(d)&&(c.status=a)}return c}function processInfo(b,c){getParam(b.USR,c,"fio")}
function processAccount(b,c,a){isset(b.currency)&&getParam(c[b.currency],a,["accounts.currency","accounts.balance"],null,replaceTagsAndSpaces);isset(b.balance)&&getParam(c[b.balance],a,"accounts.balance",null,replaceTagsAndSpaces,parseBalance);getParam(a.__id,a,"accounts.num",/^\d+/);isset(b.name)&&getParam(c[b.name],a,"accounts.name",null,replaceTagsAndSpaces)}
function processCredit(b,c,a){isset(b.agreement_date)&&getParam(c[b.agreement_date],a,"credits.agreement_date",null,replaceTagsAndSpaces,parseDate);isset(b.date_end)&&getParam(c[b.date_end],a,"credits.date_end",null,replaceTagsAndSpaces,parseDate);isset(b.limit)&&getParam(c[b.limit],a,"credits.limit",null,replaceTagsAndSpaces,parseBalance);isset(b.currency)&&getParam(c[b.currency],a,["credits.currency","credits.limit","credits.balance","credits.min_pay"],null,replaceTagsAndSpaces);isset(b.balance)&&
getParam(c[b.balance],a,"credits.balance",null,replaceTagsAndSpaces,parseBalance);isset(b.pct)&&getParam(c[b.pct],a,"credits.pct",null,replaceTagsAndSpaces,parseBalance);isset(b.status)&&getParam(c[b.status],a,"credits.status",null,replaceTagsAndSpaces)}
function processCreditExtra(b,c,a){AnyBalance.isAvailable("credits.type","credits.agreement","credits.date_start","credits.min_pay_till","credits.peni","credits.min_early","credits.min_pay_debt","credits.min_pay_pct","credits.min_pay_pct_due","credits.min_pay_debt_due","credits.pct_due","credits.peni_debt","credits.peni_pct","credits.other_payments","credits.min_pay")&&(b=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,T:"RT_2IC.view",SCHEMENAME:"CREDITS",IDR:c,FORMACTION:"VIEW",PERIODPRN:"undefined"},
addHeaders({Referer:g_baseurl})),getParam(b,a,"credits.type",/>\s*Тип кредита[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),a.__id==a.__name&&getParam(b,a,"credits.__name",/>\s*Тип кредита[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(b,a,"credits.agreement",/>\s*Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),getParam(b,a,"credits.date_start",/>\s*Дата выдачи[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),getParam(b,a,"credits.peni",
/>\s*Сумма неустойки[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_early",/>\s*Минимальная сумма досрочного погашения[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay_debt",/>\s*Сумма погашения срочного основного долга по кредиту[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay_pct",/>\s*Сумма срочных процентов к уплате[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay_pct_due",/>\s*Сумма начисленных процентов по просроченной задолженности[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay_debt_due",/>\s*Сумма погашения просроченного долга по кредиту[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.pct_due",/>\s*Сумма просроченных процентов по очередному платежу[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,
parseBalance),getParam(b,a,"credits.peni_debt",/>\s*Неустойка за основной долг[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.peni_pct",/>\s*Неустойка за проценты[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.other_payments",/>\s*Иные платежи[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay",/>\s*Всего к погашению в очередной платеж[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseBalance),getParam(b,a,"credits.min_pay_till",/>\s*Срок очередного платежа[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate))}
function processCreditTransactions(b,c,a){if(AnyBalance.isAvailable("credits.transactions"))if(b=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,T:"RT_2IC.view",CUSTOMVIEW:1,PAR_IDRS:c,SCHEMENAME:"CREDITPAY",IDR:c,FORMACTION:"VIEW",PERIODPRN:"undefined"},addHeaders({Referer:g_baseurl})),(c=getElement(b,/<TABLE[^>]+class="SCrollTBL"[^>]*>/i))&&(c=getElement(c,/<TBODY[^>]*>/i)),c)for(a.transactions=[],b=getElements(c,/<tr[^>]*>/ig),c=0;c<b.length;++c){var d=b[c];if(/Итого|Плановые платежи/i.test(d))break;
if(!/Фактические платежи/i.test(d)){var e={};getParam(d,e,"credits.transactions.date",/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate);getParam(d,e,"credits.transactions.sum",/(?:[\s\S]*?<td[^>]*>){2}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(d,e,"credits.transactions.sum_pct",/(?:[\s\S]*?<td[^>]*>){3}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(d,e,"credits.transactions.sum_debt",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,
parseBalance);getParam(d,e,"credits.transactions.sum_other",/(?:[\s\S]*?<td[^>]*>){5}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(d,e,"credits.transactions.debt",/(?:[\s\S]*?<td[^>]*>){6}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);a.transactions.push(e)}}else AnyBalance.trace("Не удалось найти таблицу платежей по кредиту\n"+b)}function n2(b){return 10>b?"0"+b:""+b}
function getColsAccountTransactions(b){var c={};b=getElements(b,/<th\b[^>]*>/ig);for(var a=0;a<b.length;++a){var d=getParam(b[a],null,null,null,replaceTagsAndSpaces);/Дата/i.test(d)?c.date=a:/Номер операции/i.test(d)?c.opnum=a:/Сумма/i.test(d)?c.sum=a:/Корреспондирующий счет/i.test(d)?c.corrnum=a:/Наименование корреспондента/i.test(d)?c.corrname=a:/Назначение платежа/i.test(d)&&(c.descr=a)}return c}
function processAccountTransactions(b,c){if(AnyBalance.isAvailable("accounts.transactions")){var a=new Date,d=new Date(a.getFullYear()-1,a.getMonth(),a.getDate()+1);do{var e=AnyBalance.requestPost(g_baseurl,{SID:b.SID,tic:1,BDate:d.getFullYear()+"-"+n2(d.getMonth()+1)+"-"+n2(d.getDate()),EDate:a.getFullYear()+"-"+n2(a.getMonth()+1)+"-"+n2(a.getDate()),T:"RT_2IC.view",Accounts:c.__id,CUSTOMVIEW:1,PERIOD:3,SCHEMENAME:"STM",FORMACTION:"view",PulfAccess:"",ShowStatRecDoc:"0"},addHeaders({Referer:g_baseurl})),
f=getElement(e,/<table[^>]+id="SCROLLER"[^>]*>/i);if(!f){var g=getParam(e,null,null,/<BSS_ERROR>([\s\S]*?)<\/BSS_ERROR>/i,replaceTagsAndSpaces);if(g&&(AnyBalance.trace("Не получили транзакции с ошибкой: "+g),g=getParam(g,null,null,/Выписка будет доступна через\s*(\d+)\s*сек/i,null,parseBalance))){AnyBalance.trace("Ждем "+g+" сек...");sleep(1E3*g);continue}}if(!f){AnyBalance.trace("Похоже, транзакций по счету "+c.__id+" нет...\n"+e);return}break}while(1);a=getElements(f,/<(?:thead|tbody)[^>]*>/ig);
if(!/<thead/i.test(""+a[0]))throw AnyBalance.trace(e),new AnyBalance.Error("Не удаётся найти заголовок таблицы транзакций счета. Сайт изменен?");if(!/<tbody/i.test(""+a[1]))throw AnyBalance.trace(e),new AnyBalance.Error("Не удаётся найти тело таблицы транзакций счета. Сайт изменен?");c.transactions=[];e=getColsAccountTransactions(a[0]);a=getElements(a[1],/<tr[^>]*>/ig);for(d=0;d<a.length;++d)f=a[d],/colspan/i.test(f)||(f=getElements(f,/<td[^>]*>/ig),g={},isset(e.date)&&getParam(f[e.date],g,"accounts.transactions.date",
null,replaceTagsAndSpaces,parseDate),isset(e.sum)&&getParam(f[e.sum],g,"accounts.transactions.sum",null,replaceTagsAndSpaces,parseBalance),isset(e.opnum)&&getParam(f[e.opnum],g,"credits.transactions.opnum",null,replaceTagsAndSpaces),isset(e.corrnum)&&getParam(f[e.corrnum],g,"credits.transactions.corrnum",null,replaceTagsAndSpaces),isset(e.corrname)&&getParam(f[e.corrname],g,"credits.transactions.corrname",null,replaceTagsAndSpaces),isset(e.descr)&&getParam(f[e.descr],g,"credits.transactions.descr",
null,replaceTagsAndSpaces),c.transactions.push(g))}};
