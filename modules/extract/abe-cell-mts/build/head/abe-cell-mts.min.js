var region_aliases={eao:"primorye",dv:"primorye"},regionsOrdinary={auto:"https://ihelper.mts.ru/selfcare/",center:"https://ihelper.mts.ru/selfcare/",primorye:"https://ihelper.dv.mts.ru/selfcare/",nnov:"https://ihelper.nnov.mts.ru/selfcare/",nw:"https://ihelper.nw.mts.ru/selfcare/",sib:"https://ihelper.sib.mts.ru/selfcare/",ural:"https://ihelper.nnov.mts.ru/selfcare/",ug:"https://ihelper.ug.mts.ru/selfcare/"},g_baseurl="https://lk.ssl.mts.ru",g_baseurlLogin="https://login.mts.ru",g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
"Accept-Language":"ru,en;q=0.8","Cache-Control":"max-age=0","User-Agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/43.0.2357.124 Safari/537.36","If-Modified-Since":null},replaceNumber=[replaceTagsAndSpaces,/\D/g,"",/.*(\d\d\d)(\d\d\d)(\d\d)(\d\d)$/,"+7 $1 $2-$3-$4"];function getParamByName(a,b){return getParam(a,null,null,new RegExp("name=[\"']"+b+'["\'][^>]*value=["\']([^"\']+)"',"i"))}
function isInOrdinary(a){return/<div[^>]+class="main-menu"/i.test(a)}function uniq_fast(a){for(var b={},c=[],d=a.length,e=0,g=0;g<d;g++){var f=a[g];1!==b[f]&&(b[f]=1,c[e++]=f)}return c}function setCsrfCookie(a,b){var c=getParam(b,null,null,/<input[^>]+name="csrfToken"[^>]*value="([^"]*)/i),d=getParam(a,null,null,/\/\/(.*?)\//);AnyBalance.setCookie(d,"csrfToken",null);AnyBalance.setCookie(d,"csrfToken",null);AnyBalance.setCookie(d,"csrfToken",c)}
function fetchOrdinary(a,b,c){var d=AnyBalance.getPreferences();if(d.phone&&d.phone!=d.login){AnyBalance.trace("Требуется другой номер. Пытаемся переключиться...");a=AnyBalance.requestGet(b+"my-phone-numbers.aspx",g_headers);var e=uniq_fast(sumParam(a,null,null,/__doPostBack\('ctl00\$MainContent\$pagerLink','(\d+)'/g));AnyBalance.trace(e.length+" ещё страниц моих номеров найдено");do{setCsrfCookie(b,a);var g=getParam(a,null,null,/<input[^>]+name="csrfToken"[^>]*value="([^"]*)/i),f=(d.phone||"").replace(/(\d{3})(\d{3})(\d{2})(\d{2})/i,
"$1\\D$2\\D$3\\D$4");if((new RegExp('"account-phone-number current"[^>]*>\\s*\\+7\\s*'+f,"i")).test(a))AnyBalance.trace("Номер "+d.phone+" уже выбран.");else{if(!(new RegExp("doPostBack\\('[^']+','7"+d.phone,"i")).test(a))if(0<e.length){f=e.shift();AnyBalance.trace(d.phone+": этот номер не принадлежит логину "+d.login+". Попробуем другую страницу - "+f);a=AnyBalance.requestPost(b+"my-phone-numbers.aspx",[["ctl00_sm_HiddenField",""],["csrfToken",g],["__EVENTTARGET","ctl00$MainContent$pagerLink"],["__EVENTARGUMENT",
f],["__VIEWSTATE",getParamByName(a,"__VIEWSTATE")],["__VIEWSTATEGENERATOR",getParamByName(a,"__VIEWSTATEGENERATOR")]],addHeaders({Referer:b+"my-phone-numbers.aspx",Origin:"https://ihelper.mts.ru"}));continue}else throw new AnyBalance.Error(d.phone+": этот номер не принадлежит логину "+d.login);a=AnyBalance.requestPost(b+"my-phone-numbers.aspx",[["ctl00_sm_HiddenField",""],["csrfToken",g],["__EVENTTARGET","ctl00$MainContent$transitionLink"],["__EVENTARGUMENT","7"+d.phone],["__VIEWSTATE",getParamByName(a,
"__VIEWSTATE")],["__VIEWSTATEGENERATOR",getParamByName(a,"__VIEWSTATEGENERATOR")]],addHeaders({Referer:b+"my-phone-numbers.aspx",Origin:"https://ihelper.mts.ru"}));if(!(new RegExp("<li>\\s*Номер:\\s*<strong>\\+7\\s*"+f,"i")).test(a))throw new AnyBalance.Error("Не удалось переключиться на номер "+d.phone+". Вероятно, он не принадлежит логину "+d.login);}break}while(1)}getParam(a,c,"tariff",/Тарифный план.*?>([^<]*)/i,replaceTagsAndSpaces);getParam(a,c,"balance",/<span[^>]*id="customer-info-balance[^>]*>([\s\S]*?)(?:\(|<\/span>)/i,
replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("info.phone")&&(c.info||(c.info={}),getParam(a,c.info,"info.phone",/Номер:.*?>([^<]*)</i,replaceNumber));AnyBalance.isAvailable("bonus")&&!isset(c.bonus)&&(c.bonus=null);isAvailableStatus()&&(AnyBalance.trace("Fetching status..."),/<h1>Состояние счета<\/h1>/i.test(a)||(AnyBalance.trace('Не нашли заголовка "состояние счета". Заходим на account-status.aspx'),a=AnyBalance.requestGet(b+"account-status.aspx",g_headers)),fetchAccountStatus(a,c));
AnyBalance.isAvailable("remainders.tourist")&&(AnyBalance.trace("Fetching accumulated counters..."),a=AnyBalance.requestGet(b+"accumulated-counters.aspx",g_headers),fetchAccumulatedCounters(a,c));AnyBalance.isAvailable("abonservice","info.date_start")&&(AnyBalance.trace("Fetching paid services..."),checkIHError(a,c),a=AnyBalance.requestGet(b+"product-2-view.aspx",g_headers),sumParam(a,c,"abonservice",/<tr[^>]+class="gm-row-item(?:[\s\S](?!<\/tr>))*?<td[^>]+class="price"[^>]*>([\s\S]*?)<\/td>/ig,replaceTagsAndSpaces,
parseBalance,aggregate_sum),AnyBalance.isAvailable("info.date_start")&&(c.info||(c.info={}),sumParam(a,c.info,"info.date_start",/<tr[^>]+class="gm-row-item(?:[\s\S](?!<\/tr>))*?<td[^>]+class="grid-date"[^>]*>([\s\S]*?)<\/td>/ig,replaceTagsAndSpaces,parseDate,aggregate_min)));AnyBalance.isAvailable("expenses")&&processExpences(b,c);AnyBalance.isAvailable("payments")&&processPayments(b,c);AnyBalance.isAvailable("detalization")&&processDetalization(b,c)}
function checkIHError(a,b,c){if((a=getParam(a,null,null,/<div[^>]+class="b_(?:-page)error"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))||c){c="Ошибка МТС при получения данных из интернет-помощника: "+(a||"вероятно, он временно недоступен");if(!0===b)throw new AnyBalance.Error(c);AnyBalance.trace(c);b.were_errors=!0}}function isAvailableStatus(){return AnyBalance.isAvailable("remainders","info.licschet","info.sim","statuslock","credit","usedinthismonth","bonus_balance","debt","pay_till")}
function isAvailableIH(){return isAvailableStatus()||AnyBalance.isAvailable("tourist","abonservice","info.date_start","expenses","payments","detalization")||isAvailable("tariff")&&!isset(result.tariff)||isAvailable("info.phone")&&(!isset(result.info)||!isset(result.info.phone))}
function fetchAccumulatedCounters(a,b){AnyBalance.trace("Parsing accumulated counters...");checkIHError(a,b);b.remainders||(b.remainders={});getParam(a,b.remainders,"remainders.tourist",/Счетчик Туристическая СИМ-карта от МТС\.[\s\S]*?<td[^>]+class="counter-value"[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}
function fetchAccountStatus(a,b){AnyBalance.trace("Parsing status...");checkIHError(a,b);AnyBalance.isAvailable("remainders")&&(b.remainders||(b.remainders={}),sumParam(a,b.remainders,"remainders.min_till",[/мин\.?,?\s*(?:Пакет\s*)?действует до ([^<]*)/ig,/Остаток пакета минут:[^<]*действует до([^<]*)/ig],replaceTagsAndSpaces,parseDate,aggregate_min),sumParam(a,b.remainders,"remainders.sms_till",/(?:смс|sms)[^<]*[.:,]*\s*(?:Пакет\s*)?действует до ([^<]*)/ig,replaceTagsAndSpaces,parseDate,aggregate_min),
sumParam(a,b.remainders,"remainders.mms_till",/(?:ммс|mms)[^<]*[.:,]*\s*(?:Пакет\s*)?действует до ([^<]*)/ig,replaceTagsAndSpaces,parseDate,aggregate_min),a=sumParam(a,b.remainders,"remainders.min_left_connect",/МТС Connect:\s+остаток\s*([\d\.,]+)[^<]*/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts_rf",/Оста(?:лось|ток):?\s*([\d\.,]+)\s*(?:бесплатных\s*)?мин[^>]+МТС (?:РФ|России)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,
b.remainders,"remainders.min_left_mts_rf",/Оста(?:лось|ток)[^<]+мин[^>]+МТС РФ:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Территория МТС.*?: Осталось\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Оста(?:ток|лось):?\s*([\d\.,]+)\s*мин\S*\s*(?:на\s*)?МТС/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",
/Срочный контракт.*?: Осталось\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток (?:ежесуточного )?пакета минут:\s*([\d\.,]+)\s*[м\.,<]/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток бонуса:\s*([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Пакет минут[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,
parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось:?\s*([\d\.,]+)\s*(?:бесплатных\s*)?мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mts",/Остаток мин[^<]*?([\d\.,]+)\s*мин[^<]*?МТС России/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",
/Остаток мин[^<]*?([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток ежемесячных пакетов\s*(?:минут\s*)?:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток ежемесячного пакета\s*(?:минут\s*)?:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток пакета:?\s*([\d\.,]+)\s*мин/ig,
replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Пакет минут[^:]*:\s*Оста[^\d]*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Подбаланс минуты\s*:?\s*([\d\.,]+)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Остаток пакета минут[^<]*?([\d\.,]+)\s*сек/ig,replaceTagsAndSpaces,function(a){return Math.round(parseBalance(a)/
60)},aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/"Бесплатных вызовов при платеже":[^<]*?([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось минут[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/Осталось по опции[^<]*?:\s*([\d\.,]+)\s+мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",
/местные минуты[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left",/пакет местных минут[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/междугородные минуты[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/Пакет МГ[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,
aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.min_left_mezh",/М2М[^<]*?([\d\.,]+?)\s*мин/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),sumParam(a,b.remainders,"remainders.min_local",/Использовано:?\s*([\d\.,]+)\s*мин[^\s]* (местных|на городские)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_love",/Использовано:?\s*([\d\.,]+)\s*мин[^\s]* на любимые/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_used_mts",
/Использовано:?\s*(\d+)\s*мин\S* на МТС/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),a=sumParam(a,b.remainders,"remainders.sms_left_perezvoni",/Осталось:?\s*([0-5])\s*(?:sms|смс)\.?\s*<[^>]*>/i,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток ежемесячных пакетов\s*:?\s*([\d\.,]+)\s*(?:смс|sms)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток ежемесячного пакета\s*:?\s*([\d\.,]+)\s*(?:смс|sms)/ig,
replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/(?:Осталось|Остаток)(?: пакета)? (?:sms|смс):\s*(\d+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/(?:Осталось|Остаток)[^\d]*(\d+)\s*(?:sms|смс)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Остаток пакета[^<]*?(?:смс|sms):\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,
!0),a=sumParam(a,b.remainders,"remainders.sms_left",/Осталось sms[^<]*?:\s*([\d\.,]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_europe",/Остаток\s+пакета\s+SMS\s+в\s+Европе:([\s\d]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),a=sumParam(a,b.remainders,"remainders.sms_world",/Остаток\s+пакета\s+SMS\s+в\s+поездках\s+по\s+миру:([\s\d]+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum,!0),sumParam(a,b.remainders,"remainders.sms_used",
/Использовано:\s*([\d\.,]+)\s*(?:смс|sms)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.mms_left",/(?:Осталось|Остаток)(?: пакета)? (?:mms|ммс):\s*(\d+)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.mms_left",/(?:Осталось|Остаток)[^\d]*(\d+)\s*(?:mms|ммс)/ig,replaceTagsAndSpaces,parseBalance,aggregate_sum),sumParam(a,b.remainders,"remainders.min_used",/Накоплено\s*([\d\.,]+)\s*мин[^\s]*/g,replaceTagsAndSpaces,parseBalance,
aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_mb",/(?:Осталось|Остаток)[^\d]*(\d+[\.,]?\d* *([kmgкмг][бb]|байт|bytes))/ig,null,parseTraffic,aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_mb",/Подбаланс gprs:[^\d]*(\d+[\.,]?\d*\s*([kmgкмг][бb]|байт|bytes))/ig,null,parseTraffic,aggregate_sum),sumParam(a,b.remainders,"remainders.traffic_left_till",[/Подбаланс gprs:[^<]*?[kmgкмг][бb]\s*до\s*([\s\S]*?)<\//ig,/Остаток GPRS-пакета[^<]*[мm][бb][^<]*действует до([^<]*)/ig],
null,parseDate,aggregate_min),getParam(a,b.remainders,"remainders.bonus_balance",/Остаток бонуса:?\s*([\d\.,]+)\s*р/i,replaceTagsAndSpaces,parseBalance),sumParam(a,b.remainders,"remainders.traffic_used_mb",/Использовано:?\s*(\d+\s*[кkmмгg][бb])/ig,replaceTagsAndSpaces,parseTrafficFromKb,aggregate_sum));AnyBalance.isAvailable("info")&&(b.info||(b.info={}),getParam(a,b.info,"info.licschet",/№([\s\S]*?)[:<]/,replaceTagsAndSpaces),getParam(a,b.info,"info.sim",/Номер SIM-карты:([\s\S]*?)[:<]/,replaceTagsAndSpaces));
getParam(a,b,"debt",/Сумма [^<]*по неоплаченным счетам(?:[\s\S](?!<\/td|<\/p))*?([-\d\.,]+)\s+руб/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"pay_till",/оплатить до\s*([\d\.,\/]+)/i,replaceTagsAndSpaces,parseDate);getParam(a,b,"statuslock",/<(?:p|div)[^>]+class="account-status-lock"[^>]*>([\s\S]*?)<\/(?:p|div)>/i,replaceTagsAndSpaces);getParam(a,b,"credit",/(?:Лимит|Сумма кредитного лимита)[\s\S]*?([-\d\.,]+)\s*\(?руб/i,replaceTagsAndSpaces,parseBalance);getParam(a,b,"usedinthismonth",/Израсходовано [^<]*?(?:<[^>]*>)?([\d\.,]+) \(?руб/i,
replaceTagsAndSpaces,parseBalance)}function isLoggedIn(a){return getParam(a,null,null,/(<meta[^>]*name="lkMonitorCheck")/i)}function getLKJson(a,b){try{return getLKJson2(a)}catch(c){AnyBalance.trace(c.message),AnyBalance.trace("Не удалось найти Json с описанием пользователя первым способом, сайт изменен?")}try{return getLKJson1(a)}catch(c){if(b)throw c;AnyBalance.trace(c.message);AnyBalance.trace("Не удалось найти Json с описанием пользователя двумя способами, сайт изменен?");json={}}return{}}
function getLKJson1(a){a=AnyBalance.requestGet("https://login.mts.ru/profile/header?ref=https%3A//lk.ssl.mts.ru/&scheme=https&style=2015v2",addHeaders({Referer:g_baseurl+"/"}));var b={};b.fio=getElement(a,/<div[^>]+b-header_lk__name[^>]*>/i,replaceTagsAndSpaces);b.phone_formatted=getElement(a,/<div[^>]+b-header_lk__phone[^>]*>/i,replaceTagsAndSpaces);b.phone=replaceAll(b.phone_formatted,[/\+7/,"",/\D/g,""]);b.balance=getElement(a,/<div[^>]+b-header_balance[^>]*>/i,replaceTagsAndSpaces,parseBalance);
b.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! "+a);b.phone||AnyBalance.trace("Не удаётся получить информацию о текущем пользователе. Сайт изменен?\n"+a);return b}
function getLKJson2(a){a=AnyBalance.requestGet("https://oauth.mts.ru/webapi-1.4/customers/@me",addHeaders({"X-Requested-With":"XMLHttpRequest",Authorization:"Bearer sso_1.0_websso_cookie"}));var b=getParam(a,null,null,/^\{[\s\S]*?\}$/i,null,getJson);if(!b){AnyBalance.trace(a);if(a=getParam(a,null,null,/<div[^>]+class="red-status"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(a);throw new AnyBalance.Error("Не удалось найти Json с описанием пользователя, сайт изменен?");
}for(var c={},d=0;d<b.genericRelations.length;d++){var e=b.genericRelations[d];isset(e.target.balance)&&(c.balance=getParam(e.target.balance+"",null,null,null,null,parseBalanceRound));isset(e.target.productResources)&&isset(e.target.productResources[0])&&(c.tariff=e.target.productResources[0].product.name["ru-RU"]);isset(e.target.address)&&(c.phone=e.target.address,c.phone_formatted=replaceAll(c.phone,replaceNumber));isset(e.target.displayNameNat)&&(c.fio=e.target.displayNameNat)}c.balance||AnyBalance.trace("Нулевой баланс! Возможно, что-то не так! "+
a);return c}function isAnotherNumber(){var a=AnyBalance.getPreferences();return a.phone&&a.phone!=a.login}
function checkLoginState(a,b){var c=b&&b.baseurl||g_baseurl,d=AnyBalance.getLastUrl();if(/checkAuthStatus\(\)|дождитесь окончания процесса авторизации/i.test(a)){for(var e={},g=20;"Success"!=e.Data&&0<g--;){e=AnyBalance.requestGet(c+"/WaitAuth/CheckAuth?_="+(new Date).getTime(),addHeaders({Referer:d}));e=getJson(e);"PreSuccess"==e.Data&&(e=AnyBalance.requestGet(c+"/WaitAuth/CompleteAuth?_="+(new Date).getTime(),addHeaders({Referer:d})),e=getJson(e),AnyBalance.trace("Received PreSuccess, called CompleteAuth: "+
JSON.stringify(e)));if("Success"==e.Data)break;sleep(1E3)}if("Success"!=e.Data){AnyBalance.trace("Слишком долго ждали авторизацию: "+JSON.stringify(e));if(b&&b.automatic)return AnyBalance.trace("МТС не пустил нас в ЛК после ожидания авторизации. Ладно, попробуем с логином и паролем войти."),AnyBalance.requestGet(g_baseurlLogin.replace(/\/Login.*/,"/Logout",addHeaders({Referer:c})));throw new AnyBalance.Error("МТС не пустил нас в "+c+" после ожидания авторизации. Это проблема на сайте МТС, как только работа сайта наладится - данные отобразятся.");
}return AnyBalance.requestGet(c,addHeaders({Referer:d}))}return a}
function enterLK(a){var b=AnyBalance.requestGet(g_baseurl,g_headers);500<=AnyBalance.getLastStatusCode()&&(AnyBalance.trace("МТС вернул 500. Пробуем ещё разок..."),b=AnyBalance.requestGet(g_baseurl,g_headers));if(500<=AnyBalance.getLastStatusCode())throw new AnyBalance.Error("Ошибка на сервере МТС, сервер не смог обработать запрос. Можно попытаться позже...");b=checkLoginState(b,{automatic:!0});AnyBalance.trace("isLoggedIn(html) = "+isLoggedIn(b));if(isLoggedIn(b)){var c=function(){var a=AnyBalance.requestGet(g_baseurlLogin+
"/amserver/UI/Logout",g_headers);if(isLoggedIn(a))throw AnyBalance.trace(a),new AnyBalance.Error("Не удаётся выйти из личного кабинета, чтобы зайти под правильным номером. Сайт изменен?");return a};AnyBalance.trace("Уже залогинены, проверяем, что на правильный номер...");var d=getLKJson(b).phone;d?d!=a.login?(AnyBalance.trace("Залогинены на неправильный номер: "+d+", выходим"),b=c()):AnyBalance.trace("Залогинены на правильный номер: "+d):(AnyBalance.trace(b),AnyBalance.trace("Не удалось определить текущий номер в кабинете, сайт изменен? Попробуем выйти и зайти с логином-паролем."),
b=c())}if(!isLoggedIn(b)){if(a.onlyAutomatic)throw new AnyBalance.Error("Ручной вход запрещен");b=enterMTS(joinObjects(a,{html:b,service:"lk",url:AnyBalance.getLastUrl()}));b=checkLoginState(b)}if(!isLoggedIn(b)){if(getParam(b,null,null,/(auth-status=0)/i))throw new AnyBalance.Error("Неверный логин или пароль. Повторите попытку или получите новый пароль на сайте "+g_baseurl+"/.",!1,!0);AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Он изменился или проблемы на сайте.");
}__setLoginSuccessful();return b}function loginWithPassword(){AnyBalance.trace("Entering lk...");var a=AnyBalance.getPreferences();return enterLK({login:a.login,password:a.password})}
function followIHLink(){var a="https://ihelper.mts.ru/selfcare/",b=AnyBalance.getCookie("IHLink");b&&(a=getParam(b,null,null,/[\s\S]*?selfcare\//i,replaceTagsAndSpaces)||"https://ihelper.mts.ru/selfcare/");var b=null,c;try{c=AnyBalance.requestGet(a+"account-status.aspx",addHeaders({Referer:g_baseurl}));var d=AnyBalance.getLastUrl();if(0!=d.indexOf(a)){b=getParam(d,null,null,/ihelper\.([\w\-]+\.)?mts.ru/i,[/\./g,""]);if(!b)throw new AnyBalance.Error("МТС перенаправила на неизвестный регион! "+b);region_aliases[b]&&
(b=region_aliases[b]);if(!regionsOrdinary[b])throw new AnyBalance.Error("МТС перенаправила на неизвестный регион!! "+b);a=regionsOrdinary[b];AnyBalance.trace("Переходим напрямую в помощник "+a);c=AnyBalance.requestGet(a+"account-status.aspx",addHeaders({Referer:g_baseurl}))}if(b=getParam(c,null,null,/<form .*?id="redirect-form".*?action="[^"]*?([^\/\.]+)\.mts\.ru/)){region_aliases[b]&&(b=region_aliases[b]);if(!regionsOrdinary[b])throw new AnyBalance.Error("МТС перенаправила на неизвестный регион: "+
b);a=regionsOrdinary[b];AnyBalance.trace("Redirected, now trying to enter selfcare at address: "+a);c=AnyBalance.requestPost(a+"logon.aspx",{wasRedirected:"1",submit:"Go"},g_headers)}}catch(e){AnyBalance.trace("Не удалось перейти из лк в интернет-помощник: "+e.message)}return{html:c,baseurlHelper:a}}function login(a){AnyBalance.setDefaultCharset("utf-8");var b;if(AnyBalance.getPreferences().password)b=loginWithPassword();else{var c=loginWithoutPassword();b=c.html;a.password=c.password}return b}
function processInfoLK(a,b){if(AnyBalance.isAvailable("balance","info.phone","info.fio"))try{var c=getLKJson(a,!0);AnyBalance.trace(JSON.stringify(c));getParam(c.balance,b,"balance");getParam(c.tariff,b,"tariff");AnyBalance.isAvailable("info")&&(b.info||(b.info={}),getParam(c.phone,b.info,"info.phone",null,replaceNumber),getParam(c.fio,b.info,"info.fio"))}catch(d){AnyBalance.trace("Не удалось получить данные о пользователе, скорее всего, виджет временно недоступен... "+d.message+"\n"+d.stack)}}
function processBonusLK(a){try{if(AnyBalance.isAvailable("bonus")){info=AnyBalance.requestGet("https://bonus.ssl.mts.ru/api/user/part/Status",addHeaders({Referer:"https://bonus.ssl.mts.ru/","X-Requested-With":"XMLHttpRequest"}));var b=getJson(info);"registered"!=b.status?AnyBalance.trace("Бонус не может быть получен: "+info):(info=AnyBalance.requestGet("https://bonus.ssl.mts.ru/api/user/part/Points",addHeaders({Referer:"https://bonus.ssl.mts.ru/","X-Requested-With":"XMLHttpRequest"})),b=getJson(info),
getParam(b.points,a,"bonus"))}}catch(c){AnyBalance.trace("Не удалось получить данные о бонусах... "+c.message+"\n"+c.stack)}}function processTraffic(a){try{AnyBalance.trace("Пробуем получить трафик из интернет-кабинета");processTrafficInternet(a);return}catch(b){AnyBalance.trace("Не удалось получить трафик из интернет-кабинета: "+b.message+"\n"+b.stack)}a.were_errors=!0}function parseTrafficFromKb(a){return parseTraffic(a,"kb")}
function processTrafficInternet(a){if(isAvailable("remainders.traffic_left_mb","remainders.traffic_used_mb","remainders.traffic_left_till")){var b=function(a,b){var c=0;b&&a.muia&&(c=0<a.muia.personalQuota?a.muia.personalQuota:a.muia.sharedQuotaSize);if(a.limits)for(var d=0;d<a.limits.length;d++)var e=a.limits[d].floor>a.limits[d].ceiling||isNaN(a.limits[d].ceiling)?a.limits[d].floor:a.limits[d].ceiling,c=c<e?e:c;else c="Infinity";d=b&&a.muia?c-a.muia.quantumRemaining-a.muia.quotaRemaining:0;return{quota:c,
unavailable:d,consumed:a.value,available:c-d-a.value}},c=function(a,b){return a||b.isActive},d=AnyBalance.requestGet("https://internet.mts.ru/",addHeaders({Referer:g_baseurl})),d=checkLoginState(d,{baseurl:"https://internet.mts.ru"}),d=AnyBalance.requestGet("https://internet.mts.ru/sitesettings/H2OProfile.js",addHeaders({Referer:"https://internet.mts.ru/"})),d=getJsonObject(d,/_profile:(?=\s*\{)/i);AnyBalance.trace("H2O profile: "+JSON.stringify(d));a.remainders||(a.remainders={});a=a.remainders;
var e="undefined"!=typeof d.h2O.p.muia&&d.h2O.p.muia.acceptor,g=d.personalTrafficExtended,f=d.personalOptionExtended;g?(AnyBalance.trace("найден валидный трафик"),!e&&(f.autoProlongations&&f.autoProlongations.reduce(c,!1)||f.extraPackages&&f.extraPackages.reduce(c,!1))?(sumParam(""+g.consumed,a,"remainders.traffic_used_mb",null,null,parseTrafficFromKb,aggregate_sum),sumParam(""+(g.consumed>f.quotas.baseQuota?0:f.quotas.baseQuota-g.consumed),a,"remainders.traffic_left_mb",null,null,parseTrafficFromKb,
aggregate_sum)):(sumParam(g.available+"",a,"remainders.traffic_left_mb",null,null,parseTrafficFromKb,aggregate_sum),sumParam(g.consumed+"",a,"remainders.traffic_used_mb",null,null,parseTrafficFromKb,aggregate_sum))):d.personalTrafficItem?(b=b(d.personalTrafficItem,e),AnyBalance.trace("найден невалидный трафик "+JSON.stringify(b)),sumParam(b.available+"",a,"remainders.traffic_left_mb",null,null,parseTrafficFromKb,aggregate_sum),sumParam(b.consumed+"",a,"remainders.traffic_used_mb",null,null,parseTrafficFromKb,
aggregate_sum)):AnyBalance.trace("Трафик не найден: "+JSON.stringify(d));d.personalTrafficItem&&getParam(d.personalTrafficItem.expirationTime,a,"remainders.traffic_left_till",null,null,parseDateISO)}}
function processTrafficLK(a){if(isAvailable("remainders.traffic_left_mb","remainders.traffic_used_mb","remainders.traffic_left_till")){a.remainders||(a.remainders={});a=a.remainders;AnyBalance.trace("Запросим трафик...");for(var b=0;3>b;b++){AnyBalance.trace("Пробуем получить трафик, попытка: "+(b+1));var c=AnyBalance.requestGet(g_baseurl,addHeaders({Referer:g_baseurl})),c=getParam(c,null,null,/myInternet.diagram\s*=\s*(\{[\s\S]*?\});/i,null,getJsonEval).widgetDataUrl;if(!c)throw new AnyBalance.Error("Не удалось найти ссылку на трафик.");
info=AnyBalance.requestGet(g_baseurl+c+"&_="+(new Date).getTime(),addHeaders({"X-Requested-With":"XMLHttpRequest",Accept:"*/*",Referer:g_baseurl+"/"}));AnyBalance.trace(info);if(info){c=getJson(info);if("null"!=c.OptionName&&isset(c.OptionName)){AnyBalance.trace("Нашли трафик...");sumParam(c.TrafficLeft+"",a,"remainders.traffic_left_mb",null,null,parseTrafficFromKb,aggregate_sum);sumParam(c.TrafficConsumed+"",a,"remainders.traffic_used_mb",null,null,parseTrafficFromKb,aggregate_sum);getParam(c.PackageUpdated+
"",a,"remainders.traffic_left_till",null,null,parseDateISO);return}AnyBalance.trace("Трафика нет...")}else AnyBalance.trace("Сервер вернул ерунду, пробуем еще раз...")}throw new AnyBalance.Error("Трафик не найден!");}}
function mainLK(a,b){AnyBalance.trace("Мы в личном кабинете...");isAnotherNumber()?AnyBalance.trace("Пропускаем получение данных из ЛК, если требуется информация по другому номеру"):(processInfoLK(a,b),processBonusLK(b),processTraffic(b));try{if(isAnotherNumber()||isAvailableIH()){var c=followIHLink();a=c.html;isInOrdinary(a)||checkIHError(a,!0,!0);fetchOrdinary(a,c.baseurlHelper,b)}}catch(d){if(isAnotherNumber())throw d;AnyBalance.trace("Не удалось получить данные из ип: "+d.message+"\n"+d.stack);
b.were_errors=!0}}function sleep(a){AnyBalance.trace("Sleeping "+a+" ms");AnyBalance.sleep(a)}function parseBalanceRound(a){a=parseBalance(a);isset(a)&&(a=Math.round(100*a)/100);return a}
function loginWithoutPassword(){AnyBalance.trace("Entering lk without password...");var a=AnyBalance.getPreferences();checkEmpty(!a.password||/^\w{6,26}$/.test(a.password),"Желаемый пароль должен содержать от 6 до 26 символов");a.password&&checkEmpty(/^[a-zA-Z0-9]+$/.test(a.password)&&/[a-z]/.test(a.password)&&/[A-Z]/.test(a.password)&&/[0-9]/.test(a.password),"Желаемый пароль должен состоять только из латинских букв и цифр и должен содержать хотя бы одну строчную букву, заглавную букву и цифру");
var b={};b.login=a.login;var c,d;try{c=enterLK({login:a.login,onlyAutomatic:!0}),a.password||(d=generatePassword()),(a.password||d)&&changePassword(void 0,a.password||d)}catch(e){AnyBalance.trace("Автоматический вход в кабинет не удался. Пробуем получить пароль через СМС"),d=getPasswordBySMS(a.login),c=enterLK({login:a.login,password:d}),a.password&&a.password!=d&&changePassword(d,a.password)}b.password=a.password||d;b.html=c;return b}
function initialize(){var a=loginWithoutPassword(),b={success:!0,__initialization:!0};b.login=prefs.login;b.password=a.password;AnyBalance.setResult(b)}
function getPasswordBySMS(a){var b=g_baseurlLogin+"/amserver/UI/Login?service=smspassword&srcsvc=lk&goto=http%3A%2F%2Flk.ssl.mts.ru%2F",c=AnyBalance.requestGet(b,g_headers),d=getParam(c,null,null,/<img[^>]+id="kaptchaImage"[^>]*src="data:image\/\w+;base64,([^"]+)/i,replaceHtmlEntities),e=AnyBalance.retrieveCode("Для получения пароля к личному кабинету по SMS символы, которые вы видите на картинке.",d,{time:3E5}),c=getParam(c,null,null,/<form[^>]+name="Login"[^>]*>([\s\S]*?)<\/form>/i),c=createFormParams(c,
function(b,c,d,h){"IDToken1"==d&&(h=a);"IDToken2"==d&&(h=e);return h}),c=AnyBalance.requestPost(b,c,addHeaders({Referer:b}));if(b=getParam(c,null,null,/var\s+passwordErr\s*=\s*'([^']*)/,replaceSlashes))throw new AnyBalance.Error(b);return AnyBalance.retrieveCode("На номер "+a+' выслан пароль к личному кабинету МТС. Введите его в поле ниже. \x3c!--#instruction:{"sms":{"number_in":"3339","regexp_in":"Пароль:\\s*(\\w+)"}}#--\x3e',null,{time:3E5})}
function changePassword(a,b){var c=g_baseurlLogin+"/amserver/UI/Login?service=changepassword2014&ForceAuth=true",d=AnyBalance.requestGet(c,g_headers),e=getParam(d,null,null,/<form[^>]+name="Login"[^>]*>[\s\S]*?<\/form>/i);if(!e)throw AnyBalance.trace(d),new AnyBalance.Error("Не удалось найти форму смены пароля. Сайт изменен?");d=createFormParams(e,function(c,d,e,h){"IDToken1"==e&&(h=a);if("IDToken2"==e||"IDToken3"==e)h=b;return h});d=AnyBalance.requestPost(c,d,addHeaders({Referer:c}));c=AnyBalance.getLastUrl();
AnyBalance.trace("Password change resulted in: "+c);if(!/#pass_changed|https:\/\/lk\.ssl\.mts\.ru/i.test(c)){if(c=sumParam(d,null,null,/var\s+(?:old|new|con)passwordErr\s*=\s*'([^']*)/,replaceSlashes,null,aggregate_join))throw new AnyBalance.Error(c);AnyBalance.trace(d);throw new AnyBalance.Error("Не удалось сменить пароль на желаемый. Сайт изменен?");}return b}
function generatePassword(){for(var a=String.fromCharCode("A".charCodeAt()+Math.floor(26*Math.random())),a=a+String.fromCharCode("0".charCodeAt()+Math.floor(10*Math.random())),b=0;4>b;++b)a+=String.fromCharCode("a".charCodeAt()+Math.floor(26*Math.random()));return a}
function processPayments(a,b){try{AnyBalance.trace("Получаем платежи...");var c=AnyBalance.requestGet(a+"payment-full-history.aspx",g_headers);checkIHError(c,!0);var d=getElement(c,/<form[^>]+aspnetForm[^>]*>/i),e=new Date,g=new Date(e.getFullYear()-1,e.getMonth(),e.getDate()),f=createFormParams(d,function(a,b,c,d){return/from$/i.test(c)?fmtDate(g):/to$/i.test(c)?fmtDate(e):d});setCsrfCookie(a,c);c=AnyBalance.requestPost(a+"payment-full-history.aspx",f,addHeaders({Referer:AnyBalance.getLastUrl()}));
checkIHError(c,!0);var k=getElement(c,/<div[^>]+paymentsGridium[^>]*>/i);if(!k){var h=getElement(c,/<div[^>]+panelMessage[^>]*>/i,replaceTagsAndSpaces,html_entity_decode);if(h&&/платежей не было/i.test(h)){AnyBalance.trace(h);b.payments=[];return}AnyBalance.trace(c);throw new AnyBalance.Error("Не найдена таблица платежей. Сайт изменен?");}k=replaceAll(k,[/<tfoot[^>]*>[\s\S]*?<\/tfoot>/i,""]);b.payments=[];processTable(k,b.payments,"payments.",{date:{re:/Дата/i,result_func:parseDate},sum:{re:/Сумма/i},
descr:{re:/Тип платежа/i,result_func:html_entity_decode}})}catch(l){AnyBalance.trace("Не удалось получить платежи: "+l.message+"\nStack: "+l.stack)}};
