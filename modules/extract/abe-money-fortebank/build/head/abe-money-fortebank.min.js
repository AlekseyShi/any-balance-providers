var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://mybank.fortebank.com/";
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"retail/Folder/",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");if(/retail\/exit\.aspx/i.test(a))AnyBalance.trace("Уже залогинены, используем существующую сессию");
else{/SessionClose/i.test(a)&&(a=AnyBalance.requestGet(baseurl+"retail/",g_headers));var b=createFormParams(a,function(b,f,d,e){return"tbLogin"==d?c.login:"tbPassword"==d?c.password:"tbLoginImg"==d?(b=getParam(a,null,null,/Captcha\/JpegImage\.aspx[^"]+/i,replaceTagsAndSpaces))?(b=AnyBalance.requestGet(baseurl+"retail/"+b,addHeaders({Referer:baseurl})),AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",b,{time:18E4})):"":e});b.loginType="textLogin";a=AnyBalance.requestPost(baseurl+"retail/",
b,addHeaders({Referer:baseurl+"retail/"}))}if(!/retail\/exit\.aspx/i.test(a)){if(b=getParam(a,null,null,/<div[^>]+id="errMessage"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(b,null,/Проверьте правильность указания Логина и Пароля/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}__setLoginSuccessful();return a}
function processCards(c,a){if(AnyBalance.isAvailable("cards")){c=AnyBalance.requestGet(baseurl+"retail/Folder/Default.aspx?fld=CardAccount",g_headers);var b=getParam(c,null,null,/<table[^>]* class="prodlist"[^>]*>[^]*?<\/table>/i);if(b=c){b=sumParam(b,null,null,/<a\s+href="\?fld=CardInfo&id=[^"]+">[\s\S]*?<\/a>/ig);AnyBalance.trace("Найдено карт: "+b.length);a.cards=[];for(var g=0;g<b.length;++g){var f=b[g],d=getParam(f,null,null,/CardInfo&id=([^"]+)/i,replaceTagsAndSpaces),e=getParam(f,null,null,
/>([\s\S]*?)<\/a>/i,replaceTagsAndSpaces),d={__id:d,__name:e};__shouldProcess("cards",d)&&processCard(f,d);a.cards.push(d)}}else/У вас нет карт/i.test(c)?(AnyBalance.trace("У вас нет карт"),a.cards=[]):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с картами."))}}
function processCard(c,a){AnyBalance.trace("Обработка карты "+a.__name);var b=AnyBalance.requestGet(baseurl+"retail/Folder/Default.aspx?fld=CardInfo&id="+a.__id,g_headers);getParam(b,a,"cards.balance",/Доступный баланс:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.limit",/Кредитный лимит:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,["cards.currency","cards"],/Валюта карточного счета:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces);getParam(b,a,
"cards.num",/Номер карточного счета:(?:[^>]*>){5}([^<]+)/i,replaceTagsAndSpaces);getParam(b,a,"cards.status",/Состояние карты:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces);getParam(b,a,"cards.till",/Срок действия:(?:[^>]*>){4}([^<]+)/i,replaceTagsAndSpaces,parseDateWord);getParam(b,a,"cards.owner",/\d+[*]+\d{4}\s*,([^<]+)/i,replaceTagsAndSpaces);isAvailable("cards.transactions")&&processCardTransactions(b,a)}
function processAccounts(c,a){if(AnyBalance.isAvailable("accounts")){c=AnyBalance.requestGet(baseurl+"secure/accounts.aspx",g_headers);var b=getParam(c,null,null,/var\s+accountdata\s*=\s*(\[[^\]]+\])/i,null,getJson);if(b.length){AnyBalance.trace("Найдено счетов: "+b.length);a.accounts=[];for(var g=0;g<b.length;++g){var f=b[g],d=f.benefacc,d={__id:d,__name:f.acctype+" "+d+" "+f.curr,num:f.acc};__shouldProcess("accounts",d)&&processAccount(f,d);a.accounts.push(d)}}else/У вас нет счетов/i.test(c)?(AnyBalance.trace("У вас нет счетов"),
a.accounts=[]):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу со счетами."))}}
function processAccount(c,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(c.acctype,a,"accounts.type");getParam(c.balance,a,"accounts.balance",null,null,parseBalance);getParam(c.currency,a,["accounts.currency","accounts.balance"],null,null,parseCurrency);getParam(c.date,a,"accounts.date_start",null,null,parseDateWord);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(html,a)}
function processDeposits(c,a){if(AnyBalance.isAvailable("deposits")){c=AnyBalance.requestGet(baseurl+"secure/deps.aspx",g_headers);var b=getParam(c,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(b){b=sumParam(b,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено депозитов: "+b.length);a.deposits=[];var g=getParam(c,null,null,/var\s+depdata\s*=\s*(\[{[\s\S]*?}\])\s*;/i);g&&(g=getJson(g));for(var f=0;f<b.length;++f){var d=b[f],e=getParam(d,null,null,/class="txt"[^>]*>\s*([^<]+)/i,
replaceTagsAndSpaces),h=g[f].ac,k=getParam(d,null,null,/class="txt"(?:[^>]*>){5}\s*([^<]+)/i,replaceTagsAndSpaces),e={__id:e,__name:k,num:h};__shouldProcess("deposits",e)&&processDeposit(d,e,g[f]);a.deposits.push(e)}}else/У вас нет депозитов/i.test(c)?(AnyBalance.trace("У вас нет депозитов"),a.deposits=[]):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицу с депозитами."))}}
function processDeposit(c,a,b){AnyBalance.trace("Обработка депозита "+a.__name);getParam(c,a,"deposits.status",/<td[^>]*CurrentStatus[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(b.db,a,"deposits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(b.db,a,["deposits.currency","deposits.balance"],null,replaceTagsAndSpaces,parseCurrency);getParam(b.dr,a,"deposits.pct",null,replaceTagsAndSpaces,parseBalance);getParam(b.ddd,a,"deposits.period",null,replaceTagsAndSpaces);getParam(b.od,a,
"deposits.date_start",null,replaceTagsAndSpaces,parseDateWord);getParam(b.de,a,"deposits.date_end",null,replaceTagsAndSpaces,parseDateWord);getParam(b.cap,a,"deposits.pct_condition");getParam(b.unitcode,a,"deposits.pct_period");getParam(b.dmil,a,"deposits.balance_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(b.dmsi,a,"deposits.topup_min",null,[replaceTagsAndSpaces,/-|любая/i,0],parseBalance);getParam(b.dmal,a,"deposits.balance_max",null,replaceTagsAndSpaces,parseBalance);isAvailable("deposits.transactions")&&
processDepositTransactions(c,a)}
function processCredits(c,a){if(AnyBalance.isAvailable("credits")){c=AnyBalance.requestGet(baseurl+"secure/credits.aspx",g_headers);var b=getParam(c,null,null,/<table[^>]*class="prodlist"[^>]*>[^]*?<\/table>/i);if(!b)if(/У Вас нет кредитов/i.test(c))AnyBalance.trace("Нет ни одного кредита."),a.credits=[];else{AnyBalance.trace(c);AnyBalance.trace("Не удалось найти таблицу с кредитами.");return}b=sumParam(b,null,null,/<tr[^>]*>\s*<td[^>]*>[^]*?<\/tr>/ig);AnyBalance.trace("Найдено кредитов: "+b.length);
a.credits=[];for(var g=getParam(c,null,null,/var\s+creditDetailsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),f=getParam(c,null,null,/var\s+creditHistoryData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),d=getParam(c,null,null,/var\s+creditFuturePaymentsData\s*=\s*(\[{[\s\S]*?}\])/i,null,getJson),e=0;e<b.length;++e){var h=getParam(b[e],null,null,/class="txt"[^>]*>\s*([^<]+)/i,replaceTagsAndSpaces),k=getParam(b[e],null,null,/class="txt"(?:[^>]*>){6}\s*([^<]+)/i,replaceTagsAndSpaces),l=getParam(g[e].dt,null,
null,/Лицевой счет №:([^]*?)<\/li>/i,replaceTagsAndSpaces),h={__id:h,__name:k,num:l};__shouldProcess("credits",h)&&(processCredit(b[e],h,g[e]),AnyBalance.isAvailable("credits.transactions")&&processCreditTransactions(f[e],h),AnyBalance.isAvailable("credits.schedule")&&processCreditSchedule(d[e],h));a.credits.push(h)}}}function parseBool(c){return!/нет/i.test(c)}
function processCredit(c,a,b){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b.dt,a,"credits.limit",/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,["credits.currency","credits.balance","credits.minpay","credits.limit"],/Общая сумма кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseCurrency);getParam(b.dt,a,"credits.minpay",/Сумма ближайшего платежа:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.minpaydate",/Дата ближайшего платежа:([^]*?)<\/li>/i,
replaceTagsAndSpaces,parseDateWord);getParam(b.dt,a,"credits.penalty",/Просроченная задолженность по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.pct",/Текущая процентная ставка по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.date_start",/Дата выдачи:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseDateWord);getParam(b.dt,a,"credits.date_end",/Дата финального погашения:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseDateWord);getParam(b.dt,
a,"credits.period",/Срок кредита:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.balance",/Текущая сумма долга по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.sum_close",/Сумма[^<]*под закрытие договора[^<]*:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBalance);getParam(b.dt,a,"credits.noclose",/Мораторий на погашение по кредиту:([^]*?)<\/li>/i,replaceTagsAndSpaces,parseBool);AnyBalance.isAvailable("credits.transactions")&&processCreditTransactions(c,
a);AnyBalance.isAvailable("credits.schedule")&&processCreditSchedule(c,a)}
function processInfo(c,a){c=AnyBalance.requestGet(baseurl+"secure/InformingSettings/OperationsInSystem.aspx",g_headers);var b=a.info={};getParam(c,b,"info.fio",/<div[^>]+id="statfio"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c,b,"info.mphone",/<input[^>]+name="[^"]*txtMobileNumber"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(c,b,"info.email",/<input[^>]+name="[^"]*txtNotificationEmail"[^>]*value="([^"]*)/i,replaceHtmlEntities)};
