var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1; WOW64; rv:35.0) Gecko/20100101 Firefox/35.0"},baseurl="https://online.rsb.ru/hb/faces/";
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var a=getProductsJson();if(a)AnyBalance.trace("Используем существующую сессию...");else{b=AnyBalance.requestPost(baseurl+"security_check",{j_username:b.login,j_password:b.password,systemid:"hb"},g_headers);(a=getParam(b,null,null,/window.location\s*=\s*"faces\/([^"]*)/i,replaceSlashes))&&(b=AnyBalance.requestGet(baseurl+a,g_headers));if(!/<div[^>]+class="b-login"[^>]*>/i.test(b))for(;/Ввод пароля из SMS-сообщения/i.test(b);){var a=
getParam(b,null,null,/<div[^>]+class="b-errors-message"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),c=getParam(b,null,null,/<label[^>]+for="temp_pass"[^>]*>([\s\S]*?)<\/label>/i,replaceTagsAndSpaces),c=a?a+"\n\n"+c:c+"\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.",b=getParam(b,null,null,/<form[^>]+action="[^"]*sms.jsp[\s\S]*?<\/form>/i);if(!b)throw new AnyBalance.Error("Не удаётся найти форму ввода одноразового смс кода на вход.\n\nДля пользования провайдером удобно отключить одноразовый пароль на вход в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");
b=createFormParams(b,function(a,b,f,g){if(/submit_by_enth?er/i.test(b))return AnyBalance.retrieveCode(c,null,{time:3E5,inputType:"number"});if(/type="submit"/i.test(b))/&#1042;&#1086;&#1081;&#1090;&#1080;/.test(b)&&(a.source=f);else return g});b=AnyBalance.requestPost(baseurl+"system/login/sms/sms.jsp",b)}if(!/<div[^>]+class="b-login"[^>]*>/i.test(b)){if(a=getParam(b,null,null,/window.location\s*=\s*"([^"]*)/i,replaceSlashes))AnyBalance.trace("Переходим на "+a),b=AnyBalance.requestGet(joinUrl(baseurl,
a));if(/Ввод пароля из SMS-сообщения/i.test(b))throw new AnyBalance.Error("У вас настроен вход по паролю из SMS сообщения. Для пользования провайдером удобно отключить этот пароль в настройках интернет-банка. Это безопасно, для проведения любых операций SMS-пароль всё равно будет требоваться.");(a=getParam(b,null,null,/<div[^>]+class="b-frm-warning2"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))||(a=getParam(b,null,null,/<h2[^>]+class="b-auth-error[^>]*>([\s\S]*?)<\/h2>/i,replaceTagsAndSpaces));
a||(a=getParam(b,null,null,/<div[^>]+class="b-auth-blocked"[^>]*>\s*<p>([\s\S]*?)<\/p>/i,replaceTagsAndSpaces));/необходимо задать новый пароль/i.test(""+a)&&(a+=" Зайдите в интернет-банк https://online.rsb.ru через браузер, задайте новый пароль и введите новый пароль в настройки провайдера.");if(a)throw new AnyBalance.Error(a,null,/новый пароль|или пароль|Доступ в систему заблокирован/i.test(a));AnyBalance.trace(b);throw new AnyBalance.Error("Ошибка авторизации. Проверьте логин и пароль");}a=getProductsJson()}return a}
function getProductsJson(){if(getProductsJson.cached_json)return getProductsJson.cached_json;var b=AnyBalance.requestGet(baseurl+"request.json",g_headers);if(/'data'/.test(b))return!1;var a=getJson(b);if(!a.data)throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка получения списка карт. Сайт изменен?");return getProductsJson.cached_json=a}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){for(var c=[],d=0;d<b.data.length;++d){var e=b.data[d];"account"==e.type&&c.push(e)}AnyBalance.trace("Найдено счетов: "+c.length);a.accounts=[];for(d=0;d<c.length;++d){var e=c[d],f=e.id,g=e.num,h=e.title+" "+g.substr(-4),f={__id:f,__name:h,num:g};__shouldProcess("accounts",f)&&processAccount(e,f);a.accounts.push(f)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(b.title,a,"accounts.name");getParam(b.acc[0].available,a,"accounts.balance",null,null,parseBalance);getParam(b.acc[0].currency,a,["accounts.currency","accounts.balance"]);getParam(b.date_create,a,"accounts.date_start",null,null,parseDate);if(AnyBalance.isAvailable("accounts.transactions","accounts.status","accounts.tariff")){var c=AnyBalance.requestGet(joinUrl(baseurl,b.link),g_headers);if(AnyBalance.isAvailable("accounts.status",
"accounts.tariff")){var d=getElement(c,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities);getParam(d,a,"accounts.status",/Состояние[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces);getParam(d,a,"accounts.tariff",/Тарифный план[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/Тарифный план\s*-/i,"",replaceTagsAndSpaces])}AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(c,a)}}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){for(var c=[],d=0;d<b.data.length;++d){var e=b.data[d];"card"==e.type&&c.push(e)}AnyBalance.trace("Найдено карт: "+c.length);a.cards=[];for(d=0;d<c.length;++d)if(e=c[d],e.acc){var f=e.id,g=e.num,h=e.title+" "+g.substr(-4),f={__id:f,__name:h,num:g};__shouldProcess("cards",f)&&processCard(e,f);a.cards.push(f)}}}function followDetailsLink(b,a){var c=getParam(b,null,null,a);if(c)return followDetailsLinkStr(b,c)}
function followDetailsLinkStr(b,a,c){var d=getElement(b,/<form[^>]+name="mainform"[^>]*>/i);b=createFormParams(d);b.source=getParam(a,null,null,/source\s*:\s*'([^']*)/);a=getParam(d,null,null,/<form[^>]+action="([^"]*)/i,replaceHtmlEntities);a=joinUrl(baseurl,a);return b=AnyBalance.requestPost(a,b,g_headers,c)}
function processCard(b,a){function c(a){return/основная/i.test(a)}AnyBalance.trace("Обработка карты "+a.__name);getParam(b.acc[0].available,a,"cards.balance",null,null,parseBalance);getParam(b.acc[0].lock,a,"cards.blocked",null,null,parseBalance);getParam(b.acc[0].own,a,"cards.own",null,null,parseBalance);getParam(b.acc[0].currency,a,["cards.currency","cards.balance","cards.blocked","cards.own"]);getParam(b.enddate,a,"cards.till",null,replaceTagsAndSpaces,parseDate);getParam(b.date_create,a,"cards.date_start",
null,replaceTagsAndSpaces,parseDate);getParam(b.tarif,a,"cards.tariff");var d=joinUrl(baseurl,b.link),d=AnyBalance.requestGet(d,g_headers),e=getElement(d,/<table[^>]+mb60[^>]*>/i,html_entity_decode);getParam(e,a,"cards.limit",/Лимит[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(d,a);AnyBalance.isAvailable("cards.accnum","cards.main","cards.status","cards.contract","cards.excerpt")&&(e=getElement(d,/<div[^>]+b-prod-props[^>]*>/i,
replaceHtmlEntities),e||(d=followDetailsLink(d,/<table[^>]+prod-balance_var2[\s\S]*?(<a[^>]+link_more[^>]*>)/i),e=getElement(d,/<div[^>]+b-prod-props[^>]*>/i,replaceHtmlEntities)),getParam(e,a,"cards.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces),e=getElement(d,/<table[^>]+prod-balance_var2[^>]*>/i,replaceHtmlEntities),getParam(e,a,"cards.main",/>\s*Тип[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,c),getParam(e,a,"cards.status",/>\s*Статус[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces),getParam(e,a,"cards.contract",/>\s*Договор[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,[/№/ig,"",replaceTagsAndSpaces]),getParam(e,a,"cards.gracepay",/Сумма для реализации Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(e,a,"cards.gracepay_till",/Дата окончания Льготного периода[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),AnyBalance.isAvailable("cards.excerpt")&&processCardExerpt(d,a))}
function processDeposits(b,a){if(AnyBalance.isAvailable("deposits")){for(var c=[],d=0;d<b.data.length;++d){var e=b.data[d];"deposit"==e.type&&c.push(e)}AnyBalance.trace("Найдено депозитов: "+c.length);a.deposits=[];for(d=0;d<c.length;++d){var e=c[d],f=e.id,g=joinUrl(baseurl,e.link);AnyBalance.trace("Детали по депозиту находятся по ссылке "+g);var g=AnyBalance.requestGet(g,g_headers),h=AB.getElement(g,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities),k=getParam(h,null,null,/Номер депозитного счета[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces),h=getParam(h,null,null,/Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces),l=e.title+" "+k.substr(-4),f={__id:f,__name:l,num:k,contract:h};__shouldProcess("deposits",f)&&processDeposit(e,f,g);a.deposits.push(f)}}}
function processDeposit(b,a,c){AnyBalance.trace("Обработка депозита "+a.__name);getParam(b.acc[0].available,a,"deposits.balance",null,null,parseBalance);getParam(b.acc[0].currency,a,["deposits.currency","deposits.balance"]);getParam(b.date_create,a,"deposits.date_start",null,null,parseDate);getParam(b.end,a,"deposits.till",null,null,parseDate);getParam(b.rate,a,"deposits.pct",null,null,parseBalance);getParam(b.title,a,"deposits.name");b=AB.getElement(c,/<table[^>]+prod-balance_var2[^>]*>/,replaceHtmlEntities);
getParam(b,a,"deposits.prolong",/Автоматическое возобновление[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBool);getParam(b,a,"deposits.prolong_times",/Количество свершившихся автоматических возобновлений[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance)}
function processCredits(b,a){if(AnyBalance.isAvailable("credits")){for(var c=[],d=0;d<b.data.length;++d){var e=b.data[d];"loan"==e.type&&c.push(e)}AnyBalance.trace("Найдено кредитов: "+c.length);a.credits=[];for(d=0;d<c.length;++d){var e=c[d],f=e.id,g=e.num,h;g||(h=getActionUrl(/Информация по кредиту/i,e.actions),h=AnyBalance.requestGet(h,g_headers),g=getElement(h,/<div[^>]+h-content-inner[^>]*>/i,replaceHtmlEntities),g=getParam(g,null,null,/Номер договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces));
var k=e.title+" "+g.substr(-4),f={__id:f,__name:k,num:g};__shouldProcess("credits",f)&&processCredit(e,f,h);a.credits.push(f)}}}function getActionUrl(b,a){for(var c=0;c<a.length;++c){var d=a[c];if(b.test(d.title))return joinUrl(baseurl,d.link)}}function parseBool(b){return/включено/i.test(b)}
function processCredit(b,a,c){AnyBalance.trace("Обработка кредита "+a.__name);getParam(b.loan.amount,a,"credits.limit",null,replaceTagsAndSpaces,parseBalance);getParam(b.acc[0].available,a,"credits.balance",null,replaceTagsAndSpaces,parseBalance);getParam(b.acc[0].currency,a,"credits.currency",null,replaceTagsAndSpaces);getParam(b.title,a,"credits.name");getParam(b.next.amount,a,"credits.minpay",null,replaceTagsAndSpaces,parseBalance);getParam(b.next.date,a,"credits.minpay_till",null,replaceTagsAndSpaces,
parseDate);c||(c=getActionUrl(/Информация по кредиту/i,p.actions),c=AnyBalance.requestGet(c,g_headers));c=getElement(c,/<div[^>]+h-content-inner[^>]*>/i,replaceHtmlEntities);getParam(c,a,"credits.own",/Остаток на счёте[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"credits.date_start",/Дата заключения договора[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"credits.accnum",/Номер счета в банке:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces);
AnyBalance.isAvailable("credits.schedule")&&(c=getActionUrl(/График платежей/i,b.actions),processCreditSchedule(c,a))}
function processInfo(b,a){if(AnyBalance.isAvailable("info")){b=AnyBalance.requestGet(baseurl+"rs/settings/Settings.jspx",g_headers);var c=a.info={};getParam(b,c,"info.fio",/&#1048;&#1084;&#1103; ([^<]*)/i,replaceTagsAndSpaces);getParam(b,c,"info.login",/<input[^>]+name="mainform:login"[^>]*value="([^"]*)/i,replaceHtmlEntities);getParam(b,c,"info.email",/<input[^>]+name="mainform:email"[^>]*value="([^"]*)/i,replaceHtmlEntities)}};
