var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/48.0.2564.116 Safari/537.36"},baseurl="https://my.tele2.ru/",baseurlLogin="https://login.tele2.ru/ssotele2/";
function login(){function b(a){if(400<AnyBalance.getLastStatusCode()){var c=getElement(a,/<div[^>]+error[^>]*>/i,replaceTagsAndSpaces);503==AnyBalance.getLastStatusCode()&&(a=AnyBalance.requestGet(baseurl+"login",g_headers));if(400<AnyBalance.getLastStatusCode()){if(c)throw new AnyBalance.Error("Новый кабинет: "+c);AnyBalance.trace(a);throw new AnyBalance.Error("Новый личный кабинет Теле2 временно недоступен. Попробуйте позже.");}}return a}var c=AnyBalance.getPreferences();checkEmpty(/^\d{10}$/.test(c.login),
"Введите логин - номера телефона из 10 цифр! Например, 9771234567");AnyBalance.setDefaultCharset("utf-8");var a=AnyBalance.requestGet(baseurl+"login",g_headers);if(/\w+\/logout/i.test(a))AnyBalance.trace("Уже в кабинете. Используем текущую сессию");else{if(c.password){a=AnyBalance.requestGet(baseurlLogin+"wap/auth/",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");var d=
getParam(a,null,null,/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,replaceTagsAndSpaces);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа, сайт изменен?");a=AnyBalance.requestPost(baseurlLogin+"wap/auth/submitLoginAndPassword",{pNumber:c.login,password:c.password,_csrf:d},g_headers)}else a=enterBySms();a=b(a)}if(!/\w+\/logout/i.test(a)){if(/<input[^>]+id\s*=\s*"smsCode"/i.test(a))throw new AnyBalance.Error("У вас настроена двухфакторная авторизация с вводом SMS кода при входе в личный кабинет Теле2. Для работы провайдера требуется запрос СМС кода для входа в ЛК отключить. Инструкцию по отключению см. в описании провайдера.",
null,!0);if(c=sumParam(a,null,null,/<(?:div|section)[^>]+class="[^"]*\berror\b[^>]*>([\s\S]*?)(?:<\/section>|<\/div>|<div)/gi,replaceTagsAndSpaces,null,aggregate_join)||"")throw new AnyBalance.Error(c,null,/Неверный пароль|не найден/i.test(c));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось зайти в личный кабинет. Сайт изменен?");}/<div[^>]+class="user-phone"/i.test(a)||(a=AnyBalance.requestGet(baseurl+"login",addHeaders({Referer:baseurl})),a=b(a));__setLoginSuccessful();return a}
function reenterOld(b){b=AnyBalance.requestGet("https://old.my.tele2.ru/",g_headers);/<form[^>]+id="sso-modal-login-form"/i.test(b)&&(b=getParam(b,null,null,/<input[^>]+name="csrfTokBY"[^>]*value="([^"]*)/i,replaceHtmlEntities),b=AnyBalance.requestGet("https://old.my.tele2.ru/public/login_sso?csrfTokBY="+b,addHeaders({Referer:"https://old.my.tele2.ru/"})));return b}
function enterBySms(){function b(){if(400>f){var b=getJson(a);if(b.success)AnyBalance.setCookie("login.tele2.ru","AUTH_DATA",b.key),a=AnyBalance.requestGet(baseurlLogin+"wap/auth?serviceId=341",g_headers);else{if(b.captchaNeeded){b=AnyBalance.requestGet(baseurlLogin+"wap/auth/captcha?"+(new Date).getTime(),g_headers);g=AnyBalance.retrieveCode("Пожалуйста, введите цифры с картинки",b,{inputType:"number"});b=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussdCaptcha?captchaAnswer="+encodeURIComponent(g),
{},e);b=getJson(b);if(b.success)return a=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(c.login),{},e),f=AnyBalance.getLastStatusCode(),!0;throw new AnyBalance.Error("Неверно введены цифры с картинки.");}if(b.forbiddenBranch)throw new AnyBalance.Error("Этот номер не поддерживается личным кабинетом Теле2. Убедитесь, что это действительно номер Теле2.",null,!0);AnyBalance.trace(a);throw new AnyBalance.Error("Вход в личный кабинет не подтвержден на телефоне пользователя. Чтобы войти, отправьте 1 в ответ на запрос на телефоне или дождитесь SMS кода и введите его.");
}}return!1}var c=AnyBalance.getPreferences(),a=AnyBalance.requestGet(baseurlLogin+"wap/auth/ussd",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту провайдера! Попробуйте обновить данные позже.");var d=getParam(a,null,null,/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,replaceTagsAndSpaces);if(!d)throw AnyBalance.trace(a),new AnyBalance.Error("Не удалось найти форму входа, сайт изменен?");var e=addHeaders({Origin:baseurlLogin.replace(/(.*:\/\/[^\/]+).*/i,
"$1"),"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":d,Referer:AnyBalance.getLastUrl()}),a=AnyBalance.requestPost(baseurlLogin+"wap/auth/ussd?pNumber="+encodeURIComponent(c.login),{},e),f=AnyBalance.getLastStatusCode();b()&&b();if(504==f){var a=AnyBalance.requestGet(baseurlLogin+"wap/auth/requestSms",addHeaders({Referer:AnyBalance.getLastUrl()})),d=getParam(a,null,null,/<input[^>]+value="([^"]+)"[^>]*name="_csrf"/i,replaceTagsAndSpaces),g=AnyBalance.retrieveCode("Вам отправлено SMS-сообщение с кодом для входа в личный кабинет Теле2. Введите код из SMS",
null,{inputType:"number"}),a=AnyBalance.requestPost(baseurlLogin+"wap/auth/submitSmsCode",{_csrf:d,smsCode:g},addHeaders({Referer:AnyBalance.getLastUrl()}));if(!/\w+\/logout/i.test(a)&&400>AnyBalance.getLastStatusCode()){if(d=getParam(a,null,null,/<section[^>]+class="error"[^>]*>([\s\S]*?)(?:<div|<\/section>)/i,replaceTagsAndSpaces))throw new AnyBalance.Error(d);AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось войти в кабинет после ввода SMS. Сайт изменен?");}}return a}
function processBalance(b,c){if(AnyBalance.isAvailable("balance","tariff")){AnyBalance.trace("Получаем баланс");for(var a=0;3>a;a++)try{AnyBalance.trace("Пытаемся получить баланс, попытка: "+(a+1));b=AnyBalance.requestGet(baseurl+"main/tariffAndBalance",g_headers);var d=getJson(b);d.currentTariffPlan.name&&getParam(d.currentTariffPlan.name,c,"tariff");getParam(d.balance.amount,c,"balance",null,null,parseBalance);AnyBalance.trace("Успешно получили баланс");break}catch(e){AnyBalance.trace("Не удалось получить баланс, пробуем еще раз...")}}}
function processRemainders(b,c){if(AnyBalance.isAvailable("remainders")){AnyBalance.trace("Получаем остатки услуг");try{c.remainders||(c.remainders={});AnyBalance.trace("Searching for resources left");b=AnyBalance.requestGet(baseurl+"main/discounts",g_headers);AnyBalance.trace("Got discounts: "+b);json=JSON.parse(b);for(var a=[json.discountsIncluded,json.discountsNotIncluded],d=0;d<a.length;++d)for(var e=a[d],f=0;e&&f<e.length;++f){var g=e[f];if(isArray(g))for(var h=0;h<g.length;++h)getDiscount(c.remainders,
g[h]);else getDiscount(c.remainders,g)}}catch(k){AnyBalance.trace("Не удалось получить данные об остатках пакетов и услуг, попробуйте позже "+k)}}}
function getDiscount(b,c){var a=c.name,d=c.limitMeasureCode;AnyBalance.trace("Найден дискаунт: "+a+" ("+d+")");getParam(c.endDateString,b,"remainders.endDate",null,null,parseDateWordSilent);/мин/i.test(d)?(sumParam(c.rest.value,b,"remainders.min_left",null,null,null,aggregate_sum),sumParam(c.limit.value-c.rest.value,b,"remainders.min_used",null,null,null,aggregate_sum)):/[кмгkmg][bб]/i.test(d)?(getParam(c.rest.value+c.rest.measure,b,"remainders.traffic_left",null,null,parseTraffic),getParam(c.limit.value-
c.rest.value+c.limit.measure,b,"remainders.traffic_used",null,null,parseTraffic)):/шт|SMS|MMS/i.test(d)?/ммс|mms/i.test(a)?(getParam(c.rest.value,b,"remainders.mms_left"),getParam(c.limit.value-c.rest.value,b,"remainders.mms_used")):(getParam(c.rest.value,b,"remainders.sms_left"),getParam(c.limit.value-c.rest.value,b,"remainders.sms_used")):AnyBalance.trace("Неизвестный дискаунт: "+JSON.stringify(c))}
function processPayments(b,c){if(AnyBalance.isAvailable("payments")){AnyBalance.trace("Searching for payments");try{b=AnyBalance.requestGet(baseurl+"payments/history?filter=LAST_10");var a=getParam(b,null,null,/JS_DATA\s*=\s*JSON.parse\s*\(('(?:[^\\']+|\\.)*')/,null,function(a){return getJson(safeEval("return "+a))})}catch(g){}if(a&&a.payments){AnyBalance.trace("History json: "+JSON.stringify(a));c.payments=[];for(var d=0;d<a.payments.length;++d){var e=a.payments[d],f={};getParam(e.amount,f,"payments.sum",
null,null,parseBalanceSilent);getParam(e.type,f,"payments.descr");getParam(e.date,f,"payments.date",null,null,function(a){if(/Вчера/i.test(a))return parseDate(a.replace(/Вчера(?:\s+в)?/i,getFormattedDate({offsetDay:1})));if(/Сегодня/i.test(a))return parseDate(a.replace(/Сегодня(?:\s+в)?/i,getFormattedDate({offsetDay:0})));if(/назад/i.test(a)){var b=(new Date).getTime()-1E3*parseMinutes(a);AnyBalance.trace("Parsed "+(new Date(b)).getTime()+" from "+a);return b}a=/^(\d+\s+[а-яa-z]+)/i.exec(a)||[];return parseDateWordSilent(a[1])});
c.payments.push(f)}}else AnyBalance.trace(b),AnyBalance.trace("Не удолось получить последние платежи, может их просто нет?")}}
function processInfo(b,c){if(AnyBalance.isAvailable("info")){var a=c.info={};getParam(b,a,"info.fio",/<div[^>]+class="user-name"[^>]*>([\s\S]*?)(?:<\/div>|<a)/i,replaceTagsAndSpaces,capitalFirstLetters);getParam(b,a,"info.mphone",/<div[^>]+class="user-phone"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("info.email","info.address")&&(b=AnyBalance.requestGet(baseurl+"account"),getParam(b,a,"info.phone_model",/Модель телефона:([\s\S]*?)<\/p>/i,replaceTagsAndSpaces),getParam(b,
a,"info.address",/<div[^>]+id="js-view-element-address-view"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces),getParam(b,a,"info.email",/<div[^>]+id="js-view-element-email-view"[^>]*>([\s\S]*?)<\/div>/i,[/unknown@email.com/i,"",replaceTagsAndSpaces]))}};
