var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/29.0.1547.76 Safari/537.36"},g_baseurls={Bashko:"https://online.bm.ru",Habar:"https://khb-online.mmbank.ru",Hanti:"https://ekburg-online.mmbank.ru",Irkut:"https://nsk-online.mmbank.ru",Kalin:"https://spb-online.mmbank.ru",
Kemer:"https://nsk-online.mmbank.ru",Krasn:"https://nsk-online.mmbank.ru",Kursk:"https://online.bm.ru",Moskv:"https://online.bm.ru",Nizheg:"https://nnov-online.mmbank.ru",Novos:"https://nsk-online.mmbank.ru",Omska:"https://nsk-online.mmbank.ru",Orenb:"https://nnov-online.mmbank.ru",Perms:"https://nnov-online.mmbank.ru",Primo:"https://khb-online.mmbank.ru",Rosto:"https://online.bm.ru",Sahal:"https://khb-online.mmbank.ru",Samar:"https://nnov-online.mmbank.ru",Sankt:"https://spb-online.mmbank.ru",Sever:"https://online.bm.ru",
Stavr:"https://online.bm.ru",Sverd:"https://ekburg-online.mmbank.ru",Tatar:"https://online.bm.ru",Tul_s:"https://online.bm.ru",Tyumen:"https://ekburg-online.mmbank.ru",Volgo:"https://online.bm.ru",Voron:"https://online.bm.ru",Yamalo:"https://ekburg-online.mmbank.ru",Yarosl:"https://online.bm.ru",adige:"https://krasnodar-online.mmbank.ru"},g_baseurl="https://online.bm.ru";function isLoggedIn(b){return/logout/i.test(b)}
function hasCaptcha(b){return/<span[^>]id="[^"]*:captchaBlock"(?:[^>](?!display:\s*none))*>/i.test(b)}
function tryLogin(b){var a=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");var c=getCaptcha(b),d=getElement(b,/<form[^>]*loginForm[^>]*>/i);if(!d){var e=getElement(b,/<div[^>]+id="mainContent"[^>]*>/i,replaceTagsAndSpaces);if(e&&255>e.length)throw new AnyBalance.Error(e);AnyBalance.trace(b);throw new AnyBalance.Error("Не удаётся найти форму входа. Сайт изменен?");}var e=createFormParams(d,function(b,e,d,f){return/:login$/i.test(d)?a.login:/:password$/i.test(d)?a.password:/:saveLogin$/i.test(d)?
void 0:/:captchaText$/i.test(d)?c:f}),f=getParam(d,null,null,/<input[^>]+id="[^"]*:loginBtn"[^>]*>/i),g=getParam(f,null,null,/<input[^>]+id="([^"]*)/i,replaceHtmlEntities),h=getParam(f,null,null,/execute:\\?'([^'\\]*)/i),f=getParam(f,null,null,/render:\\?'([^'\\]*)/),k=getParam(d,null,null,/<form[^>]+id="([^"]*)/i,replaceHtmlEntities),e=joinObjects(e,{"javax.faces.behavior.event":"action","javax.faces.partial.event":"click","javax.faces.source":g,"javax.faces.partial.ajax":"true","javax.faces.partial.execute":h,
"javax.faces.partial.render":f});e[k]=k;d=getParam(d,null,null,/<form[^>]+action="([^"]*)/i);e=AnyBalance.requestPost(g_baseurl+d,e,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf","Faces-Request":"partial/ajax"}));e=getParam(e,null,null,/<message[^>]*>([\s\S]*?)<\/message>/i,null,getJson);if(e.showCaptcha&&!c)return AnyBalance.trace("Потребовался ввод капчи"),b.replace(/(captchaBlock"[^>]*)display:\s*none/i,"$1display:block");if(e.error)throw new AnyBalance.Error({incorrectCaptcha:"Неверно введены символы с картинки"}[e.error]||
e.error);d=getElement(b,/<form[^>]+j_security_check[^>]*>/i);if(!d)throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти форму передачи логина-пароля. Сайт изменен?");e=createFormParams(d,function(b,e,d,f){return/username/i.test(d)?a.login:/password/i.test(d)?a.password:/captcha/i.test(d)?c||"":f});return b=AnyBalance.requestPost(g_baseurl+"/scoring/j_security_check",e,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}))}
function findErrors(b){return getElements(b,/<(?:[^>](?!display:\s*none))+class="error"(?:[^>](?!display:\s*none))*>/ig,replaceTagsAndSpaces).join("\n")}function getCaptcha(b){var a="";hasCaptcha(b)&&(a=getParam(b,null,null,/<img[^>]+id="[^"]*:jcaptcha"[^>]*src="([^"]*)/i)||"");a&&(AnyBalance.trace("Надо капчу вводить..."),b=AnyBalance.requestGet(g_baseurl+a,g_headers),a=AnyBalance.retrieveCode("Пожалуйста, введите код с картинки",b));return a}
function checkForPasswordChange(b){if(!getElements(b,[/<form[^>]*>/ig,/<div[^>]+changePasswordBox/i])[0])return b;throw new AnyBalance.Error("Банк требует изменить параметры безопасности. Пожалуйста, войдите в интернет-банк "+g_baseurl+" через браузер, выполните требования банка, затем введите логин и новый пароль в настройки провайдера.",null,!0);}
function redirectIfNeeded(b){if(300<=AnyBalance.getLastStatusCode()){var a=getParam(b,null,null,/location.href\s*=\s*['"]([^'"]*)/);if(a)return AnyBalance.trace("redirect: "+a),b=joinUrl(g_baseurl,a),AnyBalance.requestGet(b,g_headers)}return b}
function login(){var b=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("windows-1251");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");b.region&&g_baseurls[b.region]||(b.region="Moskv");g_baseurl=g_baseurls[b.region];AnyBalance.trace("Region is "+b.region+": "+g_baseurl);var a=AnyBalance.requestGet(g_baseurl+"/scoring/protected/welcome.jsf",g_headers),a=redirectIfNeeded(a);if(isLoggedIn(a))return a=checkForPasswordChange(a);b=hasCaptcha(a);a=tryLogin(a);if(isLoggedIn(a))return a;
form=getElements(a,[/<form[^>]+submitForm[^>]*>/ig,/<input[^>]+name="otp_type"/i])[0];if(!form&&hasCaptcha(a)&&!b){a=tryLogin(a);if(isLoggedIn(a))return a=checkForPasswordChange(a);form=getElements(a,[/<form[^>]+submitForm[^>]*>/ig,/<input[^>]+name="otp_type"/i])[0]}if(!form){if(b=findErrors(a))throw new AnyBalance.Error(b,null,/Неверно указаны данные для входа/i.test(b));AnyBalance.trace(a);throw new AnyBalance.Error("Не удалось войти в интернет-банк. Сайт изменен?");}var b=getParam(form,null,null,
/<input[^>]+name="otp_type"[^>]*value+"([^"]*)/i),b=getParam(a,null,null,new RegExp('<span[^>]+id="otp_type_'+b+'"[^>]*confirmType[^>]*>([\\s\\S]*?)</span>',"i"),replaceTagsAndSpaces),c=AnyBalance.requestPost(g_baseurl+"/scoring/smsPasswordLoginAjaxServlet",{smsSentTime:(new Date).getTime()},addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/j_security_check","X-Requested-With":"XMLHttpRequest"})),d=AnyBalance.retrieveCode(b||"Введите код подтверждения входа",null,{inputType:"number"}),b=createFormParams(form,
function(b,f,g,h){return"otp"==g?d:"captcha"==g?getCaptcha(a):"session_id"==g?c:h}),a=AnyBalance.requestPost(g_baseurl+"/scoring/j_security_check",b,addHeaders({Origin:g_baseurl,Referer:g_baseurl+"/scoring/protected/welcome.jsf"}));if(!/logout/i.test(a)){if(b=findErrors(a))throw new AnyBalance.Error(b);AnyBalance.trace(a);throw AnyBalance.Error("Не удалось войти в интернет банк. Сайт изменен?");}return a=checkForPasswordChange(a)}
function processCards(b,a){if(AnyBalance.isAvailable("cards")){AnyBalance.trace("Читаем карты");var c=getElements(b,/<div[^>]+class="cardsBlock"[^>]*>/ig);if(0==c.length)AnyBalance.trace(b),AnyBalance.trace("Не удалось найти блок карт. Карты отсутствуют?");else{for(var d=[],e=0;e<c.length;++e)d=d.concat(getElements(c[e],/<div[^>]+productShort[^>]*>/ig));AnyBalance.trace("Найдено "+d.length+" карт");a.cards=[];for(e=0;e<d.length;++e){var c=d[e],f=getParam(c,null,null,/statement\/card\/(\d+)/i),g=getParam(c,
null,null,/<td[^>]*>\s*<span[^>]*>[^<]*<\/span>\s*<span[^>]*>[^<]*\d{4}\s*<\/span>\s*<\/td>/i),h=getParam(g,null,null,null,[replaceTagsAndSpaces,/\*[*\s]+\*/g,"*"]),k=getParam(c,null,null,/[\*\d]{4}\s+[\*\d]{4}\s+[\*\d]{4}\s+\d{4}/i,replaceTagsAndSpaces),f={__id:f,__name:h,num:k};__shouldProcess("cards",f)&&(getParam(g,f,"cards.type",/<span[^>]*>([^<]*)<\/span>/i,replaceTagsAndSpaces),processCard(c,f));a.cards.push(f)}}}}
function processInfo(b,a){if(AnyBalance.isAvailable("info")){a.info={};var c=AnyBalance.getPreferences();getParam(b,a.info,"info.io",/<div[^>]*class="clientName"[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(c.login,a.info,"info.login");if(AnyBalance.isAvailable("info.fio")){(c=getParam(b,null,null,/<a[^>]+href="([^"]*\/scoring\/protected\/statement\/account\/[^"]*)/i,replaceHtmlEntities))||(c=getParam(b,null,null,/<a[^>]+href="([^"]*\/scoring\/protected\/statement\/card\/[^"]*)/i,replaceHtmlEntities));
b=AnyBalance.requestGet(joinUrl(g_baseurl,c),g_headers);var d=getElement(b,/<form[^>]+detailsDialog:detailsDialog[^>]*>/i,replaceHtmlEntities);/account/i.test(c)?getParam(d,a.info,"info.fio",/Получатель платежа:[\s\S]*?<td[^>]*>([\s\S]*?)<\/td>/i,replaceTagsAndSpaces):getParam(d,a.info,"info.fio",/Назначение платежа:[\s\S]*?<td[^>]*>([\s\S]*?)(?:,|<\/td>)/i,replaceTagsAndSpaces)}}}
function processCard(b,a){AnyBalance.trace("Обрабатываем карту "+a.__name);getParam(b,a,"cards.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"cards.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(b,a,"cards.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("cards.debt_late","cards.minpay","cards.debt","cards.gracepay","cards.gracepay_till",
"cards.limit","cards.blocked","cards.sms","cards.till","cards.transactions")){b=AnyBalance.requestGet(g_baseurl+"/scoring/protected/statement/card/"+a.__id,g_headers);var c=getElement(b,/<table[^>]+bigCardShadow[^>]*>/i,replaceHtmlEntities);getParam(c,a,"cards.debt_late",/Просроченная задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.minpay",/Минимальный платеж:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,
a,"cards.debt",/Всего задолженность:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.date_start",/Дата открытия карты:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"cards.pct",/Процентная ставка:([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.blocked",/Заблокировано:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.sms",/Подключено SMS-информирование на номера:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces);getParam(c,a,"cards.till",/Действительна до:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"cards.limit",/Кредитный лимит:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.gracepay",/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"cards.gracepay_till",/Сумма платежа в льготном периоде:[\s\S]*?<span[^>]*>\s*до([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,
parseDate);AnyBalance.isAvailable("cards.transactions")&&processCardTransactions(b,a)}}
function processAccounts(b,a){if(AnyBalance.isAvailable("accounts")){AnyBalance.trace("Читаем счета");var c=getElements(b,[/<div[^>]+productShort[^>]*>/ig,/statement\/account\/./i]);if(c.length){AnyBalance.trace("Найдено "+c.length+" счетов");a.accounts=[];for(var d=0;d<c.length;++d){var e=c[d],f=getParam(e,null,null,/statement\/account\/(\d+)/i),g=getParam(e,null,null,/(?:\d(?:\s+|&nbsp;|&#160;)*){20}/i,replaceTagsAndSpaces),f={__id:f,__name:g,num:g.replace(/\s+/g,"")};__shouldProcess("accounts",
f)&&processAccount(e,f);a.accounts.push(f)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось найти блок счетов. счета отсутствуют?")}}
function processAccount(b,a){AnyBalance.trace("Обрабатываем счет "+a.__name);getParam(b,a,"accounts.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"accounts.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(b,a,"accounts.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);if(AnyBalance.isAvailable("accounts.date_start","accounts.contract")){b=AnyBalance.requestGet(g_baseurl+
"/scoring/protected/statement/account/"+a.__id,g_headers);var c=getElement(b,/<table[^>]+productFull[^>]*>/i,replaceHtmlEntities);getParam(c,a,"accounts.date_start",/Дата открытия счета:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"accounts.contract",/Номер договора:[\s\S]*?<span[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(b,a)}}
function processCredits(b,a){if(AnyBalance.isAvailable("credits")){AnyBalance.trace("Читаем кредиты");var c=getElements(b,[/<div[^>]+productShort[^>]*>/ig,/statement\/credit\/./i]);if(c.length){AnyBalance.trace("Найдено "+c.length+" кредитов");a.credits=[];for(var d=0;d<c.length;++d){var e=c[d],f=getParam(e,null,null,/statement\/credit\/(\d+)/i),g=getElement(e,/<span[^>]+id="[^"]*:aliasText"[^>]*>/i,replaceTagsAndSpaces),h=getParam(e,null,null,/&#1044;&#1086;&#1075;&#1086;&#1074;&#1086;&#1088; [N№]([^<]*)/i,
replaceTagsAndSpaces),f={__id:f,__name:g+" "+h,num:h};__shouldProcess("credits",f)&&processCredit(e,f);a.credits.push(f)}}else AnyBalance.trace(b),AnyBalance.trace("Не удалось найти блок кредитов. Кредиты отсутствуют?")}}
function processCredit(b,a){AnyBalance.trace("Обрабатываем кредит "+a.__name);getParam(b,a,"credits.balance",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.currency",/<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseCurrency);getParam(b,a,"credits.name",/<div[^>]+aliasBox[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces);getParam(b,a,"credits.minpay",/&#1045;&#1078;&#1077;&#1084;&#1077;&#1089;&#1103;&#1095;&#1085;&#1099;&#1081; &#1087;&#1083;&#1072;&#1090;&#1077;&#1078;:[\s\S]*?<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,
replaceTagsAndSpaces,parseBalance);getParam(b,a,"credits.minpay_till",/&#1044;&#1072;&#1090;&#1072; &#1089;&#1087;&#1080;&#1089;&#1072;&#1085;&#1080;&#1103;:([^<]*)/i,replaceTagsAndSpaces,parseDate);if(AnyBalance.isAvailable("credits.debt_late","credits.pct","credits.date_start","credits.period","credits.cardnum","credits.accnum")){b=AnyBalance.requestGet(g_baseurl+"/scoring/protected/statement/credit/"+a.__id,g_headers);var c=getElement(b,/<table[^>]+productFull[^>]*>/i,replaceHtmlEntities);getParam(c,
a,"credits.debt_late",/Просроченная задолженность:[\s\S]*?<span[^>]+amountBox[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"credits.pct",/Процентная ставка:([^<]*)/i,replaceTagsAndSpaces,parseBalance);getParam(c,a,"credits.date_start",/Дата выдачи кредита:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"credits.till",/Дата окончания кредита:([^<]*)/i,replaceTagsAndSpaces,parseDate);getParam(c,a,"credits.period",/Срок кредита:([^<]*)/i,replaceTagsAndSpaces,parseBalance);
getParam(c,a,"credits.contract",/Номер Договора: N?([^<]*)/i,replaceTagsAndSpaces);getParam(c,a,"credits.cardnum",/Карта для погашения кредита:[\s\S]*?<a[^>]*>([\s\S]*?)(?:\(|<\/a>)/i,replaceTagsAndSpaces);getParam(c,a,"credits.accnum",/Счет для погашения кредита:[\s\S]*?<a[^>]*>([\s\S]*?)(?:\(|<\/a>)/i,replaceTagsAndSpaces)}}function getViewState(b){return getParam(b,null,null,/<input[^>]+name="javax.faces.ViewState"[^>]*value="([^"]*)/i)}
function transliterate(b){var a="",c={"Ё":"YO","Й":"I","Ц":"TS","У":"U","К":"K","Е":"E","Н":"N","Г":"G","Ш":"SH","Щ":"SCH","З":"Z","Х":"H","Ъ":"_","ё":"yo","й":"i","ц":"ts","у":"u","к":"k","е":"e","н":"n","г":"g","ш":"sh","щ":"sch","з":"z","х":"h","ъ":"_","Ф":"F","Ы":"I","В":"V","А":"a","П":"P","Р":"R","О":"O","Л":"L","Д":"D","Ж":"ZH","Э":"E","ф":"f","ы":"i","в":"v","а":"a","п":"p","р":"r","о":"o","л":"l","д":"d","ж":"zh","э":"e","Я":"Ya","Ч":"CH","С":"S","М":"M","И":"I","Т":"T","Ь":"_","Б":"B","Ю":"YU",
"я":"ya","ч":"ch","с":"s","м":"m","и":"i","т":"t","ь":"_","б":"b","ю":"yu"};for(i=0;i<b.length;++i)a+=void 0===c[b[i]]?b[i]:c[b[i]];return a}
function extractRegions(){for(var b=AnyBalance.requestGet(g_baseurl+"/private/web.jsf"),b=getElement(b,/<select[^>]+id="region"[^>]*>/i),b=getElements(b,/<option[^>]*>/ig),a=[],c=[],d={},e=0;e<b.length;++e){var f=getParam(b[e],null,null,null,replaceTagsAndSpaces),g=replaceAll(f,[/Республика\s*/i,"",/\s+.*$/,""]).substr(0,5),g=transliterate(g),h=getParam(b[e],null,null,/<option[^>]+value="([^"]*)/i);d[g]=h;a.push(f);c.push(g)}AnyBalance.setResult({success:!0,valsite:d,names:a.join("|"),values:c.join("|")})}
;
