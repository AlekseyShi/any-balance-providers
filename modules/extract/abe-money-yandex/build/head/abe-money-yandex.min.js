var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.72 Safari/537.36"},baseurl="https://money.yandex.ru/";
function loginAndGetBalance(e,d){checkEmpty(e.login,"Введите логин в Яндекс.Деньги!");checkEmpty(e.password,"Введите пароль, используемый для входа в систему Яндекс.Деньги. Не платежный пароль, а именно пароль для входа!");AnyBalance.setDefaultCharset("UTF-8");var b=AnyBalance.requestGet("https://passport.yandex.ru",g_headers),b=loginYandex(e.login,e.password,b,baseurl+"index.xml","money");if(!/user__logout/i.test(b))throw new AnyBalance.Error("Не удалось зайти. Проверьте логин и пароль.");getParam(b,
d,"number",/Номер кошелька(?:[^>]*>){2}(\d{10,20})/i,replaceTagsAndSpaces);var a=getParam(b,d,"balance",/(?:price|sum)__amount[^>]*>([\s\S]*?)<\/span>\s*<\/span>/i,replaceTagsAndSpaces);AnyBalance.trace("Предположительно баланс где-то здесь: "+a);if(/\*{3}/.test(a)){AnyBalance.trace("Сумма спрятана. Будем пытаться найти...");var c=AnyBalance.requestGet(baseurl+"tunes.xml",g_headers),a=getParam(c,null,null,/name="sk"[^>]*value="([^"]+)/i,replaceTagsAndSpaces);if(!a)throw AnyBalance.trace(b),new AnyBalance.Error("Не удаётся найти ключ для получения баланса! Сайт изменен?");
c=AnyBalance.requestGet(baseurl+"ajax/sum-visibility?sk="+a+"&flag-hide-sum=false",addHeaders({Referer:baseurl,"X-Requested-With":"XMLHttpRequest"}));b=getJson(c);getParam(""+b.sum,d,"balance",null,null,parseBalance);AnyBalance.trace("Скрываем баланс обратно, чтобы стало, как было...");AnyBalance.requestGet(baseurl+"ajax/sum-visibility?sk="+a+"&flag-hide-sum=true",addHeaders({Referer:baseurl,"X-Requested-With":"XMLHttpRequest"}))}else getParam(a,d,"balance",null,replaceTagsAndSpaces,parseBalance)}
function processHistory(e){if(AnyBalance.isAvailable("transactions")){var d=0;e.transactions=[];for(var b=1;10>=b;b++){var a=AnyBalance.requestGet(baseurl+"ajax/history/partly?ncrnd=72010&history_shortcut=history_all&start-record="+d+"&record-count=100",addHeaders({"X-Requested-With":"XMLHttpRequest"})),d=d+100,a=getJson(a);AnyBalance.trace("Найдено транзакций: "+a.history.length);for(var c=0;c<a.history.length;++c){var f={};getParam((2==a.history[c].type?"-":"")+a.history[c].sum+"",f,"transactions.sum",
null,replaceTagsAndSpaces,parseBalance);getParam(a.history[c].name,f,"transactions.name",null,replaceTagsAndSpaces,html_entity_decode);getParam(a.history[c].date,f,"transactions.time",null,replaceTagsAndSpaces,parseDateISO);e.transactions.push(f)}if(!a.hasMore){AnyBalance.trace("Транзакций больше нет...");break}}}};
