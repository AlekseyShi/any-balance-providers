var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36"},baseurl="https://smponbank.ru/";
function login(){var c=AnyBalance.getPreferences();AnyBalance.setDefaultCharset("utf-8");checkEmpty(c.login,"Введите логин!");checkEmpty(c.password,"Введите пароль!");var b=AnyBalance.requestGet(baseurl,g_headers);if(!b||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(b),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");/logout/i.test(b)?AnyBalance.trace("Уже залогинены, используем существующую сессию"):b=AnyBalance.requestPost(baseurl+
"Authorize/LogOn",{Login:c.login,Password:c.password},addHeaders({Referer:baseurl+"Authorize/LogOn"}));if(!/logout/i.test(b)){if(c=getParam(b,null,null,/<div[^>]+summary-errors[^>]*>([\s\S]*?)<\/div>/i,replaceTagsAndSpaces))throw new AnyBalance.Error(c,null,/Вы указали неверное имя пользователя или пароль/i.test(c));AnyBalance.trace(b);throw new AnyBalance.Error("Не удалось зайти в интернет-банк. Сайт изменен?");}b=AnyBalance.requestPost(baseurl+"Update/RunCustomerUpdate",addHeaders({Accept:"application/json, text/javascript, */*; q=0.01",
"X-Requested-With":"XMLHttpRequest"}));try{AnyBalance.trace("Обновляем данные...");if(!getJson(b).isSuccessful)throw new AnyBalance.Error(b);AnyBalance.trace("Обновление данных произведено успешно!")}catch(a){AnyBalance.trace("Обновление данных не удалось: "+a.message)}__setLoginSuccessful();return b}
function processAccounts(c,b){if(AnyBalance.isAvailable("accounts")){c=AnyBalance.requestGet(baseurl+"Ib/ViewAccounts",g_headers);var a=getElements(c,/<td[^>]+(?:blckListAccountsCurrent|blckListAccountSmpTrader|blckListAccountCard)[^>]*>/ig);if(a.length){for(var d=[],e=0;e<a.length;e++){var f=getElements(a[e],/<tr[^>]*>/ig);0==e&&f.splice(2,1);d=d.concat(f)}if(d.length)for(AnyBalance.trace("Найдено счетов: "+d.length),b.accounts=[],e=0;e<d.length;++e){var a=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,
replaceTagsAndSpaces),f=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,replaceTagsAndSpaces),g=getParam(d[e],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<br/i,replaceTagsAndSpaces),a={__id:a,__name:g,num:f};__shouldProcess("accounts",a)&&processAccount(d[e],a);b.accounts.push(a)}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти счета.")}else AnyBalance.trace(c),AnyBalance.trace("Не удалось найти таблицы со счетами.")}}
function processAccount(c,b){AnyBalance.trace("Обработка счета "+b.__name);getParam(c,b,"accounts.balance",/<td[^>]+td-last nowrap(?:[^>]*>){2}([\s\S]*?)<span/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,["accounts.currency","accounts.balance"],/<td[^>]+td-last nowrap(?:[^>]*>){2}([\s\S]*?)<span/i,replaceTagsAndSpaces,parseCurrency);var a=getParam(c,null,null,/<a[^>]+class="details"[^>]+href="\/([^"]*)/i);a?(a=AnyBalance.requestGet(baseurl+a,g_headers),getParam(a,b,"accounts.type",/Тип счёта(?:[^>]*>){2}([^<]*)/i,
replaceTagsAndSpaces),getParam(a,b,"accounts.date_start",/Дата открытия(?:[^>]*>){3}([^<]*)/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"accounts.status",/Статус счёта(?:[^>]*>){2}([^<]*)/i,replaceTagsAndSpaces),AnyBalance.isAvailable("accounts.transactions")&&processAccountTransactions(a,b)):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти ссылку на подробную информацию о счёте."))}
function processCards(c,b){if(AnyBalance.isAvailable("cards")){c=AnyBalance.requestGet(baseurl+"Ib/ViewAccounts",g_headers);var a=getElement(c,/<div[^>]+id="blckListCard"[^>]*>/i),d=getElements(a,/<tr[^>]*>/ig);if(d.length)for(AnyBalance.trace("Найдено карт: "+d.length),b.cards=[],a=0;a<d.length;++a){var e=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),f=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),
g=getParam(d[a],null,null,/(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)(?:<\/td>|<br)/i,replaceTagsAndSpaces),e={__id:e,__name:g,num:f};__shouldProcess("cards",e)&&processCard(d[a],e);b.cards.push(e)}else/У вас нет карт/i.test(a)?(AnyBalance.trace("У вас нет карт"),b.cards=[]):(AnyBalance.trace(c),AnyBalance.trace("Не удалось найти карты."))}}
function processCard(c,b){AnyBalance.trace("Обработка карты "+b.__name);getParam(c,b,"cards.balance",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance);getParam(c,b,["cards.currency","cards.balance"],/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseCurrency);getParam(c,b,"cards.accnum",/(?:[\s\S]*?<td[^>]*>){3}([\s\S]*?)(?:<br|<\/td>)/i,replaceTagsAndSpaces);getParam(c,b,"cards.till",/(?:[\s\S]*?<td[^>]*>){4}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,
parseDate);var a=getParam(c,null,null,/Ib\/GetCardDetail\?cardId=(\d+)/i);a?(a=AnyBalance.requestGet(baseurl+"Ib/GetCardDetail?cardId="+a,g_headers),getParam(a,b,"cards.bonus",/<i[^>]*>СМП Трансаэро Бонус(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.minpay",/Сумма минимального платежа(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.minpay_till",/Минимальный платёж необходимо внести до(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,
replaceTagsAndSpaces,parseDate),getParam(a,b,"cards.blocked",/Зарезервированные суммы по расходным операциям(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseBalance),getParam(a,b,"cards.till",/Срок действия(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces,parseDate),getParam(a,b,"cards.type",/Тип карты(?:[\s\S]*?<td[^>]*>){1}([\s\S]*?)<\/td>/i,replaceTagsAndSpaces)):AnyBalance.trace("Не удалось найти ссылку на дополнительную информацию по карте. Сайт изменен?")}
function processDeposits(c,b){throw new AnyBalance.Error("Обработка депозитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}function processCredits(c,b){throw new AnyBalance.Error("Обработка кредитов пока не поддерживается. Пожалуйста, обратитесь к разработчикам.");}
function processInfo(c,b){c=AnyBalance.requestGet(baseurl+"Authorize/Profile",g_headers);var a=b.info={};getParam(c,a,"info.fio",/<span[^>]+user-name[^>]*>([\s\S]*?)<\/span>/i,replaceTagsAndSpaces);getParam(c,a,"info.mphone",/<input[^>]+primarytxtPhoneView[^>]+value="([^"]*)/i,replaceHtmlEntities);getParam(c,a,"info.email",/<input[^>]+txtemail[^>]+value="([^"]*)/i,replaceHtmlEntities)};
