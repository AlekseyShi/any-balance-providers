var g_headers={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Charset":"windows-1251,utf-8;q=0.7,*;q=0.3","Accept-Language":"ru-RU,ru;q=0.8,en-US;q=0.6,en;q=0.4",Connection:"keep-alive",Origin:"https://online.akbars.ru","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.73 Safari/537.36","X-Requested-With":"XMLHttpRequest","Content-Type":"application/json"},baseurl="https://online.akbars.ru/wb/";
function login(b){AnyBalance.setDefaultCharset("utf-8");checkEmpty(b.login,"Введите логин!");checkEmpty(b.password,"Введите пароль!");var a=AnyBalance.requestGet(baseurl+"menu",g_headers);if(!a||400<AnyBalance.getLastStatusCode())throw AnyBalance.trace(a),new AnyBalance.Error("Ошибка при подключении к сайту интернет-банка! Попробуйте обновить данные позже.");a=AnyBalance.getLastUrl();/CARDS|ACCOUNTS/i.test(a)?(AnyBalance.trace("Уже залогинены, используем существующую сессию"),b=apiCall("GET:api/v2/session")):
b=apiCall("POST:api/v2/session",{login:b.login,password:b.password});__setLoginSuccessful();return b}
function apiCall(b,a){var c={ACCOUNT_BLOCKED:"Учетная запись заблокирована",INVALID_LOGIN_OR_PASSWORD:"Неправильный логин или пароль"},d=/^(.+?):(.+$)/i.exec(b);if(!d)throw new AnyBalance.Error("Неправильно сформирована команда для apiCall");var e=d[2],d="GET"==d[1]?AnyBalance.requestGet(baseurl+e,g_headers):AnyBalance.requestPost(baseurl+e,JSON.stringify(a),addHeaders({Referer:baseurl})),e=getJson(d);if(e._error){if(c=c[e._error.code])throw new AnyBalance.Error(c,null,/Неправильный логин или пароль/i.test(c));
AnyBalance.trace(d);throw new AnyBalance.Error("Неизвестная ошибка вызова API. Сайт изменен?");}return e}var dataJson;function getCardsAccountDataJson(b){if(!dataJson)var a=dataJson=apiCall("GET:api/v2/contracts?system=W4C&filter=addData.CLASSIFICATION_FACTOR:DEBIT");if(isset(b))for(var a=[],c=0;c<dataJson.length;c++){var d=dataJson[c];d.type==b&&"active"==d[d.type].status&&a.push(d)}return a}
function getAllBalances(b,a,c){for(var d="available cr_limit blocked interests minpay overdue overlimit total_due".split(" "),e=0;e<d.length;e++)getParam(jspath1(b,"balances."+d[e]+".value"),a,c+"."+d[e],null,null,parseBalance)}
function processAccounts(b,a){if(isAvailable("accounts")){var c=getCardsAccountDataJson("cardAccount");AnyBalance.trace("Найдено счетов: "+c.length);a.accounts=[];for(var d=0;d<c.length;++d){var e=c[d],f={__id:e.id,__name:e.number};__shouldProcess("accounts",f)&&processAccount(e,f);a.accounts.push(f)}}}
function processAccount(b,a){AnyBalance.trace("Обработка счета "+a.__name);getParam(jspath1(b,"currency"),a,["accounts.currency","accounts"]);getAllBalances(b,a,"accounts");isAvailable("accounts.transactions")&&processCardOrAccountTransactions(a)}
function processCards(b,a){if(isAvailable("cards")){var c=getCardsAccountDataJson("card");AnyBalance.trace("Найдено карт: "+c.length);a.cards=[];for(var d=0;d<c.length;++d){var e=c[d],f={__id:e.id,__name:e.number};__shouldProcess("cards",f)&&processCard(e,f);a.cards.push(f)}}}
function processCard(b,a,c){getParam(jspath1(b,"currency"),a,["cards.currency","cards"]);getAllBalances(b,a,"cards");getParam(jspath1(b,"addData.NICE_CARD_EXPIRE"),a,"cards.expire",null,null,parseDate);getParam(jspath1(b,"addData.CARDHOLDER_NAME"),a,"cards.cardHolder",null,replaceTagsAndSpaces);getParam(jspath1(b,"addData.PROD_NAME"),a,"cards.name");getParam(jspath1(b,"addData.CARD_ID"),a,"cards.id");isAvailable("cards.transactions")&&processCardOrAccountTransactions(a)}
function processInfo(b,a){var c=a.info={};getParam(jspath1(b,"user.displayName"),c,"profile.fio");getParam(jspath1(b,"user.login"),c,"profile.login");getParam(jspath1(b,"user.id"),c,"profile.id");getParam(jspath1(b,"user.w4cClientId"),c,"profile.w4cClientId");getParam(jspath1(b,"user.w4cClientId.phoneNumbers.displayValue"),c,"profile.phone")};
